<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>F5C</title>
  <meta name="theme-color" content="#10b981"/>
  <link id="mf" rel="manifest"/>

  <!-- Favicon inline -->
  <link rel="icon" href="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%2310b981'/%3E%3Ctext x='50%25' y='54%25' font-family='system-ui,Segoe UI,Roboto,sans-serif' font-size='64' text-anchor='middle' dominant-baseline='middle' font-weight='700' fill='%230b1220'%3EF5%3C/text%3E%3C/svg%3E"/>

  <!-- Tailwind + React + Babel -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Export/Share -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bp: 0px;
      --pitch-image: var(--pitch-image-mobile);
      --pitch-image-mobile: url('assets/cesped-vert.webp');
      --pitch-image-desktop: var(--pitch-image-mobile);
      --pitch-darken: 0.50;
      --parallax-speed: 0.35;
      --header-h: 122px;
    }
    html,body{background:#0b1220;color:#e2e8f0;margin:0;overflow-x:hidden}
    img,svg{max-width:100%;height:auto}

    /* Fondo */
    #bg-parallax{position:fixed;inset:0;z-index:0;
      background-image:linear-gradient(rgba(11,18,32,var(--pitch-darken)),rgba(11,18,32,var(--pitch-darken))),var(--pitch-image);
      background-repeat:repeat-y,repeat-y;background-size:100% auto,100% auto; background-position:center var(--bp),center var(--bp);
      will-change:background-position}
    @media (min-width:1024px){
      :root{--parallax-speed:0}
      #bg-parallax{background-repeat:no-repeat,no-repeat;background-size:cover,cover;background-position:center center,center center}
    }
    #root{position:relative;z-index:1}

    /* Header */
    .app-header{position:fixed;top:0;left:0;right:0;z-index:40;backdrop-filter:blur(10px);
      background:rgba(2,6,23,.92);border-bottom:1px solid rgba(30,41,59,.8)}
    .header-spacer{height:var(--header-h)}

    /* Tabs */
    .tab-btn{padding:.6rem .8rem;font-size:.95rem;border-radius:.9rem;border:1px solid rgba(51,65,85,.8);
      background:rgba(2,6,23,.6);color:#cbd5e1;transition:transform .18s,background .18s,color .18s,border-color .18s}
    .tab-btn.active{background:#0b1220;color:#fff;border-color:#4ade80;box-shadow:0 0 0 1px rgba(74,222,128,.25) inset;transform:translateY(-1px)}
    .tab-nav{position:relative}
    .tab-indicator{position:absolute;left:0;bottom:-2px;height:3px;width:50%;
      background:linear-gradient(90deg,#34d399,#22d3ee);border-radius:9999px;transition:transform .28s cubic-bezier(.22,.7,.12,1)}

    /* Carrusel tabs + swipe */
    .tabs-viewport{overflow:hidden}
    .tabs-track{display:flex;width:200%;transition:transform .32s cubic-bezier(.22,.7,.12,1);touch-action:pan-y}
    .tabs-page{width:100%;padding:12px}

    /* Cards */
    .card-rect{position:relative;border-radius:16px;padding:8px;overflow:hidden}
    .card-inner{position:relative;z-index:2}
    .rarity-bronze{background:linear-gradient(180deg,#d3a076,#7a5438)}
    .rarity-silver{background:linear-gradient(180deg,#e5e7eb,#9ca3af)}
    .rarity-gold{background:linear-gradient(180deg,#fde68a,#d97706)}
    .rarity-special{background:transparent}
    .rarity-special::before{content:"";position:absolute;inset:-2px;border-radius:18px;background:conic-gradient(from 0deg,#22d3ee,#a78bfa,#f472b6,#22d3ee);animation:spin 6s linear infinite;filter:saturate(1.2) brightness(1.05);z-index:1}
    .rarity-special::after{content:"";position:absolute;inset:2px;border-radius:14px;background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(30,41,59,.85));z-index:1}
    @keyframes spin{to{transform:rotate(1turn)}}

    /* Cancha */
    .board{position:relative;width:100%;max-width:900px;aspect-ratio:5/3;border-radius:16px;overflow:hidden}
    .board img.field{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .board .layer{position:absolute;inset:0}

    /* Plantel scroll (más alto) */
    .plantel-scroll{max-height:calc(100vh - var(--header-h) - 110px);overflow-y:auto;padding-right:4px}

    /* Botón instalar sticky */
    .install-pill{position:fixed;right:12px;bottom:12px;z-index:50}
  </style>
</head>
<body>
  <div id="bg-parallax" aria-hidden="true"></div>
  <div id="root"></div>

  <!-- Manifest dinámico -->
  <script>
    (async()=>{
      try{
        const base = location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const L=document.getElementById('mf');
        const mk=(n,c)=>{const a=document.createElement('canvas');a.width=a.height=n;const x=a.getContext('2d');
          x.fillStyle=c;x.fillRect(0,0,n,n);x.fillStyle='#0b1220';x.textAlign='center';x.textBaseline='middle';
          x.font=`${Math.floor(n*.42)}px sans-serif`;x.fillText('F5',n/2,n/2);return a.toDataURL('image/png')};
        const man={name:'F5C',short_name:'F5C',start_url:base,scope:base,display:'standalone',
          background_color:'#0f172a',theme_color:'#10b981',
          icons:[{src:`${base}icons/icon-192.png`,sizes:'192x192',type:'image/png'},
                 {src:`${base}icons/icon-512.png`,sizes:'512x512',type:'image/png'}]};
        try{
          const r1=await fetch(`${base}icons/icon-192.png`,{method:'HEAD'});
          const r2=await fetch(`${base}icons/icon-512.png`,{method:'HEAD'});
          if(!r1.ok||!r2.ok) throw 0;
        }catch{
          man.icons=[{src:mk(192,'#10b981'),sizes:'192x192',type:'image/png'},
                     {src:mk(512,'#10b981'),sizes:'512x512',type:'image/png'}];
        }
        const b=new Blob([JSON.stringify(man)],{type:'application/manifest+json'});
        L.href=URL.createObjectURL(b);
      }catch(e){console.log('[PWA]',e)}
    })();
  </script>

  <!-- Fondo responsive -->
  <script>
    (function(){
      try{
        const base=location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const m=base+'assets/cesped-vert.webp';
        const d=base+'assets/cesped-horiz.webp';
        document.documentElement.style.setProperty('--pitch-image-mobile',`url('${m}')`);
        function setDesk(v){document.documentElement.style.setProperty('--pitch-image-desktop',v);apply()}
        fetch(d,{method:'HEAD'}).then(r=>setDesk((r&&r.ok)?`url('${d}')`:'var(--pitch-image-mobile)')).catch(()=>setDesk('var(--pitch-image-mobile)'));
        function apply(){
          const isDesk=window.matchMedia('(min-width:1024px)').matches;
          const img=isDesk?'var(--pitch-image-desktop)':'var(--pitch-image-mobile)';
          document.documentElement.style.setProperty('--pitch-image',img)
        }
        window.addEventListener('resize',apply);apply();
      }catch(e){}
    })();
  </script>

  <!-- Parallax -->
  <script>
    (function(){
      let ticking=false;
      function sp(){const v=getComputedStyle(document.documentElement).getPropertyValue('--parallax-speed');const n=parseFloat(v);return isNaN(n)?0:n}
      function onScroll(){if(ticking)return; ticking=true; requestAnimationFrame(()=>{document.documentElement.style.setProperty('--bp',(-window.scrollY*sp())+'px'); ticking=false})}
      window.addEventListener('scroll',onScroll,{passive:true}); window.addEventListener('resize',onScroll); onScroll();
    })();
  </script>

  <!-- === APP === -->
  <script type="text/babel">
    const {useMemo,useState,useEffect,useRef} = React;

    /* ========= Constantes/Helpers ========= */
    const STAT=['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
    const SL={ATA:'Ataque',PAS:'Pase',REG:'Regate',VEL:'Velocidad',DEF:'Defensa',FIS:'Físico',ARQ:'Arco',EQP:'Equipo'};
    const Wt={ATA:.18,DEF:.16,PAS:.14,REG:.14,VEL:.14,FIS:.10,ARQ:.07,EQP:.07};
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const avg=a=>a.length?a.reduce((p,c)=>p+c,0)/a.length:0;
    const globalOf=p=>{let s=0,w=0;for(const k in Wt){s+=(p[k]||0)*Wt[k];w+=Wt[k]}return +(s/w).toFixed(2)};
    const J=(s,d)=>{try{return JSON.parse(s)}catch{return d}};
    const withG=a=>a.map(p=>({...p,_GLOBAL:globalOf(p)}));
    const rarityOf=p=>{const r=Math.round((p._GLOBAL||globalOf(p))*10);if(p.especial||r>=90)return 'special';if(r>=80)return 'gold';if(r>=70)return 'silver';return 'bronze'};

    const SUBS={ATA:['Posición','Definición','Potencia'], PAS:['Visión','Corto','Largo'], REG:['Agilidad','Control','Equilibrio'],
      VEL:['Aceleración','Punta','Arranque'], DEF:['Marcaje','Anticipación','Entradas'], FIS:['Resistencia','Fuerza','Salto'],
      ARQ:['Reflejos','Manos','Saque'], EQP:['Colaboración','Disciplina','Liderazgo']};

    const roleOfPos = (pos='')=>{
      const P=(pos||'').toUpperCase();
      if(P.includes('AR')) return 'Arquero';
      if(P.includes('DF')||P.includes('TI')||P.includes('CB')) return 'Defensa';
      if(P.includes('MC')||P.includes('MU')||P.includes('MD')||P.includes('MI')) return 'Medio';
      if(P.includes('LA')||P.includes('DC')||P.includes('DL')||P.includes('ST')) return 'Delantero';
      return 'Jugador';
    };

    // color/avatars sin CORS
    const colorOf = name=>{
      const colors=['#22c55e','#06b6d4','#a78bfa','#f59e0b','#ef4444','#14b8a6','#8b5cf6','#f97316','#10b981','#38bdf8'];
      let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0;
      return colors[h%colors.length];
    };
    const mkAvatar = (name)=>{
      const initials=(name||'F5').split(/\s+/).map(s=>s[0]||'').join('').slice(0,2).toUpperCase();
      const bg=colorOf(name||'F5');
      const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' rx='24' ry='24' fill='${bg}'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,sans-serif' font-size='72' fill='white' style='font-style:italic;font-weight:800;letter-spacing:1px'>${initials}</text></svg>`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
    };

    /* ========= Seed sin CORS ========= */
    const SEED=[
      {id:'1',nombre:'Leo',equipoPropio:'La 10',equipoFavorito:'Barcelona',fotoUrl:mkAvatar('Leo'),ATA:10,PAS:9,REG:10,VEL:9,DEF:4,FIS:7,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5,especial:true,bandera:'🇦🇷',pos:'LA'},
      {id:'2',nombre:'Fabi',equipoPropio:'La 10',equipoFavorito:'Colón',fotoUrl:mkAvatar('Fabi'),ATA:7,PAS:8,REG:7,VEL:7,DEF:7,FIS:7,ARQ:4,EQP:9,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'MU'},
      {id:'3',nombre:'Cuti',equipoPropio:'Muralla',equipoFavorito:'Belgrano',fotoUrl:mkAvatar('Cuti'),ATA:5,PAS:6,REG:5,VEL:7,DEF:10,FIS:9,ARQ:4,EQP:7,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'TI'},
      {id:'4',nombre:'Dibu',equipoPropio:'Muralla',equipoFavorito:'Arsenal',fotoUrl:mkAvatar('Dibu'),ATA:3,PAS:5,REG:4,VEL:5,DEF:8,FIS:8,ARQ:10,EQP:7,pie:'Derecho',estrellas:5,bandera:'🇦🇷',pos:'AR'},
      {id:'5',nombre:'Papu',equipoPropio:'Tiki',equipoFavorito:'San Lorenzo',fotoUrl:mkAvatar('Papu'),ATA:8,PAS:8,REG:9,VEL:8,DEF:5,FIS:6,ARQ:3,EQP:7,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'LA'},
      {id:'6',nombre:'Nico',equipoPropio:'Tiki',equipoFavorito:'Boca',fotoUrl:mkAvatar('Nico'),ATA:7,PAS:7,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'LA'},
      {id:'7',nombre:'Chino',equipoPropio:'Muralla',equipoFavorito:"Newell's",fotoUrl:mkAvatar('Chino'),ATA:5,PAS:6,REG:5,VEL:6,DEF:8,FIS:7,ARQ:8,EQP:6,pie:'Izquierdo',estrellas:3,bandera:'🇦🇷',pos:'AR'},
      {id:'8',nombre:'Joa',equipoPropio:'La 10',equipoFavorito:'River',fotoUrl:mkAvatar('Joa'),ATA:6,PAS:6,REG:6,VEL:7,DEF:8,FIS:8,ARQ:5,EQP:7,pie:'Derecho',estrellas:3,bandera:'🇦🇷',pos:'TI'},
      {id:'9',nombre:'Fideo',equipoPropio:'Tiki',equipoFavorito:'Rosario C.',fotoUrl:mkAvatar('Fideo'),ATA:8,PAS:9,REG:9,VEL:8,DEF:6,FIS:6,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5,bandera:'🇦🇷',pos:'LA'},
      {id:'10',nombre:'Kuni',equipoPropio:'La 10',equipoFavorito:'Independiente',fotoUrl:mkAvatar('Kuni'),ATA:9,PAS:7,REG:8,VEL:9,DEF:5,FIS:7,ARQ:3,EQP:7,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'MU'},
      {id:'11',nombre:'Tomi',equipoPropio:'Muralla',equipoFavorito:'Talleres',fotoUrl:mkAvatar('Tomi'),ATA:6,PAS:7,REG:6,VEL:7,DEF:7,FIS:7,ARQ:5,EQP:6,pie:'Derecho',estrellas:3,bandera:'🇦🇷',pos:'LA'},
      {id:'12',nombre:'Gonza',equipoPropio:'Tiki',equipoFavorito:'Racing',fotoUrl:mkAvatar('Gonza'),ATA:7,PAS:6,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:3,bandera:'🇦🇷',pos:'TI'},
    ];

    /* ========= Química / Emparejado ========= */
    const chemBuildBase=arr=>{const q={};for(const a of arr){q[a.id]={};for(const b of arr){
      if(a.id===b.id){q[a.id][b.id]=10;continue}
      if(q[b.id]?.[a.id]!=null){q[a.id][b.id]=q[b.id][a.id];continue}
      let v=5;if(a.equipoPropio&&b.equipoPropio&&a.equipoPropio===b.equipoPropio)v+=1.2;
      if(a.equipoFavorito&&b.equipoFavorito&&a.equipoFavorito===b.equipoFavorito)v+=.8;
      v+=(((a.EQP+b.EQP)/2)-5)*.15;q[a.id][b.id]=clamp(+v.toFixed(2),1,10)}}return q};
    const applyOverrides=(base,ov)=>{if(!ov)return base;const q=JSON.parse(JSON.stringify(base));for(const a in ov){for(const b in ov[a]){const v=clamp(+ov[a][b],1,10);if(!q[a])q[a]={};if(!q[b])q[b]={};q[a][b]=q[b][a]=v}}return q};
    const chemTeam=(ids,chem)=>{const arr=Array.isArray(ids)?ids.filter(Boolean):[];if(arr.length<=1)return 10;let t=0,p=0;for(let i=0;i<arr.length;i++)for(let j=i+1;j<arr.length;j++){t+=chem[arr[i]]?.[arr[j]]??5;p++}return +(t/(p||1)).toFixed(2)};
    const teamGlobal=(ids,map)=>{const arr=Array.isArray(ids)?ids.filter(id=>map[id]):[];return +avg(arr.map(id=>map[id]._GLOBAL)).toFixed(2)};
    const teamScoreUI=(ids,map,chem,k)=>+(teamGlobal(ids,map,chem)+chemTeam(ids,chem)*k).toFixed(2);
    const shuffle=a=>{const x=[...a];for(let i=x.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[x[i],x[j]]=[x[j],x[i]]}return x};
    const seedWithPins=(ids,pA,pB)=>{const A=ids.filter(id=>pA.has(id));const B=ids.filter(id=>pB.has(id));const rest=ids.filter(id=>!pA.has(id)&&!pB.has(id));return{A,B,rest}};
    const fillRandom=(A,B,rest)=>{const r=shuffle(rest);for(const id of r){(A.length<B.length?A:B).push(id);if(A.length===5&&B.length===5)break}};
    const scoreDiff=(A,B,map,chem,k)=>{const sA=teamScoreUI(A,map,chem,k),sB=teamScoreUI(B,map,chem,k);return{A:[...A],B:[...B],diff:Math.abs(sA-sB),m:{sA,sB}}};
    const balancedWithPins=(ids,map,chem,k,pA,pB)=>{const{A,B,rest}=seedWithPins(ids,pA,pB);fillRandom(A,B,rest);
      while((A.length<5||B.length<5)&&rest.length>0){const id=rest.pop();(A.length<B.length?A:B).push(id)}
      let best=scoreDiff(A,B,map,chem,k);
      const freeA=best.A.map((id,i)=>pA.has(id)?-1:i).filter(i=>i>=0);
      const freeB=best.B.map((id,i)=>pB.has(id)?-1:i).filter(i=>i>=0);
      for(let t=0;t<900;t++){if(!freeA.length||!freeB.length)break;const i=freeA[(Math.random()*freeA.length)|0];const j=freeB[(Math.random()*freeB.length)|0];
        [best.A[i],best.B[j]]=[best.B[j],best.A[i]];const cur=scoreDiff(best.A,best.B,map,chem,k);if(cur.diff<=best.diff||Math.random()<.12)best=cur;else[best.A[i],best.B[j]]=[best.B[j],best.A[i]]}
      return{A:best.A,B:best.B,m:best.m}};

    /* ========= UI helpers ========= */
    const Pill=({children,className=''})=> <span className={`inline-block rounded-full px-2 py-0.5 text-xs ${className}`}>{children}</span>;
    const Stars=({n=0})=>{const s=clamp(Math.round(n),0,5);return(<div className="flex gap-1 text-amber-300" title={`${s} estrellas`}>{Array.from({length:5}).map((_,i)=>(<span key={i}>{i<s?'★':'☆'}</span>))}</div>)};

    const FifaCard=({p,small=false})=>{
      const rate=Math.round((p._GLOBAL||globalOf(p))*10);
      const rare=rarityOf(p);
      const sizeClass= small ? 'w-36' : 'w-44';
      const ring = rare==='bronze'?'ring-yellow-800':rare==='silver'?'ring-slate-300':rare==='gold'?'ring-yellow-500':'ring-cyan-300';
      const rareClass = rare==='special' ? 'rarity-special' : `rarity-${rare}`;
      return (
        <div className={`card-rect ${sizeClass} ${rareClass} text-slate-900 ring-1 ${ring} shadow`}>
          <div className="card-inner">
            <div className="flex justify-between items-start">
              <div className="text-center leading-4">
                <div className="text-3xl font-black">{rate}</div>
                <div className="text-xs font-bold">{p.pos||'F5'}</div>
                <div className="text-base">{p.bandera||''}</div>
              </div>
              <div className="text-[10px] font-bold bg-white/70 rounded px-1 py-0.5 ring-1 ring-black/10">{roleOfPos(p.pos)}</div>
            </div>
            <div className="mt-2 grid place-items-center">
              <img src={p.fotoUrl} className={`rounded-xl object-cover ring-2 ${ring} ${small?'h-20 w-20':'h-24 w-24'}`} alt={p.nombre}/>
            </div>
            <div className="mt-2 text-center text-sm font-extrabold">{p.nombre}</div>
            {/* solo stats compactas (sin pills extras) */}
            <div className="mt-1 grid grid-cols-2 gap-x-2 gap-y-1 text-[11px] font-semibold">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded-lg bg-white/30 px-2 py-1">
                  <span>{k}</span><span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    /* ============ Radar simple (SVG) ============ */
    const RadarChart=({size=260,max=10,keys=STAT,dataSeries})=>{
      const cx=size/2,cy=size/2,r=size*.4,N=keys.length;
      const ang=i=>Math.PI*2*i/N-Math.PI/2;
      const pt=(i,v)=>{const a=ang(i),rr=r*(v/max);return[cx+rr*Math.cos(a),cy+rr*Math.sin(a)]};
      const lv=[2,4,6,8,10];
      return(<svg viewBox={`0 0 ${size} ${size}`} width="100%" className="mx-auto block">
        {lv.map((L,i)=>{const d=keys.map((_,j)=>pt(j,L)).map(([x,y])=>`${x},${y}`).join(' ');return <polygon key={i} points={d} fill="none" stroke="rgba(148,163,184,.25)" strokeWidth={1}/>})}
        {keys.map((k,i)=>{const[x,y]=pt(i,max);return <line key={k} x1={cx} y1={cy} x2={x} y2={y} stroke="rgba(148,163,184,.3)" strokeWidth={1}/>})}
        {keys.map((k,i)=>{const[x,y]=pt(i,max+.9);return <text key={k} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize={11} fill="#cbd5e1">{k}</text>})}
        {dataSeries.map((srs,i)=>{const d=keys.map((k,j)=>pt(j,srs.values[k]??0)).map(([x,y])=>`${x},${y}`).join(' ');return(<g key={i}><polygon points={d} fill={srs.fill} stroke={srs.stroke} strokeWidth={2}/></g>)})}
      </svg>);
    };
    const TC={A:{stroke:'rgba(16,185,129,1)',fill:'rgba(16,185,129,0.18)',dot:'bg-emerald-500',hex:'#10b981'},B:{stroke:'rgba(59,130,246,1)',fill:'rgba(59,130,246,0.18)',dot:'bg-blue-500',hex:'#3b82f6'}};
    const teamAvg=(ids,map)=>{const o={};const arr=Array.isArray(ids)?ids.filter(id=>map[id]):[];STAT.forEach(k=>o[k]=+avg(arr.map(id=>map[id][k]??0)).toFixed(2));return o};

    const TeamRadarCompare=({A,B,map})=>{
      const a=teamAvg(A,map),b=teamAvg(B,map);
      return(
        <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <div className="mb-2 text-center text-sm text-slate-300">Radar comparativo (promedio por stat)</div>
          <RadarChart dataSeries={[{label:'A',values:a,stroke:TC.A.stroke,fill:TC.A.fill},{label:'B',values:b,stroke:TC.B.stroke,fill:TC.B.fill}]}/>
          <div className="mt-2 flex justify-center gap-4 text-xs text-slate-300">
            <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TC.A.dot}`}></span> A</span>
            <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TC.B.dot}`}></span> B</span>
          </div>
        </div>
      )
    };

    /* ===== Semáforo ===== */
    const BalanceIndicator=({A,B,map,chem,kChem})=>{
      const a=(Array.isArray(A)?A:[]).filter(id=>map[id]);
      const b=(Array.isArray(B)?B:[]).filter(id=>map[id]);
      const sA=teamScoreUI(a,map,chem,kChem),sB=teamScoreUI(b,map,chem,kChem),d=+Math.abs(sA-sB).toFixed(2);
      let lb='Parejo',cls='bg-emerald-600/15 text-emerald-200 ring-emerald-500/30';
      if(d>=.8){lb='Desbalanceado';cls='bg-rose-600/15 text-rose-200 ring-rose-500/30'}
      else if(d>=.3){lb='Aceptable';cls='bg-amber-600/15 text-amber-100 ring-amber-500/30'}
      return(
        <div className={`rounded-2xl p-3 ring-1 ${cls}`}>
          <div className="flex items-center justify-between text-sm"><div className="font-semibold">Balance del partido</div><div className="text-xs opacity-80">Diff: {d}</div></div>
          <div className="mt-1 text-sm">Resultado: <span className="font-semibold">{lb}</span> <span className="opacity-80">(A: {sA} vs B: {sB})</span></div>
          <div className="mt-1 text-xs opacity-80">Umbrales: Parejo &lt; 0.30 — Aceptable &lt; 0.80 — Desbalanceado ≥ 0.80</div>
        </div>
      )
    };

    /* ============ Formación (responsive + fotos) ============ */
    const MiniCard = ({p,dataFotos})=>{
      if(!p) return null;
      const rare=rarityOf(p);
      const ring = rare==='bronze'?'ring-yellow-800':rare==='silver'?'ring-slate-300':rare==='gold'?'ring-yellow-500':'ring-cyan-300';
      const rareClass = rare==='special' ? 'rarity-special' : `rarity-${rare}`;
      const foto = (dataFotos && dataFotos[p.id]) ?? p.fotoUrl ?? '';
      return (
        <div className={`card-rect ${rareClass} text-slate-900 ring-1 ${ring} shadow w-[104px]`}>
          <div className="card-inner">
            <div className="flex justify-between items-start">
              <div className="text-center leading-4">
                <div className="text-xl font-black">{Math.round((p._GLOBAL||globalOf(p))*10)}</div>
                <div className="text-[10px] font-bold">{p.pos||'F5'}</div>
              </div>
              <div className="h-6 w-6 grid place-items-center bg-white/70 text-[10px] font-extrabold ring-1 ring-black/10 rounded">
                {(p.equipoPropio||'').slice(0,2).toUpperCase()}
              </div>
            </div>
            <div className="mt-1 grid place-items-center">
              {foto ? <img src={foto} className="h-16 w-16 rounded-lg object-cover ring-2"/> : <div className="h-16 w-16 rounded-lg bg-slate-300 ring-2"/>}
            </div>
            <div className="mt-1 text-center text-[11px] font-extrabold px-1 leading-tight">{p.nombre}</div>
            <div className="mt-1 grid grid-cols-2 gap-1 text-[9px] font-semibold px-1 pb-1">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded bg-white/30 px-1 py-[1px]">
                  <span>{k}</span><span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // posiciones relativas 2-2-1 (por lado); valores en %
    const POS_A = [
      {x: 12, y: 80}, // AR
      {x: 28, y: 62}, // DF izq
      {x: 28, y: 38}, // DF der
      {x: 50, y: 50}, // Medio
      {x: 70, y: 50}, // Punta
    ];
    const mirrorX = p => ({x: 100 - p.x, y: p.y});
    const POS_B = POS_A.map(mirrorX);

    const FormationBoard = ({teamA=[], teamB=[], map, kChem, chem, scale=0.50, onReadyImage}) => {
      const ref = useRef(null);
      const [dataFotos, setDataFotos] = useState({});

      // Preload fotos a dataURL para export (si CORS deja)
      useEffect(()=>{
        (async ()=>{
          const ids=[...teamA,...teamB];
          const out={};
          for(const id of ids){
            const p=map[id]; if(!p||!p.fotoUrl) continue;
            const url=p.fotoUrl;
            try{
              if(/^data:image\//.test(url)){out[id]=url; continue;}
              const r=await fetch(url,{mode:'cors'});
              const blob=await r.blob();
              out[id]=await new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.readAsDataURL(blob);});
            }catch{out[id]=null}
          }
          setDataFotos(out);
        })();
      },[teamA.join(','),teamB.join(','),map]);

      const makeCanvas = async ()=>{
        const el=ref.current; if(!el) return;
        const canvas=await html2canvas(el,{backgroundColor:null,useCORS:true,allowTaint:true,scale:2});
        const url=canvas.toDataURL('image/png');
        onReadyImage?.(url);
        return {canvas,url};
      };

      const descargar = async ()=>{
        const {url}=await makeCanvas(); const a=document.createElement('a');a.href=url;a.download='formacion_f5.png';a.click();
      };
      const copiar = async ()=>{
        try{
          const {canvas}=await makeCanvas(); canvas.toBlob(async b=>{
            if(!b) return; await navigator.clipboard.write([new ClipboardItem({'image/png': b})]);
            alert('Imagen copiada al portapapeles ✅');
          });
        }catch{alert('Tu navegador no permite copiar imágenes. Usá "Descargar".')}
      };
      const compartir = async ()=>{
        try{
          const {canvas}=await makeCanvas();
          const file = await new Promise(res=>canvas.toBlob(b=>res(new File([b],'formacion_f5.png',{type:'image/png'})),'image/png'));
          if(navigator.canShare && navigator.canShare({files:[file]})){
            await navigator.share({title:'Formación F5',files:[file],text:'Formación del partido'});
          }
        }catch(e){
          // si canceló el share en móvil, no forzar descarga
          if(e && (e.name==='AbortError' || e.message?.includes('Abort'))) return;
          // en otros errores podés descargar manual
          // descargar();
        }
      };

      // escala adaptativa en móvil/desktop
      const isDesk = ()=>window.matchMedia('(min-width:768px)').matches;
      const scaleLive = isDesk()? scale : Math.max(0.42, Math.min(scale, 0.56));

      return (
        <div className="w-full">
          <div ref={ref} className="board ring-1 ring-slate-700 shadow-xl mx-auto bg-slate-900/30 relative">
            <img src="assets/cancha.png" alt="Cancha" className="field"/>

            <div className="layer">
              <div className="absolute top-2 left-1/2 -translate-x-1/2 px-4 py-1.5 rounded-xl bg-slate-900/70 text-white text-sm sm:text-base font-bold flex items-center gap-2">
                <span className="text-lg">⚽</span> <span>Formación F5</span>
              </div>

              {/* team A */}
              {teamA.map((id,i)=>{
                const p=map[id]; const pos=POS_A[i]||POS_A[POS_A.length-1];
                return (
                  <div key={'A'+id} className="absolute"
                    style={{left: `${pos.x}%`, top: `${pos.y}%`, transform:`translate(-50%,-50%) scale(${scaleLive})`, transformOrigin:'top left'}}>
                    <MiniCard p={p} dataFotos={dataFotos}/>
                  </div>
                );
              })}
              {/* team B */}
              {teamB.map((id,i)=>{
                const p=map[id]; const pos=POS_B[i]||POS_B[POS_B.length-1];
                return (
                  <div key={'B'+id} className="absolute"
                    style={{left: `${pos.x}%`, top: `${pos.y}%`, transform:`translate(-50%,-50%) scale(${scaleLive})`, transformOrigin:'top left'}}>
                    <MiniCard p={p} dataFotos={dataFotos}/>
                  </div>
                );
              })}

              <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-[12px] text-slate-200">Generado con F5C</div>
            </div>
          </div>

          <div className="grid grid-cols-2 sm:flex sm:flex-row justify-center gap-2 mt-3">
            <button onClick={descargar} className="rounded-xl bg-emerald-600 px-3 py-2 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">⬇️ Descargar</button>
            <button onClick={copiar} className="rounded-xl bg-slate-800 px-3 py-2 text-sm ring-1 ring-slate-700 hover:bg-slate-700">📋 Copiar</button>
            <button onClick={compartir} className="rounded-xl bg-cyan-600 px-3 py-2 text-sm text-white ring-1 ring-cyan-500 hover:bg-cyan-500">📤 Compartir</button>
          </div>
        </div>
      );
    };

    /* ====== Listado / Detalles / Formularios ====== */
    const PinButtons=({id,pinA,pinB,setPinA,setPinB})=>{
      const onA=pinA.has(id), onB=pinB.has(id);
      const toggle=t=>{
        if(t==='A'){const nA=new Set(pinA),nB=new Set(pinB);onA?nA.delete(id):nA.add(id);nB.delete(id);setPinA(nA);setPinB(nB)}
        else       {const nA=new Set(pinA),nB=new Set(pinB);onB?nB.delete(id):nB.add(id);nA.delete(id);setPinA(nA);setPinB(nB)}
      };
      return(<div className="flex gap-1">
        <button title="Fijar en A" onClick={()=>toggle('A')} className={`h-7 w-7 rounded-lg text-xs font-bold ring-1 ${onA?'bg-emerald-600 text-white ring-emerald-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>A</button>
        <button title="Fijar en B" onClick={()=>toggle('B')} className={`h-7 w-7 rounded-lg text-xs font-bold ring-1 ${onB?'bg-blue-600 text-white ring-blue-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>B</button>
      </div>);
    };

    const BarsChart=({values,max=10,accent})=>{
      const c=accent||'#22d3ee';
      return(<div className="space-y-2">
        {STAT.map(k=>(
          <div key={k}>
            <div className="mb-1 flex items-center justify-between text-sm"><span className="text-slate-300" title={SL[k]}>{k}</span><span className="font-semibold">{values[k]}</span></div>
            <div className="h-2 w-full rounded bg-slate-700"><div className="h-2 rounded" style={{width:`${Math.max(0,Math.min(100,(values[k]/max)*100))}%`,backgroundColor:c}}/></div>
          </div>
        ))}
      </div>);
    };

    const PlayerRow=({p,selected,onToggle,onOpen,pinA,pinB,setPinA,setPinB,disableAdd})=>{
      const disabled=!selected && disableAdd;
      return(
        <div className="flex items-center gap-3 rounded-xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <img src={p.fotoUrl} alt={p.nombre} className="h-10 w-10 rounded-full object-cover ring-1 ring-slate-700"/>
          <div className="min-w-0 flex-1">
            <div className="flex items-center justify-between gap-2">
              <button onClick={onOpen} className="min-w-0 text-left">
                <div className="truncate text-base font-semibold">{p.nombre} {p.bandera||''}</div>
              </button>
              <div className="flex items-center gap-2">
                <PinButtons id={p.id} pinA={pinA} pinB={pinB} setPinA={setPinA} setPinB={setPinB}/>
                <button onClick={onToggle} disabled={disabled} className={`rounded-xl px-3 py-1 text-sm ring-1 ${selected?'bg-emerald-600 text-white ring-emerald-500':disabled?'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>{selected? '✓ Convocado' : '+ Convocar'}</button>
              </div>
            </div>
            <div className="mt-2 grid grid-cols-4 gap-1 text-[11px] text-slate-300">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1"><span className="font-medium" title={SL[k]}>{k}</span><span className="tabular-nums">{p[k]}</span></div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const Gauge=({label,v})=>(<div className="mb-1"><div className="flex justify-between text-xs"><span>{label}</span><span className="font-semibold">{v}</span></div><div className="h-1.5 rounded bg-slate-700"><div className="h-1.5 rounded" style={{width:`${v*10}%`,backgroundColor:'#22c55e'}}/></div></div>);

    const PlayerDetails=({p})=>{
      const s=p.subs||(Object.fromEntries(STAT.map(k=>[k, (SUBS[k]||[]).map(n=>({n,v:p[k]}))])));
      return(
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div className="flex justify-center"><FifaCard p={p}/></div>
          <div className="space-y-3">
            <div className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Ficha</div>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <div className="rounded-lg bg-slate-900/60 p-2">Rol:<div className="font-semibold">{roleOfPos(p.pos)}</div></div>
                <div className="rounded-lg bg-slate-900/60 p-2">Pie hábil:<div className="font-semibold">{p.pie||'-'}</div></div>
                <div className="rounded-lg bg-slate-900/60 p-2">Equipo propio:<div className="font-semibold">{p.equipoPropio||'-'}</div></div>
                <div className="rounded-lg bg-slate-900/60 p-2">Favorito:<div className="font-semibold">{p.equipoFavorito||'-'}</div></div>
              </div>
            </div>
            <div className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
              <div className="mb-2 text-sm font-semibold">Radar</div>
              <RadarChart size={240} dataSeries={[{label:p.nombre,values:p,stroke:'rgba(34,211,238,1)',fill:'rgba(34,211,238,0.18)'}]}/>
            </div>
            {STAT.map(k=>(
              <div key={k} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
                <div className="mb-1 text-sm font-semibold">{SL[k]} <span className="opacity-75">({p[k]})</span></div>
                {(s[k]||[]).map((it,idx)=>(<Gauge key={idx} label={it.n} v={it.v}/>))}
              </div>
            ))}
          </div>
        </div>
      );
    };

    /* ========= Glosario ========= */
    const GlossaryModal = ({onClose}) => (
      <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
        <div className="w-full max-w-3xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 text-sm"
             onClick={e=>e.stopPropagation()}>
          <div className="flex items-center justify-between">
            <div className="text-lg font-semibold">Glosario</div>
            <button onClick={onClose} className="rounded-lg bg-slate-800 px-2 py-1 ring-1 ring-slate-700">Cerrar</button>
          </div>

          <div className="space-y-4 leading-relaxed text-slate-200">
            <div>
              <div className="font-semibold text-emerald-300">Rating de jugador (1–100)</div>
              <div>Promedio ponderado de stats con pesos: ATA(.18), DEF(.16), PAS(.14), REG(.14), VEL(.14), FIS(.10), ARQ(.07), EQP(.07).</div>
              <div><code>Rating = Σ(stat × peso) / Σ(pesos)</code></div>
            </div>

            <div>
              <div className="font-semibold text-emerald-300">Stats (1–10) y substats</div>
              <ul className="list-disc pl-5 space-y-1">
                <li><b>ATA</b> (Ataque): Posición, Definición, Potencia</li>
                <li><b>PAS</b> (Pase): Visión, Pase corto, Pase largo</li>
                <li><b>REG</b> (Regate): Agilidad, Control, Equilibrio</li>
                <li><b>VEL</b> (Velocidad): Aceleración, Pico, Arranque</li>
                <li><b>DEF</b> (Defensa): Marcaje, Anticipación, Entradas</li>
                <li><b>FIS</b> (Físico): Resistencia, Fuerza, Salto</li>
                <li><b>ARQ</b> (Arco): Reflejos, Manos, Saque</li>
                <li><b>EQP</b> (Equipo): Colaboración, Disciplina, Liderazgo</li>
              </ul>
              <div className="mt-1 text-slate-300">Cada stat es el promedio de sus substats (redondeo al entero dentro de 1–10).</div>
            </div>

            <div>
              <div className="font-semibold text-emerald-300">Química de equipo (1–10)</div>
              <div>Promedio de afinidad por parejas. Sube si comparten equipo propio/favorito y por el valor EQP promedio.</div>
            </div>

            <div>
              <div className="font-semibold text-emerald-300">Rating de equipo (1–100)</div>
              <div>Promedio de los Ratings individuales de los 5 jugadores.</div>
            </div>

            <div>
              <div className="font-semibold text-emerald-300">Score</div>
              <div>Combina Rating y Química con un peso <b>k</b> (configurable):</div>
              <div><code>Score = Rating de equipo + (Química de equipo × k)</code></div>
            </div>
          </div>
        </div>
      </div>
    );

    /* ========= Ajustes ========= */
    const SettingsModal=({
      onClose,kChem,setKChem,onExport,onImport,onReset,parallaxOn,setParallaxOn,formScale,setFormScale,
      listTwoCols,setListTwoCols,onOpenGlossary
    })=>{
      const input=useRef(null);
      return(
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
          <div className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
            <div className="mb-1 text-lg font-semibold">Ajustes</div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Peso de Química en Score</div>
              <input type="range" min="0" max="1" step="0.05" value={kChem} onChange={e=>setKChem(+e.target.value)} className="w-full"/>
              <div className="text-xs text-slate-300 mt-1">k = {kChem.toFixed(2)}</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Tamaño tarjetas en Formación</div>
              <input type="range" min="0.38" max="0.80" step="0.01" value={formScale} onChange={e=>setFormScale(+e.target.value)} className="w-full"/>
              <div className="text-xs text-slate-300 mt-1">escala = {formScale.toFixed(2)}</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Vista de Listado</div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={listTwoCols} onChange={e=>setListTwoCols(e.target.checked)}/>
                <span>{listTwoCols? '2 columnas (compacto)': '1 columna (detallado)'}</span>
              </label>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Parallax de fondo</div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={parallaxOn} onChange={e=>setParallaxOn(e.target.checked)}/>
                <span>{parallaxOn?'Activado':'Desactivado'}</span>
              </label>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-2">
              <div className="text-sm font-semibold">Importar / Exportar</div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onExport} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Exportar JSON</button>
                <button onClick={()=>input.current?.click()} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Importar JSON</button>
                <input ref={input} type="file" accept="application/json" className="hidden" onChange={onImport}/>
                <button onClick={onReset} className="ml-auto rounded-xl bg-rose-700 px-3 py-1 text-sm text-white ring-1 ring-rose-500 hover:bg-rose-600">Restablecer seed</button>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <button onClick={onOpenGlossary} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">📘 Ver glosario</button>
              <button onClick={onClose} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
            </div>
          </div>
        </div>
      );
    };

    /* ========= APP ========= */
    const App=()=>{
      const storeP=J(localStorage.getItem('f5.players'),null);
      const initP=withG(Array.isArray(storeP)&&storeP.length?storeP:SEED);
      const[players,setPlayers]=useState(initP);
      const[selected,setSelected]=useState(()=>new Set(J(localStorage.getItem('f5.selected'),[])));
      const[teams,setTeams]=useState(()=>J(localStorage.getItem('f5.teams'),null));
      const[kChem,setKChem]=useState(()=>+(localStorage.getItem('f5.kchem')??0.6));
      const[pinA,setPinA]=useState(()=>new Set(J(localStorage.getItem('f5.pins.A'),[])));
      const[pinB,setPinB]=useState(()=>new Set(J(localStorage.getItem('f5.pins.B'),[])));
      const[chemOverrides,setChemOverrides]=useState(()=>J(localStorage.getItem('f5.chem.overrides'),{}));
      const[history,setHistory]=useState(()=>{const h=J(localStorage.getItem('f5.history'),[]);return Array.isArray(h)?h:[]});
      const[parallaxOn,setParallaxOn]=useState(()=>{const s=localStorage.getItem('f5.parallax');if(s!=null)try{return JSON.parse(s)}catch{}return !window.matchMedia('(min-width:1024px)').matches});
      const[formScale,setFormScale]=useState(()=>+(localStorage.getItem('f5.formScale')??0.50));
      const[listTwoCols,setListTwoCols]=useState(()=>{try{return JSON.parse(localStorage.getItem('f5.listTwoCols')??'true')}catch{return true}});
      const[tab,setTab]=useState('partido');
      const[modal,setModal]=useState(null);
      const[form,setForm]=useState(null);
      const[settings,setSettings]=useState(false);
      const[q,setQ]=useState('');
      const[sort,setSort]=useState('global-desc');
      const[showGlossary,setShowGlossary]=useState(false);
      const[playerDetailId,setPlayerDetailId]=useState(null);

      // install prompt
      const [deferredPrompt,setDeferredPrompt]=useState(null);
      useEffect(()=>{
        const onPrompt=(e)=>{e.preventDefault();setDeferredPrompt(e)};
        window.addEventListener('beforeinstallprompt',onPrompt);
        return ()=>window.removeEventListener('beforeinstallprompt',onPrompt);
      },[]);

      const map=useMemo(()=>Object.fromEntries(players.map(p=>[p.id,p])),[players]);
      const chem=useMemo(()=>applyOverrides(chemBuildBase(players),chemOverrides),[players,chemOverrides]);

      useEffect(()=>localStorage.setItem('f5.players',JSON.stringify(players)),[players]);
      useEffect(()=>localStorage.setItem('f5.selected',JSON.stringify([...selected])),[selected]);
      useEffect(()=>localStorage.setItem('f5.teams',JSON.stringify(teams)),[teams]);
      useEffect(()=>localStorage.setItem('f5.kchem',String(kChem)),[kChem]);
      useEffect(()=>localStorage.setItem('f5.pins.A',JSON.stringify([...pinA])),[pinA]);
      useEffect(()=>localStorage.setItem('f5.pins.B',JSON.stringify([...pinB])),[pinB]);
      useEffect(()=>localStorage.setItem('f5.chem.overrides',JSON.stringify(chemOverrides)),[chemOverrides]);
      useEffect(()=>localStorage.setItem('f5.history',JSON.stringify(history)),[history]);
      useEffect(()=>localStorage.setItem('f5.parallax',JSON.stringify(parallaxOn)),[parallaxOn]);
      useEffect(()=>localStorage.setItem('f5.formScale',String(formScale)),[formScale]);
      useEffect(()=>localStorage.setItem('f5.listTwoCols',JSON.stringify(listTwoCols)),[listTwoCols]);

      useEffect(()=>{const el=document.querySelector('.app-header');const setH=()=>{ if(el){ document.documentElement.style.setProperty('--header-h', el.offsetHeight+'px'); } };setH();window.addEventListener('resize',setH);return()=>window.removeEventListener('resize',setH)},[]);
      useEffect(()=>{const isDesk=window.matchMedia('(min-width:1024px)').matches;const speed = parallaxOn ? (isDesk ? 0 : 0.35) : 0;document.documentElement.style.setProperty('--parallax-speed', String(speed));},[parallaxOn]);

      // swipe tabs
      const viewportRef=useRef(null);
      useEffect(()=>{
        const vp=viewportRef.current; if(!vp) return;
        let sx=0,dx=0,active=false;
        const ts=(e)=>{active=true; sx=e.touches[0].clientX; dx=0};
        const tm=(e)=>{if(!active)return; dx=e.touches[0].clientX-sx};
        const te=()=>{if(!active)return; if(dx>60) setTab('partido'); else if(dx<-60) setTab('plantel'); active=false};
        vp.addEventListener('touchstart',ts,{passive:true});
        vp.addEventListener('touchmove',tm,{passive:true});
        vp.addEventListener('touchend',te,{passive:true});
        return ()=>{vp.removeEventListener('touchstart',ts);vp.removeEventListener('touchmove',tm);vp.removeEventListener('touchend',te);}
      },[]);

      const convocados=[...selected];
      const canMake=convocados.length===10;
      const reachedMax=convocados.length>=10;
      const invalidPins=pinA.size>5||pinB.size>5;

      const toggle=id=>setSelected(s=>{const n=new Set(s);if(n.has(id))n.delete(id);else{if(reachedMax)return n;n.add(id)}return n});
      const makeR=()=>{if(!canMake||invalidPins)return;const ids=[...convocados];ids.sort(()=>Math.random()-.5);setTeams({A:ids.slice(0,5),B:ids.slice(5)})};
      const makeB=()=>{if(!canMake||invalidPins)return;const{A,B}=balancedWithPins(convocados,map,chem,kChem,pinA,pinB);setTeams({A,B})};

      const onSave=data=>{
        if(form&&form.id){ setPlayers(p=>withG(p.map(x=>x.id===form.id?{...x,...data}:x))) }
        else{ const id=String(Date.now()); setPlayers(p=>withG([...p,{id,...data}])) }
        setForm(null);
      };
      const onDel=id=>{
        setPlayers(p=>p.filter(x=>x.id!==id));
        setSelected(s=>{const n=new Set(s);n.delete(id);return n});
        setTeams(t=>t?{A:t.A.filter(x=>x!==id),B:t.B.filter(x=>x!==id)}:t);
        setPinA(a=>{const n=new Set(a);n.delete(id);return n});
        setPinB(b=>{const n=new Set(b);n.delete(id);return n});
      };

      const onExport=()=>{const payload={players,selected:[...selected],teams,kChem,pinA:[...pinA],pinB:[...pinB],chemOverrides,history};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='futbol5_estado.json';a.click();URL.revokeObjectURL(url)};
      const onImport=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{
          const d=JSON.parse(r.result);
          if(Array.isArray(d.players))setPlayers(withG(d.players));
          if(Array.isArray(d.selected))setSelected(new Set(d.selected));
          if(d.teams?.A&&d.teams?.B)setTeams(d.teams);
          if(typeof d.kChem==='number')setKChem(d.kChem);
          if(Array.isArray(d.pinA))setPinA(new Set(d.pinA));
          if(Array.isArray(d.pinB))setPinB(new Set(d.pinB));
          if(d.chemOverrides&&typeof d.chemOverrides==='object')setChemOverrides(d.chemOverrides);
          if(Array.isArray(d.history))setHistory(d.history);
        }catch{alert('JSON inválido')}};r.readAsText(f)};

      const reset=()=>{setPlayers(withG(SEED));setSelected(new Set());setTeams(null);setKChem(0.6);setPinA(new Set());setPinB(new Set());setChemOverrides({});setHistory([])};

      const filtered=[...players].filter(p=>{
        const t=q.trim().toLowerCase();if(!t)return true;
        return(p.nombre||'').toLowerCase().includes(t)||(p.equipoPropio||'').toLowerCase().includes(t)||(p.equipoFavorito||'').toLowerCase().includes(t)
      });
      filtered.sort((a,b)=>{switch(sort){case'global-asc':return a._GLOBAL-b._GLOBAL;case'nombre':return a.nombre.localeCompare(b.nombre);default:return b._GLOBAL-a._GLOBAL;}});

      const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;
      const doInstall=async ()=>{
        if(!deferredPrompt){alert('Si tu navegador lo permite, vuelve a abrir la app para ver el botón de instalar.');return;}
        deferredPrompt.prompt();
        const {outcome}=await deferredPrompt_userChoice(deferredPrompt);
        if(outcome!=='accepted'){ /* usuario canceló, no hacemos nada */ }
      };
      const deferredPrompt_userChoice=(p)=>new Promise(res=>{
        const i=setInterval(()=>{
          if(p.userChoice){clearInterval(i);p.userChoice.then(res);} },50);
      });

      const teamAvgValues=(ids)=>{const o={};STAT.forEach(k=>o[k]=+avg(ids.map(id=>map[id][k]??0)).toFixed(2));return o};

      // Drag & Drop simple entre listas A/B
      const [dragInfo,setDragInfo]=useState(null); // {team:'A'|'B', id}
      const onDragStart=(team,id)=>e=>{
        e.dataTransfer.setData('text/plain', id);
        setDragInfo({team,id});
      };
      const onDragOver=e=>{ e.preventDefault(); };
      const onDrop=targetTeam=>e=>{
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        if(!id || !teams) return;
        const from=dragInfo?.team;
        if(!from || from===targetTeam) return;
        setTeams(t=>{
          if(!t) return t;
          if(t[targetTeam].length>=5) return t; // no sobrepasar 5
          return {
            ...t,
            [from]: t[from].filter(x=>x!==id),
            [targetTeam]: t[targetTeam].includes(id)? t[targetTeam] : [...t[targetTeam], id]
          };
        });
        setDragInfo(null);
      };

      // helpers métricas
      const Aids=teams?.A||[], Bids=teams?.B||[];
      const rateA=teamGlobal(Aids,map), rateB=teamGlobal(Bids,map);
      const chemA=chemTeam(Aids,chem), chemB=chemTeam(Bids,chem);
      const scoreA=+(rateA+chemA*kChem).toFixed(2);
      const scoreB=+(rateB+chemB*kChem).toFixed(2);

      // UI: Header alto con título F5C + engranaje
      const TabButton = ({id,label})=>(
        <button className={`tab-btn ${tab===id?'active':''}`} onClick={()=>setTab(id)}>{label}</button>
      );

      // ordenar/filtrar lista Plantel
      const openDetails=id=>{ setPlayerDetailId(id); setModal('player'); };

      /* ========= RENDER ========= */
      const tabIndex = (tab==='partido'?0:1);
      const convocadosCount = convocados.length;

      return (
        <div className="min-h-screen">
          {/* Header */}
          <header className="app-header">
            <div className="mx-auto max-w-6xl px-3 py-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="grid h-10 w-10 place-items-center rounded-xl bg-emerald-600/20 ring-1 ring-emerald-500/30">⚽</div>
                </div>
                <div className="text-center">
                  <div style={{fontStyle:'italic'}} className="text-3xl font-extrabold tracking-wide">
                    F5C
                  </div>
                  <div className="text-xs text-slate-400 -mt-1">Fútbol 5 Coronda</div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={()=>setSettings(true)} className="rounded-xl bg-slate-800 px-3 py-2 ring-1 ring-slate-700 hover:bg-slate-700" title="Configuración">⚙️</button>
                </div>
              </div>

              {/* Tabs */}
              <div className="mt-3">
                <div className="tab-nav flex items-center gap-2">
                  <TabButton id="partido" label="Partido"/>
                  <TabButton id="plantel" label="Plantel"/>
                </div>
                <div className="mt-2">
                  <span className="inline-block rounded-full bg-slate-800/70 px-3 py-1 text-sm ring-1 ring-slate-700">
                    Convocados: <b>{convocadosCount}</b>/10
                  </span>
                </div>
              </div>
            </div>
          </header>
          <div className="header-spacer"></div>

          {/* Tabs viewport (swipe) */}
          <div ref={viewportRef} className="tabs-viewport">
            <div className="tabs-track" style={{transform:`translateX(${tabIndex*-50}%)`}}>
              {/* === PARTIDO === */}
              <section className="tabs-page space-y-3">
                <div className="mx-auto max-w-6xl space-y-3">
                  {/* Botones grandes AZAR / EQUILIBRADO */}
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button
                      onClick={makeR}
                      disabled={!canMake || invalidPins}
                      className={`rounded-2xl px-4 py-4 text-lg font-bold ring-1 ${canMake && !invalidPins ? 'bg-indigo-600 text-white ring-indigo-500 hover:bg-indigo-500' : 'bg-slate-800/50 text-slate-400 ring-slate-700 cursor-not-allowed'}`}>
                      🎲 AZAR
                      <div className="text-xs font-normal opacity-80 mt-1">Requiere 10 convocados</div>
                    </button>
                    <button
                      onClick={makeB}
                      disabled={!canMake || invalidPins}
                      className={`rounded-2xl px-4 py-4 text-lg font-bold ring-1 ${canMake && !invalidPins ? 'bg-emerald-600 text-white ring-emerald-500 hover:bg-emerald-500' : 'bg-slate-800/50 text-slate-400 ring-slate-700 cursor-not-allowed'}`}>
                      ⚖️ EQUILIBRADO
                      <div className="text-xs font-normal opacity-80 mt-1">Respeta pines A/B</div>
                    </button>
                  </div>

                  {/* Listado por equipo (arriba de todo) */}
                  {teams ? (
                    <div className={`grid ${listTwoCols?'md:grid-cols-2':'grid-cols-1'} gap-3`}>
                      {/* Equipo A */}
                      <div
                        onDragOver={onDragOver}
                        onDrop={onDrop('A')}
                        className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                        <div className="mb-2 flex items-center justify-between">
                          <div className="text-lg font-bold">Equipo A</div>
                          <div className="text-xs text-slate-300">
                            Rating: <b>{rateA}</b> &nbsp;•&nbsp; Química: <b>{chemA}</b> &nbsp;•&nbsp; Score: <b>{scoreA}</b>
                          </div>
                        </div>
                        <div className="space-y-2">
                          {Aids.map(id=>{
                            const p=map[id]; if(!p) return null;
                            return (
                              <div key={id}
                                   draggable
                                   onDragStart={onDragStart('A',id)}
                                   className="cursor-move">
                                <PlayerRow
                                  p={p}
                                  selected={true}
                                  onToggle={()=>toggle(id)}
                                  onOpen={()=>openDetails(id)}
                                  pinA={pinA} pinB={pinB} setPinA={setPinA} setPinB={setPinB}
                                  disableAdd={false}
                                />
                              </div>
                            );
                          })}
                          {Aids.length<5 && (
                            <div className="rounded-xl border border-dashed border-slate-600 p-4 text-center text-slate-400">
                              Arrastrá aquí un jugador del B…
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Equipo B */}
                      <div
                        onDragOver={onDragOver}
                        onDrop={onDrop('B')}
                        className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                        <div className="mb-2 flex items-center justify-between">
                          <div className="text-lg font-bold">Equipo B</div>
                          <div className="text-xs text-slate-300">
                            Rating: <b>{rateB}</b> &nbsp;•&nbsp; Química: <b>{chemB}</b> &nbsp;•&nbsp; Score: <b>{scoreB}</b>
                          </div>
                        </div>
                        <div className="space-y-2">
                          {Bids.map(id=>{
                            const p=map[id]; if(!p) return null;
                            return (
                              <div key={id}
                                   draggable
                                   onDragStart={onDragStart('B',id)}
                                   className="cursor-move">
                                <PlayerRow
                                  p={p}
                                  selected={true}
                                  onToggle={()=>toggle(id)}
                                  onOpen={()=>openDetails(id)}
                                  pinA={pinA} pinB={pinB} setPinA={setPinA} setPinB={setPinB}
                                  disableAdd={false}
                                />
                              </div>
                            );
                          })}
                          {Bids.length<5 && (
                            <div className="rounded-xl border border-dashed border-slate-600 p-4 text-center text-slate-400">
                              Arrastrá aquí un jugador del A…
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="rounded-2xl bg-slate-900/60 p-3 ring-1 ring-slate-700 text-sm">
                      Elegí 10 convocados y usa <b>AZAR</b> o <b>EQUILIBRADO</b> para generar equipos.
                    </div>
                  )}

                  {/* Radar comparativo */}
                  {teams && (
                    <TeamRadarCompare A={Aids} B={Bids} map={map}/>
                  )}

                  {/* Barras: 2 columnas lado a lado (A/B) */}
                  {teams && (
                    <div className={`grid ${listTwoCols?'md:grid-cols-2':'grid-cols-1'} gap-3`}>
                      <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                        <div className="mb-2 text-sm font-semibold">Barras Equipo A</div>
                        <BarsChart values={teamAvgValues(Aids)} accent={TC.A.hex}/>
                      </div>
                      <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                        <div className="mb-2 text-sm font-semibold">Barras Equipo B</div>
                        <BarsChart values={teamAvgValues(Bids)} accent={TC.B.hex}/>
                      </div>
                    </div>
                  )}

                  {/* Semáforo balance */}
                  {teams && (
                    <BalanceIndicator A={Aids} B={Bids} map={map} chem={chem} kChem={kChem}/>
                  )}

                  {/* Formación al final */}
                  {teams && (
                    <FormationBoard teamA={Aids} teamB={Bids} map={map} kChem={kChem} chem={chem} scale={formScale}/>
                  )}
                </div>
              </section>

              {/* === PLANTEL === */}
              <section className="tabs-page space-y-3">
                <div className="mx-auto max-w-6xl">
                  <div className="mb-2 grid grid-cols-1 gap-2 sm:grid-cols-3">
                    <input value={q} onChange={e=>setQ(e.target.value)}
                           placeholder="Buscar por nombre, propio, favorito…"
                           className="rounded-xl bg-slate-900 px-3 py-2 ring-1 ring-slate-700"/>
                    <select value={sort} onChange={e=>setSort(e.target.value)}
                            className="rounded-xl bg-slate-900 px-3 py-2 ring-1 ring-slate-700">
                      <option value="global-desc">Rating ↓</option>
                      <option value="global-asc">Rating ↑</option>
                      <option value="nombre">Nombre A–Z</option>
                    </select>
                    <div className="flex gap-2">
                      <button onClick={()=>setForm({})} className="flex-1 rounded-xl bg-emerald-600 px-3 py-2 text-white ring-1 ring-emerald-500 hover:bg-emerald-500">+ Jugador</button>
                      <button onClick={()=>reset()} className="rounded-xl bg-slate-800 px-3 py-2 ring-1 ring-slate-700 hover:bg-slate-700">Seed</button>
                    </div>
                  </div>

                  <div className="plantel-scroll space-y-2">
                    {filtered.map(p=>{
                      const sel=selected.has(p.id);
                      return (
                        <PlayerRow key={p.id}
                                   p={p}
                                   selected={sel}
                                   onToggle={()=>toggle(p.id)}
                                   onOpen={()=>openDetails(p.id)}
                                   pinA={pinA} pinB={pinB} setPinA={setPinA} setPinB={setPinB}
                                   disableAdd={reachedMax && !sel}/>
                      );
                    })}
                    {filtered.length===0 && (
                      <div className="rounded-xl bg-slate-900/60 p-3 text-center ring-1 ring-slate-700 text-sm text-slate-300">
                        No hay jugadores que coincidan con tu búsqueda.
                      </div>
                    )}
                  </div>
                </div>
              </section>
            </div>
          </div>

          {/* Install pill sticky */}
          {!isStandalone && deferredPrompt && (
            <button onClick={doInstall}
                    className="install-pill rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white ring-1 ring-emerald-500 shadow-lg">
              ⤓ Instalar F5C
            </button>
          )}

          {/* Modales */}
          {settings && (
            <SettingsModal
              onClose={()=>setSettings(false)}
              kChem={kChem} setKChem={setKChem}
              onExport={onExport}
              onImport={onImport}
              onReset={reset}
              parallaxOn={parallaxOn} setParallaxOn={setParallaxOn}
              formScale={formScale} setFormScale={setFormScale}
              listTwoCols={listTwoCols} setListTwoCols={setListTwoCols}
              onOpenGlossary={()=>{ setShowGlossary(true); }}
            />
          )}
          {showGlossary && <GlossaryModal onClose={()=>setShowGlossary(false)}/>}

          {form && (
            <PlayerFormModal
              initial={form.id? map[form.id]: null}
              onCancel={()=>setForm(null)}
              onSave={onSave}
            />
          )}
          {modal==='player' && playerDetailId && map[playerDetailId] && (
            <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={()=>{setModal(null);setPlayerDetailId(null)}}>
              <div className="w-full max-w-4xl rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 max-h-[90vh] overflow-auto" onClick={e=>e.stopPropagation()}>
                <div className="mb-2 flex items-center justify-between">
                  <div className="text-lg font-semibold">{map[playerDetailId].nombre}</div>
                  <div className="flex gap-2">
                    <button onClick={()=>{ setForm(map[playerDetailId]); setModal(null);} } className="rounded-xl bg-slate-800 px-3 py-1 ring-1 ring-slate-700 hover:bg-slate-700">Editar</button>
                    <button onClick={()=>{ onDel(playerDetailId); setModal(null);}} className="rounded-xl bg-rose-700 px-3 py-1 text-white ring-1 ring-rose-500 hover:bg-rose-600">Eliminar</button>
                    <button onClick={()=>{setModal(null);setPlayerDetailId(null)}} className="rounded-xl bg-slate-800 px-3 py-1 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
                  </div>
                </div>
                <PlayerDetails p={map[playerDetailId]}/>
              </div>
            </div>
          )}
        </div>
      );
    };

    /* ========= Mount ========= */
    const root=ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>

