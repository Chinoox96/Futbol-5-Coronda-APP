<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="es" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F√∫tbol 5 - Generador</title>
  <meta name="theme-color" content="#10b981" />
  <!-- Tailwind v√≠a CDN (sin build) -->
  <script src="https://cdn.tailwindcss.com" onerror="this.onerror=null;this.src='https://unpkg.com/tailwindcss@3.4.4/dist/tailwind.min.js'"></script>
  <!-- React 18 UMD + Babel Standalone para compilar JSX en el navegador -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js'"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js'"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js'"></script>
  <!-- Base relativa: hace que ./sw.js, ./icons/ funcionen tanto en / como en /<repo>/ -->
  <base href="./" />
  <!-- Manifest: lo trataremos de cargar EST√ÅTICO si existe; si no, se inyecta din√°mico -->
  <link rel="manifest" id="dynamic-manifest-link" />
  <link rel="icon" href="./icons/icon-192.png" />
  <style> html,body{background:#0b1220;color:#e2e8f0} </style>
</head>
<body>
  <!-- Overlay de errores fatal (aparece si falla algo JS/CDN) -->
  <script>
    (function(){
      function showFatal(msg){
        var el=document.getElementById('fatal');
        if(!el){ el=document.createElement('div'); el.id='fatal'; el.style.position='fixed'; el.style.inset='0'; el.style.background='rgba(2,6,23,0.98)'; el.style.color='#fca5a5'; el.style.zIndex='99999'; el.style.padding='16px'; el.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, monospace'; el.style.overflow='auto'; document.body.appendChild(el);} 
        el.innerHTML='<div style="max-width:900px;margin:0 auto">'+
          '<h2 style="font-weight:700;margin:0 0 12px">‚ö†Ô∏è Error cargando la app</h2>'+
          '<pre style="white-space:pre-wrap">'+String(msg)+'</pre>'+
          '<p style="opacity:.9">Prob√°: recargar sin cach√© (Ctrl/Cmd+Shift+R), revisar conexi√≥n/CDNs, o decirme qu√© sale aqu√≠.</p>'+
        '</div>';
      }
      window.addEventListener('error', function(e){ showFatal((e.error&&e.error.stack)||e.message||String(e)); });
      window.addEventListener('unhandledrejection', function(e){ showFatal((e.reason&&e.reason.stack)||String(e.reason)); });
      window.__showFatal=showFatal;
    })();
  </script>

  <div id="root"><div id="boot" class="mx-auto max-w-screen-md p-3">Cargando‚Ä¶</div></div>

  <!-- Verificador de librer√≠as por si las CDNs fallan -->
  <script>
    setTimeout(function(){
      if(!window.React||!window.ReactDOM){
        (window.__showFatal||alert)('No se carg√≥ React/ReactDOM desde la CDN. ¬øBloqueador o conexi√≥n?');
      } else if(!window.Babel){
        (window.__showFatal||alert)('No se carg√≥ Babel Standalone. El JSX no puede compilarse en el navegador.');
      }
    },3000);
  </script>

  <script type="text/babel">
    const { useMemo, useState, useEffect, useRef } = React;

    // ================= PWA: manifest est√°tico o din√°mico + SW =================
    (async function ensureManifest(){
      try{
        const base = document.querySelector('base')?.getAttribute('href') || './';
        const linkEl = document.getElementById('dynamic-manifest-link');
        // 1) Intentar manifest est√°tico si existe (mejor para Lighthouse/Chrome DevTools)
        const staticUrl = base + 'manifest.webmanifest';
        try {
          const headRes = await fetch(staticUrl, { method: 'HEAD' });
          if (headRes.ok) { linkEl.setAttribute('href', staticUrl); return; }
        } catch {}
        // 2) Si no existe, inyectar din√°mico como antes
        const manifest = {
          name: 'F√∫tbol 5',
          short_name: 'Futbol5',
          start_url: base,
          display: 'standalone',
          background_color: '#0f172a',
          theme_color: '#10b981',
          icons: [
            { src: base + 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: base + 'icons/icon-512.png', sizes: '512x512', type: 'image/png' }
          ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        const url = URL.createObjectURL(blob);
        linkEl.setAttribute('href', url);
      }catch(e){ console.log('[PWA] manifest din√°mico fall√≥', e); }
    })();

    (function registerSW(){
      if ('serviceWorker' in navigator) {
        const base = document.querySelector('base')?.getAttribute('href') || './';
        // Registrar /sw.js relativo a la p√°gina actual
        const swUrl = new URL('sw.js', location.href).pathname;
        navigator.serviceWorker.register(swUrl, { scope: base }).then(
          reg => console.log('[PWA] SW OK (scope=', base, ')', reg),
          err => console.log('[PWA] SW FAIL', err)
        );
      }
    })();

    // ================= Tipos / Datos =================
    /** @typedef {{ id:string, nombre:string, fotoUrl?:string, escudoUrl?:string, equipoPropio?:string, equipoFavorito?:string, ATA:number, PAS:number, REG:number, VEL:number, DEF:number, FIS:number, ARQ:number, EQP:number, _GLOBAL?:number }} Jugador */

    /** @type {Jugador[]} */
    const SEED_JUGADORES = [
      { id: '1', nombre: 'Leo',  equipoPropio: 'La 10', equipoFavorito: 'Barcelona',   fotoUrl: 'https://i.pravatar.cc/150?img=1',  ATA:10,PAS:9, REG:10,VEL:9, DEF:4, FIS:7, ARQ:3, EQP:8 },
      { id: '2', nombre: 'Fabi', equipoPropio: 'La 10', equipoFavorito: 'Col√≥n',       fotoUrl: 'https://i.pravatar.cc/150?img=6',  ATA:7, PAS:8, REG:7, VEL:7, DEF:7, FIS:7, ARQ:4, EQP:9 },
      { id: '3', nombre: 'Cuti', equipoPropio: 'Muralla', equipoFavorito: 'Belgrano',   fotoUrl: 'https://i.pravatar.cc/150?img=4',  ATA:5, PAS:6, REG:5, VEL:7, DEF:10,FIS:9, ARQ:4, EQP:7 },
      { id: '4', nombre: 'Dibu', equipoPropio: 'Muralla', equipoFavorito: 'Arsenal',    fotoUrl: 'https://i.pravatar.cc/150?img=5',  ATA:3, PAS:5, REG:4, VEL:5, DEF:8, FIS:8, ARQ:10,EQP:7 },
      { id: '5', nombre: 'Papu', equipoPropio: 'Tiki',    equipoFavorito: 'San Lorenzo', fotoUrl: 'https://i.pravatar.cc/150?img=9',  ATA:8, PAS:8, REG:9, VEL:8, DEF:5, FIS:6, ARQ:3, EQP:7 },
      { id: '6', nombre: 'Nico', equipoPropio: 'Tiki',    equipoFavorito: 'Boca',       fotoUrl: 'https://i.pravatar.cc/150?img=8',  ATA:7, PAS:7, REG:7, VEL:8, DEF:6, FIS:7, ARQ:4, EQP:6 },
      { id: '7', nombre: 'Chino',equipoPropio: 'Muralla', equipoFavorito: "Newell's",  fotoUrl: 'https://i.pravatar.cc/150?img=10', ATA:5, PAS:6, REG:5, VEL:6, DEF:8, FIS:7, ARQ:8, EQP:6 },
      { id: '8', nombre: 'Joa',  equipoPropio: 'La 10', equipoFavorito: 'River',       fotoUrl: 'https://i.pravatar.cc/150?img=7',  ATA:6, PAS:6, REG:6, VEL:7, DEF:8, FIS:8, ARQ:5, EQP:7 },
      { id: '9', nombre: 'Fideo',equipoPropio: 'Tiki',    equipoFavorito: 'Rosario C.', fotoUrl: 'https://i.pravatar.cc/150?img=3',  ATA:8, PAS:9, REG:9, VEL:8, DEF:6, FIS:6, ARQ:3, EQP:8 },
      { id: '10',nombre: 'Kuni', equipoPropio: 'La 10', equipoFavorito: 'Independiente',fotoUrl: 'https://i.pravatar.cc/150?img=2',  ATA:9, PAS:7, REG:8, VEL:9, DEF:5, FIS:7, ARQ:3, EQP:7 },
      { id: '11',nombre: 'Tomi', equipoPropio: 'Muralla', equipoFavorito: 'Talleres',   fotoUrl: 'https://i.pravatar.cc/150?img=11', ATA:6, PAS:7, REG:6, VEL:7, DEF:7, FIS:7, ARQ:5, EQP:6 },
      { id: '12',nombre: 'Gonza',equipoPropio: 'Tiki',    equipoFavorito: 'Racing',     fotoUrl: 'https://i.pravatar.cc/150?img=12', ATA:7, PAS:6, REG:7, VEL:8, DEF:6, FIS:7, ARQ:4, EQP:6 },
    ];

    const STAT_KEYS = ['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
    const STAT_LABEL = { ATA:'Ataque', PAS:'Pase', REG:'Regate', VEL:'Velocidad', DEF:'Defensa', FIS:'F√≠sico', ARQ:'Arco', EQP:'Equipo' };
    const TEAM_COLORS = {
      A: { stroke: 'rgba(16,185,129,1)', fill: 'rgba(16,185,129,0.18)', dotClass: 'bg-emerald-500', hex: '#10b981' },
      B: { stroke: 'rgba(59,130,246,1)', fill: 'rgba(59,130,246,0.18)', dotClass: 'bg-blue-500',    hex: '#3b82f6' },
    };
    const WEIGHTS = { ATA:0.18, DEF:0.16, PAS:0.14, REG:0.14, VEL:0.14, FIS:0.10, ARQ:0.07, EQP:0.07 };
    const K_CHEM = 0.6; // usado por tests y funciones base

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const avg = (arr) => (arr.length ? arr.reduce((p,c)=>p+c,0)/arr.length : 0);
    const globalOf = (p) => { let s=0,w=0; for (const k of Object.keys(WEIGHTS)){ s+=(p[k]||0)*WEIGHTS[k]; w+=WEIGHTS[k]; } return Number((s/w).toFixed(2)); };

    // ======= Persistencia =======
    const STORAGE_KEYS = { players:'f5.players', selected:'f5.selected', teams:'f5.teams', kchem:'f5.kchem' };
    const safeJSON = (s, d) => { try { return JSON.parse(s); } catch { return d; } };

    const withGlobals = (arr)=> arr.map(p=> ({...p, _GLOBAL: globalOf(p)}));

    // Qu√≠mica
    const buildChemistry = (players) => {
      const q={};
      for(const a of players){ q[a.id]={}; for(const b of players){ if(a.id===b.id){q[a.id][b.id]=10; continue;} if(q[b.id]?.[a.id]!=null){ q[a.id][b.id]=q[b.id][a.id]; continue;} let v=5; if(a.equipoPropio&&b.equipoPropio&&a.equipoPropio===b.equipoPropio) v+=1.2; if(a.equipoFavorito&&b.equipoFavorito&&a.equipoFavorito===b.equipoFavorito) v+=0.8; const eqpBonus=((a.EQP+b.EQP)/2 - 5)*0.15; v+=eqpBonus; q[a.id][b.id]=clamp(Number(v.toFixed(2)),1,10);} }
      return q;
    };
    const teamChemistry = (ids, chem) => { if(ids.length<=1) return 10; let t=0,p=0; for(let i=0;i<ids.length;i++) for(let j=i+1;j<ids.length;j++){ t+= chem[ids[i]]?.[ids[j]] ?? 5; p++; } return Number((t/(p||1)).toFixed(2)); };
    const teamGlobal = (ids, map) => Number(avg(ids.map(id=>map[id]._GLOBAL)).toFixed(2));
    const teamScore  = (ids, map, chem) => Number((teamGlobal(ids,map)+teamChemistry(ids,chem)*K_CHEM).toFixed(2)); // base (tests)
    const teamScoreUI = (ids, map, chem, kChem) => Number((teamGlobal(ids,map)+teamChemistry(ids,chem)*kChem).toFixed(2)); // UI ajustable

    const randomSplit = (ids) => { const s=[...ids].sort(()=>Math.random()-0.5); const m=Math.floor(s.length/2); return [s.slice(0,m), s.slice(m)]; };
    const scoreDiff = (A,B,map,chem,kChem=K_CHEM) => { const sA=teamScoreUI(A,map,chem,kChem), sB=teamScoreUI(B,map,chem,kChem); return {A:[...A],B:[...B],diff:Math.abs(sA-sB),m:{sA,sB}}; };
    const balancedSplit = (ids,map,chem,kChem=K_CHEM) => { let [A,B]=randomSplit(ids); let best=scoreDiff(A,B,map,chem,kChem); const iter=900; for(let t=0;t<iter;t++){ const i=Math.floor(Math.random()*A.length), j=Math.floor(Math.random()*B.length); [A[i],B[j]]=[B[j],A[i]]; const cur=scoreDiff(A,B,map,chem,kChem); if(cur.diff<=best.diff || Math.random()<0.12){ best=cur; } else { [A[i],B[j]]=[B[j],A[i]]; } } return { A:best.A, B:best.B, m:best.m }; };

    const Pill = ({ children, className='' }) => <span className={`inline-block rounded-full px-2 py-0.5 text-xs ${className}`}>{children}</span>;

    // ========= UI: Filas, Tarjetas, Charts =========
    function PlayerRow({ p, selected, onToggle, onOpen }){
      return (
        <div className="flex items-center gap-3 rounded-xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <img src={p.fotoUrl} alt={p.nombre} className="h-10 w-10 rounded-full object-cover ring-1 ring-slate-700" />
          <div className="min-w-0 flex-1">
            <div className="flex items-center justify-between">
              <button onClick={onOpen} className="min-w-0 text-left">
                <div className="truncate text-base font-semibold">{p.nombre}</div>
                <div className="mt-0.5 flex flex-wrap items-center gap-1 text-xs text-slate-400">
                  <Pill className="bg-slate-800/80 text-slate-200">Global: {p._GLOBAL}</Pill>
                  {p.equipoPropio && <Pill className="bg-indigo-600/20 text-indigo-200">Propio: {p.equipoPropio}</Pill>}
                  {p.equipoFavorito && <Pill className="bg-cyan-600/20 text-cyan-200">Fav: {p.equipoFavorito}</Pill>}
                </div>
              </button>
              <div className="flex items-center gap-2">
                <button onClick={onToggle} className={`rounded-xl px-3 py-1 text-sm ring-1 ${selected ? 'bg-emerald-600 text-white ring-emerald-500' : 'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>
                  {selected ? '‚úì Convocado' : '+ Convocar'}
                </button>
              </div>
            </div>
            <div className="mt-2 grid grid-cols-4 gap-1 text-[11px] text-slate-300">
              {STAT_KEYS.map(k => (
                <div key={k} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1">
                  <span className="font-medium" title={STAT_LABEL[k]}>{k}</span>
                  <span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function TeamCard({ title, teamKey, ids, map, chem, onOpenPlayer, kChem }){
      const g = teamGlobal(ids, map);
      const c = teamChemistry(ids, chem);
      const s = teamScoreUI(ids, map, chem, kChem);
      const color = TEAM_COLORS[teamKey] || TEAM_COLORS.A;
      return (
        <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <div className="mb-2 flex items-center justify-between">
            <h3 className="flex items-center gap-2 text-base font-semibold">
              <span className={`h-2.5 w-2.5 rounded-full ${color.dotClass}`} /> {title}
            </h3>
            <div className="text-xs text-slate-400">Jugadores: {ids.length}</div>
          </div>
          <div className="mb-3 grid grid-cols-3 gap-2 text-sm">
            <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Global</div><div className="text-lg font-bold">{g}</div></div>
            <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Qu√≠mica</div><div className="text-lg font-bold">{c}</div></div>
            <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Score</div><div className="text-lg font-bold">{s}</div></div>
          </div>
          <ul className="space-y-1 text-sm">
            {ids.map(id => (
              <li key={id} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1">
                <button onClick={()=>onOpenPlayer(map[id])} className="truncate text-left hover:underline">{map[id].nombre}</button>
                <span className="text-slate-300">G:{map[id]._GLOBAL} - EQP:{map[id].EQP}</span>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    function RadarChart({ size=260, max=10, keys=STAT_KEYS, dataSeries }){
      const cx = size/2, cy = size/2, r = size*0.4; const N = keys.length;
      const angleFor = (i) => (Math.PI*2 * i / N) - Math.PI/2;
      const point = (i, value) => { const a=angleFor(i); const rr=r*(value/max); return [cx+rr*Math.cos(a), cy+rr*Math.sin(a)]; };
      const gridLevels = [2,4,6,8,10];
      return (
        <svg width={size} height={size} className="mx-auto block">
          {gridLevels.map((lvl, idx)=>{ const pts = keys.map((_,i)=>point(i,lvl)).map(([x,y])=>`${x},${y}`).join(' '); return <polygon key={idx} points={pts} fill="none" stroke="rgba(148,163,184,0.25)" strokeWidth={1}/>; })}
          {keys.map((k,i)=>{ const [x,y]=point(i,max); return <line key={k} x1={cx} y1={cy} x2={x} y2={y} stroke="rgba(148,163,184,0.3)" strokeWidth={1}/>; })}
          {keys.map((k,i)=>{ const [x,y]=point(i,max+0.9); return <text key={k} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize={11} fill="#cbd5e1">{k}</text>; })}
          {dataSeries.map((s,idx)=>{ const pts = keys.map((k,i)=>point(i,s.values[k]??0)).map(([x,y])=>`${x},${y}`).join(' '); return (<g key={idx}><polygon points={pts} fill={s.fill} stroke={s.stroke} strokeWidth={2}/></g>); })}
        </svg>
      );
    }

    function BarsChart({ values, max=10, accent }){
      const color = accent || '#22d3ee';
      return (
        <div className="space-y-2">
          {STAT_KEYS.map(k=> (
            <div key={k}>
              <div className="mb-1 flex items-center justify-between text-sm">
                <span className="text-slate-300" title={STAT_LABEL[k]}>{k}</span>
                <span className="font-semibold">{values[k]}</span>
              </div>
              <div className="h-2 w-full rounded bg-slate-700">
                <div className="h-2 rounded" style={{ width: `${Math.max(0, Math.min(100, (values[k]/max)*100))}%`, backgroundColor: color }} />
              </div>
            </div>
          ))}
        </div>
      );
    }

    function PlayerChemList({ player, players, chem, teamIdsA=[], teamIdsB=[] }){
      const list = players.filter(p=>p.id!==player.id).map(p=>{
        const v = chem[player.id]?.[p.id] ?? 5;
        const onA = teamIdsA.includes(p.id);
        const onB = teamIdsB.includes(p.id);
        return { ...p, _chem:v, onA, onB };
      }).sort((a,b)=> b._chem - a._chem);
      return (
        <div className="max-h-72 overflow-auto space-y-1">
          {list.map(o=> (
            <div key={o.id} className={`flex items-center justify-between rounded-lg px-2 py-1 text-sm ${o.onA? 'bg-emerald-600/15 ring-1 ring-emerald-500/30' : o.onB? 'bg-blue-600/15 ring-1 ring-blue-500/30':'bg-slate-800/60 ring-1 ring-slate-700'}`}>
              <div className="flex items-center gap-2 min-w-0">
                <img src={o.fotoUrl} className="h-7 w-7 rounded-full object-cover ring-1 ring-slate-700"/>
                <span className="truncate">{o.nombre}</span>
              </div>
              <span className="font-semibold">{o._chem}</span>
            </div>
          ))}
        </div>
      );
    }

    function PlayerModal({ player, onClose, players, chem, teamIdsA=[], teamIdsB=[] }){
      const [mode, setMode] = useState('radar');
      if (!player) return null;
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
          <div className="w-full max-w-md rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
            <div className="mb-2 flex items-center gap-3">
              <img src={player.fotoUrl} alt={player.nombre} className="h-12 w-12 rounded-xl object-cover ring-1 ring-slate-700" />
              <div className="min-w-0">
                <div className="truncate text-lg font-semibold">{player.nombre}</div>
                <div className="text-xs text-slate-400">Global: {player._GLOBAL} - Propio: {player.equipoPropio||'-'} - Fav: {player.equipoFavorito||'-'}</div>
              </div>
              <button onClick={onClose} className="ml-auto rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
            </div>
            <div className="mb-3 flex gap-2">
              <button onClick={()=>setMode('radar')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='radar'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Radar</button>
              <button onClick={()=>setMode('barras')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='barras'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Barras</button>
              <button onClick={()=>setMode('quim')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='quim'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Qu√≠mica</button>
            </div>
            {mode==='radar' ? (
              <RadarChart dataSeries={[{ label: player.nombre, values: player, stroke:'rgba(34,211,238,1)', fill:'rgba(34,211,238,0.18)' }]} />
            ) : mode==='barras' ? (
              <BarsChart values={player} />
            ) : (
              <PlayerChemList player={player} players={players} chem={chem} teamIdsA={teamIdsA} teamIdsB={teamIdsB} />
            )}
          </div>
        </div>
      );
    }

    function teamAverages(ids, map){ const out={}; STAT_KEYS.forEach(k=>{ out[k]= Number(avg(ids.map(id=>map[id][k])).toFixed(2)); }); return out; }

    function TeamRadarCompare({ A, B, map }){
      const avgA = teamAverages(A, map);
      const avgB = teamAverages(B, map);
      return (
        <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <div className="mb-2 text-center text-sm text-slate-300">Radar comparativo (promedio por stat)</div>
          <RadarChart dataSeries={[
            { label:'A', values: avgA, stroke: TEAM_COLORS.A.stroke, fill: TEAM_COLORS.A.fill },
            { label:'B', values: avgB, stroke: TEAM_COLORS.B.stroke, fill: TEAM_COLORS.B.fill },
          ]} />
          <div className="mt-2 flex justify-center gap-4 text-xs text-slate-300">
            <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TEAM_COLORS.A.dotClass}`}></span> Equipo A</span>
            <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TEAM_COLORS.B.dotClass}`}></span> Equipo B</span>
          </div>
        </div>
      );
    }

    function BalanceIndicator({ A, B, map, chem, kChem }){
      const sA = teamScoreUI(A, map, chem, kChem);
      const sB = teamScoreUI(B, map, chem, kChem);
      const diff = Number(Math.abs(sA - sB).toFixed(2));
      let label='Parejo', classes='bg-emerald-600/15 text-emerald-200 ring-emerald-500/30';
      if (diff >= 0.8) { label='Desbalanceado'; classes='bg-rose-600/15 text-rose-200 ring-rose-500/30'; }
      else if (diff >= 0.3) { label='Aceptable'; classes='bg-amber-600/15 text-amber-100 ring-amber-500/30'; }
      return (
        <div className={`rounded-2xl p-3 ring-1 ${classes}`}>
          <div className="flex items-center justify-between text-sm">
            <div className="font-semibold">Balance del partido</div>
            <div className="text-xs opacity-80">Diff: {diff}</div>
          </div>
          <div className="mt-1 text-sm">Resultado: <span className="font-semibold">{label}</span> <span className="opacity-80">(A: {sA} vs B: {sB})</span></div>
          <div className="mt-1 text-xs opacity-80">Umbrales: Parejo &lt; 0.30 - Aceptable &lt; 0.80 - Desbalanceado ‚â• 0.80</div>
        </div>
      );
    }

    function TeamMiniSummary({ ids, map, chem, kChem }){
      const g = teamGlobal(ids, map);
      const c = teamChemistry(ids, chem);
      const s = teamScoreUI(ids, map, chem, kChem);
      return (
        <div className="grid grid-cols-3 gap-1 text-center">
          <div>
            <div className="text-slate-400 text-xs">Global</div>
            <div className="font-bold">{g}</div>
          </div>
          <div>
            <div className="text-slate-400 text-xs">Qu√≠mica</div>
            <div className="font-bold">{c}</div>
          </div>
          <div>
            <div className="text-slate-400 text-xs">Score</div>
            <div className="font-bold">{s}</div>
          </div>
        </div>
      );
    }

    // ======= Modales: A√±adir/Editar jugador + Settings =======
    function PlayerFormModal({ initial, onCancel, onSave }){
      const [form, setForm] = useState(()=> initial || { nombre:'', equipoPropio:'', equipoFavorito:'', fotoUrl:'', ATA:5,PAS:5,REG:5,VEL:5,DEF:5,FIS:5,ARQ:5,EQP:5 });
      const fileRef = useRef(null);
      const set = (k,v)=> setForm(f=> ({...f,[k]:v}));
      const onFile = (e)=>{ const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=> set('fotoUrl', rd.result); rd.readAsDataURL(f); };
      const onSubmit = (e)=>{ e.preventDefault(); const clean={...form}; STAT_KEYS.forEach(k=> clean[k]=clamp(parseInt(clean[k]||0,10),1,10)); if(!clean.nombre.trim()) return; onSave(clean); };
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onCancel}>
          <form className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onSubmit={onSubmit} onClick={e=>e.stopPropagation()}>
            <div className="text-lg font-semibold">{initial? 'Editar jugador':'A√±adir jugador'}</div>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <label className="space-y-1"><span>Nombre</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.nombre} onChange={e=>set('nombre',e.target.value)} required/></label>
              <label className="space-y-1"><span>Foto URL</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.fotoUrl||''} placeholder="https://..." onChange={e=>set('fotoUrl',e.target.value)}/></label>
              <label className="space-y-1 col-span-2"><span>o subir imagen</span><input ref={fileRef} type="file" accept="image/*" onChange={onFile} className="w-full text-xs"/></label>
              <label className="space-y-1"><span>Equipo propio</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.equipoPropio||''} onChange={e=>set('equipoPropio',e.target.value)}/></label>
              <label className="space-y-1"><span>Equipo favorito</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.equipoFavorito||''} onChange={e=>set('equipoFavorito',e.target.value)}/></label>
            </div>
            <div className="grid grid-cols-4 gap-2 text-sm">
              {STAT_KEYS.map(k=> (
                <label key={k} className="space-y-1"><span title={STAT_LABEL[k]}>{k}</span><input type="number" min="1" max="10" className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form[k]} onChange={e=>set(k,e.target.value)} /></label>
              ))}
            </div>
            <div className="flex justify-end gap-2">
              <button type="button" onClick={onCancel} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cancelar</button>
              <button type="submit" className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">Guardar</button>
            </div>
          </form>
        </div>
      );
    }

    function SettingsModal({ onClose, kChem, setKChem, onExport, onImport, onReset }){
      const importRef = useRef(null);
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
          <div className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
            <div className="mb-1 text-lg font-semibold">Ajustes</div>
            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Peso de Qu√≠mica en Score</div>
              <input type="range" min="0" max="1" step="0.05" value={kChem} onChange={e=>setKChem(Number(e.target.value))} className="w-full"/>
              <div className="text-xs text-slate-300 mt-1">k = {kChem.toFixed(2)} (solo UI; los tests siguen con k=0.60)</div>
            </div>
            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-2">
              <div className="text-sm font-semibold">Importar / Exportar plantel</div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onExport} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Exportar JSON</button>
                <button onClick={()=>importRef.current?.click()} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Importar JSON</button>
                <input ref={importRef} type="file" accept="application/json" className="hidden" onChange={onImport} />
                <button onClick={onReset} className="ml-auto rounded-xl bg-rose-700 px-3 py-1 text-sm text-white ring-1 ring-rose-500 hover:bg-rose-600">Restablecer seed</button>
              </div>
              <div className="text-xs text-slate-400">El JSON incluye jugadores y fotos (si subiste archivo se guarda como base64).</div>
            </div>
            <div className="text-right">
              <button onClick={onClose} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
            </div>
          </div>
        </div>
      );
    }

    function App(){
      // Carga inicial desde localStorage
      const storedPlayers = safeJSON(localStorage.getItem(STORAGE_KEYS.players), null);
      const initialPlayers = withGlobals(Array.isArray(storedPlayers) && storedPlayers.length ? storedPlayers : SEED_JUGADORES);

      const [players, setPlayers] = useState(initialPlayers);
      const [selected, setSelected] = useState(()=> new Set(safeJSON(localStorage.getItem(STORAGE_KEYS.selected), [])));
      const [teams, setTeams] = useState(()=> safeJSON(localStorage.getItem(STORAGE_KEYS.teams), null));
      const [kChemUI, setKChemUI] = useState(()=> Number(localStorage.getItem(STORAGE_KEYS.kchem) ?? K_CHEM));

      const map = useMemo(()=> Object.fromEntries(players.map(p=>[p.id,p])), [players]);
      const chem = useMemo(()=> buildChemistry(players), [players]);

      const [tab, setTab] = useState('partido');
      const [modalPlayer, setModalPlayer] = useState(null);
      const [showForm, setShowForm] = useState(null); // null | jugador
      const [showSettings, setShowSettings] = useState(false);

      // Bot√≥n de instalar universal (Android muestra prompt, iOS muestra instrucciones)
      const [deferredPrompt, setDeferredPrompt] = useState(null);
      const [showInstallInfo, setShowInstallInfo] = useState(false);
      const [swReady, setSwReady] = useState(false);
      const [hasManifest, setHasManifest] = useState(false);

      useEffect(()=>{
        const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
        window.addEventListener('beforeinstallprompt', handler);
        if (navigator.serviceWorker?.getRegistration) {
          navigator.serviceWorker.getRegistration().then(r => setSwReady(!!r));
        }
        setHasManifest(!!document.querySelector('link[rel="manifest"][href]'));
        return () => window.removeEventListener('beforeinstallprompt', handler);
      },[]);

      // Persistencia
      useEffect(()=>{ localStorage.setItem(STORAGE_KEYS.players, JSON.stringify(players)); },[players]);
      useEffect(()=>{ localStorage.setItem(STORAGE_KEYS.selected, JSON.stringify(Array.from(selected))); },[selected]);
      useEffect(()=>{ localStorage.setItem(STORAGE_KEYS.teams, JSON.stringify(teams)); },[teams]);
      useEffect(()=>{ localStorage.setItem(STORAGE_KEYS.kchem, String(kChemUI)); },[kChemUI]);

      const convocados = Array.from(selected);
      const canMake = convocados.length === 10;
      const toggleSelect = (id) => setSelected(prev => { const n=new Set(prev); n.has(id)?n.delete(id):n.add(id); return n; });
      const makeRandom   = () => { if (!canMake) return; const [A,B] = randomSplit(convocados); setTeams({A,B}); };
      const makeBalanced = () => { if (!canMake) return; const {A,B} = balancedSplit(convocados,map,chem,kChemUI); setTeams({A,B}); };

      useEffect(()=>{ runDevTests(players, map, chem); },[players, map, chem]);

      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isAndroid = /android/i.test(navigator.userAgent);

      const onInstallClick = async () => {
        if (deferredPrompt) {
          try { await deferredPrompt.prompt(); await deferredPrompt.userChoice; } catch {} finally { setDeferredPrompt(null); }
        } else {
          setShowInstallInfo(true);
        }
      };

      // CRUD Jugadores
      const onAddPlayer = () => setShowForm({});
      const onEditPlayer = (p) => setShowForm(p);
      const onSavePlayer = (data) => {
        if (showForm && showForm.id) {
          // editar
          setPlayers(prev => withGlobals(prev.map(x=> x.id===showForm.id? {...x, ...data}: x)));
        } else {
          // crear
          const id = String(Date.now());
          setPlayers(prev => withGlobals([...prev, { id, ...data }]));
        }
        setShowForm(null);
      };
      const onDeletePlayer = (id) => {
        setPlayers(prev => prev.filter(p=>p.id!==id));
        setSelected(prev => { const n=new Set(prev); n.delete(id); return n; });
        setTeams(prev => prev? { A: prev.A.filter(x=>x!==id), B: prev.B.filter(x=>x!==id) } : prev);
      };

      // Export/Import
      const onExport = () => {
        const payload = { players, selected: Array.from(selected), teams, kChemUI };
        const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='futbol5_plantel.json'; a.click(); URL.revokeObjectURL(url);
      };
      const onImport = (e) => {
        const f=e.target.files?.[0]; if(!f) return; const rd=new FileReader();
        rd.onload=()=>{ try{ const data=JSON.parse(rd.result); if(Array.isArray(data.players)){ setPlayers(withGlobals(data.players)); } if(Array.isArray(data.selected)){ setSelected(new Set(data.selected)); } if(data.teams && data.teams.A && data.teams.B){ setTeams(data.teams); } if(typeof data.kChemUI==='number'){ setKChemUI(data.kChemUI); } } catch(err){ alert('JSON inv√°lido'); } };
        rd.readAsText(f);
      };
      const onResetSeed = () => { setPlayers(withGlobals(SEED_JUGADORES)); setSelected(new Set()); setTeams(null); setKChemUI(K_CHEM); };

      return (
        <div className="mx-auto max-w-screen-md p-3 text-slate-100">
          <header className="sticky top-0 z-10 mb-3 rounded-xl bg-slate-950/90 p-3 ring-1 ring-slate-800 backdrop-blur">
            <div className="flex items-center justify-between gap-2">
              <h1 className="text-lg font-bold">F√∫tbol 5 - Generador</h1>
              <div className="flex items-center gap-2">
                <div className={`rounded-xl px-3 py-1 text-sm ring-1 ${convocados.length<10?'bg-amber-600/20 text-amber-200 ring-amber-500/40': convocados.length>10?'bg-rose-600/20 text-rose-200 ring-rose-500/40':'bg-emerald-600/20 text-emerald-200 ring-emerald-500/40'}`}>
                  Convocados: {convocados.length}/10
                </div>
                <button onClick={()=>setShowSettings(true)} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">‚öôÔ∏è</button>
              </div>
            </div>
            <nav className="mt-2 grid grid-cols-2 gap-2">
              <button onClick={()=>setTab('partido')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='partido'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>‚öΩ Partido</button>
              <button onClick={()=>setTab('plantel')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='plantel'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>üë• Plantel</button>
            </nav>
            {tab==='partido' && teams && (
              <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800"><div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TEAM_COLORS.A.dotClass}`} />Equipo A</div><TeamMiniSummary ids={teams.A} map={map} chem={chem} kChem={kChemUI}/></div>
                <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800"><div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TEAM_COLORS.B.dotClass}`} />Equipo B</div><TeamMiniSummary ids={teams.B} map={map} chem={chem} kChem={kChemUI}/></div>
              </div>
            )}
          </header>

          {tab==='plantel' ? (
            <section className="space-y-2">
              <div className="mb-2 flex items-center gap-2">
                <button onClick={onAddPlayer} className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">+ A√±adir jugador</button>
                <button onClick={()=>{ setSelected(new Set()); setTeams(null); }} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Limpiar convocados</button>
              </div>
              {players.map(p => (
                <div key={p.id} className="space-y-2">
                  <PlayerRow p={p} selected={selected.has(p.id)} onToggle={()=>toggleSelect(p.id)} onOpen={()=>setModalPlayer(p)} />
                  <div className="-mt-2 mb-2 flex gap-2 pl-14">
                    <button onClick={()=>onEditPlayer(p)} className="rounded-xl bg-slate-800 px-2 py-1 text-xs ring-1 ring-slate-700 hover:bg-slate-700">Editar</button>
                    <button onClick={()=>onDeletePlayer(p.id)} className="rounded-xl bg-rose-700 px-2 py-1 text-xs text-white ring-1 ring-rose-500 hover:bg-rose-600">Borrar</button>
                  </div>
                </div>
              ))}
            </section>
          ) : (
            <section className="space-y-3">
              {!canMake && (
                <div className="rounded-xl bg-amber-600/15 p-3 text-amber-100 ring-1 ring-amber-600/30">
                  Necesit√°s exactamente 10 convocados. Elegilos en la pesta√±a <span className="font-semibold">Plantel</span>.
                </div>
              )}

              {teams && (
                <>
                  <TeamCard title="Equipo A" teamKey="A" ids={teams.A} map={map} chem={chem} onOpenPlayer={(p)=>setModalPlayer(p)} kChem={kChemUI} />
                  <TeamCard title="Equipo B" teamKey="B" ids={teams.B} map={map} chem={chem} onOpenPlayer={(p)=>setModalPlayer(p)} kChem={kChemUI} />

                  <BalanceIndicator A={teams.A} B={teams.B} map={map} chem={chem} kChem={kChemUI} />

                  <TeamRadarCompare A={teams.A} B={teams.B} map={map} />
                  <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
                    <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                      <div className="mb-2 font-semibold">Barras - Equipo A (promedios)</div>
                      <BarsChart values={teamAverages(teams.A, map)} accent={TEAM_COLORS.A.hex} />
                    </div>
                    <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                      <div className="mb-2 font-semibold">Barras - Equipo B (promedios)</div>
                      <BarsChart values={teamAverages(teams.B, map)} accent={TEAM_COLORS.B.hex} />
                    </div>
                  </div>
                </>
              )}
            </section>
          )}

          {tab==='partido' && (
            <div className="sticky bottom-2 mt-4 grid grid-cols-2 gap-2">
              <button onClick={makeRandom} disabled={!canMake} className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${canMake?'bg-slate-800 text-slate-100 ring-slate-700 hover:bg-slate-700':'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed'}`}>üé≤ Azar</button>
              <button onClick={makeBalanced} disabled={!canMake} className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${canMake?'bg-emerald-600 text-white ring-emerald-500 hover:bg-emerald-500':'bg-emerald-600/40 text-emerald-200 ring-emerald-800 cursor-not-allowed'}`}>‚öñÔ∏è Equilibrado</button>
            </div>
