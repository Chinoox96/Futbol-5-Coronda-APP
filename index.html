<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>F5C</title>
  <meta name="theme-color" content="#0f172a"/>
  <link id="mf" rel="manifest"/>

  <!-- Tailwind + React + Babel -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Export/Share -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bp: 0px;
      --pitch-image: var(--pitch-image-mobile);
      --pitch-image-mobile: url('assets/cesped-vert.webp');
      --pitch-image-desktop: var(--pitch-image-mobile);
      --pitch-darken: 0.50;
      --parallax-speed: 0.30;
      --header-h: 138px;
      --grad-left: #0b2f58;   /* azul */
      --grad-mid:  #0c4b34;   /* verde */
      --grad-right:#5f1320;   /* rojo */
    }
    html,body{margin:0;overflow-x:hidden;background:#0b1220;color:#e2e8f0}
    img,svg{max-width:100%;height:auto}

    /* Fondo: parallax + degradado bandera de Coronda */
    #bg-parallax{position:fixed;inset:0;z-index:0;
      background-image:
        linear-gradient(90deg, var(--grad-left) 0%, var(--grad-mid) 50%, var(--grad-right) 100%),
        linear-gradient(rgba(11,18,32,var(--pitch-darken)),rgba(11,18,32,var(--pitch-darken))),
        var(--pitch-image);
      background-repeat:no-repeat,no-repeat,repeat-y;
      background-size:cover,100% 100%,100% auto;
      background-position:center center,center var(--bp),center var(--bp);
      will-change:background-position}
    @media (min-width:1024px){
      :root{--parallax-speed:0}
      #bg-parallax{background-repeat:no-repeat,no-repeat,no-repeat;background-size:cover,100% 100%,cover;background-position:center center,center center,center center}
    }
    #root{position:relative;z-index:1}

    /* Header (sticky) con textura */
    .app-header{position:sticky;top:0;left:0;right:0;z-index:40;backdrop-filter:blur(10px);
      background:rgba(2,6,23,.92);border-bottom:1px solid rgba(30,41,59,.6)}
    .hdr-inner{max-width:1100px;margin:0 auto;padding:12px 12px 0 12px;
      background-image:url('assets/texture.png');background-repeat:repeat;background-size:auto}
    .brand{font-style:italic;letter-spacing:.5px}
    .tabs-nav{display:flex;gap:6px;justify-content:center;margin-top:8px}
    .tab-btn{flex:1;max-width:520px;padding:12px 16px;font-size:16px;font-weight:800;border-radius:12px 12px 0 0;background:#1e293b;color:#94a3b8}
    .tab-btn.active{background:#0f172a;color:#fff;border-bottom:3px solid #22d3ee}
    .pill-conv{display:inline-block;background:rgba(148,163,184,.18);border:1px solid rgba(148,163,184,.28);padding:4px 10px;border-radius:999px}

    /* Tabs carrusel + swipe */
    .tabs-viewport{overflow:hidden}
    .tabs-track{display:flex;width:200%;transition:transform .32s cubic-bezier(.22,.7,.12,1);touch-action:pan-y}
    .tabs-page{width:100%;padding:12px}

    /* Listado scroll real solo en la pestaña Plantel */
    .plantel-scroll{max-height:calc(100vh - var(--header-h) - 110px);overflow-y:auto;padding:0 .5rem}

    /* Modales */
    .modal-scroll{max-height:80vh;overflow-y:auto}

    /* Install pill */
    .install-pill{position:fixed;right:12px;bottom:12px;z-index:50}

    /* Cards fifa */
    .card-rect{position:relative;border-radius:16px;padding:8px;overflow:hidden}
    .card-inner{position:relative;z-index:2}
    .rarity-bronze{background:linear-gradient(180deg,#d3a076,#7a5438)}
    .rarity-silver{background:linear-gradient(180deg,#e5e7eb,#9ca3af)}
    .rarity-gold{background:linear-gradient(180deg,#fde68a,#d97706)}
    .rarity-special{background:transparent}
    .rarity-special::before{content:"";position:absolute;inset:-2px;border-radius:18px;background:conic-gradient(from 0deg,#22d3ee,#a78bfa,#f472b6,#22d3ee);animation:spin 6s linear infinite;filter:saturate(1.2) brightness(1.05);z-index:1}
    .rarity-special::after{content:"";position:absolute;inset:2px;border-radius:14px;background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(30,41,59,.85));z-index:1}
    @keyframes spin{to{transform:rotate(1turn)}}

    /* Cancha */
    .board{position:relative;width:100%;max-width:900px;aspect-ratio:5/3;border-radius:16px;overflow:hidden}
    .board img.field{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .board .layer{position:absolute;inset:0}
  </style>
</head>
<body>
  <div id="bg-parallax" aria-hidden="true"></div>
  <div id="root"></div>

  <!-- Manifest dinámico (con fallback a dataURL si faltan iconos) -->
  <script>
    (async()=>{
      try{
        const base = location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const L=document.getElementById('mf');
        const mk=(n,c)=>{const a=document.createElement('canvas');a.width=a.height=n;const x=a.getContext('2d');
          x.fillStyle=c;x.fillRect(0,0,n,n);x.fillStyle='#0b1220';x.textAlign='center';x.textBaseline='middle';
          x.font=`${Math.floor(n*.42)}px system-ui,Segoe UI,Roboto,sans-serif`;x.fillText('F5',n/2,n/2);return a.toDataURL('image/png')};
        const man={name:'F5C',short_name:'F5C',start_url:base,scope:base,display:'standalone',
          background_color:'#0f172a',theme_color:'#10b981',
          icons:[{src:`${base}icons/icon-192.png`,sizes:'192x192',type:'image/png'},
                 {src:`${base}icons/icon-512.png`,sizes:'512x512',type:'image/png'}]};
        try{
          const r1=await fetch(`${base}icons/icon-192.png`,{method:'HEAD'});
          const r2=await fetch(`${base}icons/icon-512.png`,{method:'HEAD'});
          if(!r1.ok||!r2.ok) throw 0;
        }catch{
          man.icons=[{src:mk(192,'#10b981'),sizes:'192x192',type:'image/png'},
                     {src:mk(512,'#10b981'),sizes:'512x512',type:'image/png'}];
        }
        const b=new Blob([JSON.stringify(man)],{type:'application/manifest+json'});
        L.href=URL.createObjectURL(b);
      }catch(e){console.log('[PWA manifest]',e)}
    })();
  </script>

  <!-- Fondo responsive + parallax -->
  <script>
    (function(){
      try{
        const base=location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const m=base+'assets/cesped-vert.webp';
        const d=base+'assets/cesped-horiz.webp';
        document.documentElement.style.setProperty('--pitch-image-mobile',`url('${m}')`);
        function setDesk(v){document.documentElement.style.setProperty('--pitch-image-desktop',v);apply()}
        fetch(d,{method:'HEAD'}).then(r=>setDesk((r&&r.ok)?`url('${d}')`:'var(--pitch-image-mobile)')).catch(()=>setDesk('var(--pitch-image-mobile)'));
        function apply(){
          const isDesk=window.matchMedia('(min-width:1024px)').matches;
          const img=isDesk?'var(--pitch-image-desktop)':'var(--pitch-image-mobile)';
          document.documentElement.style.setProperty('--pitch-image',img)
        }
        window.addEventListener('resize',apply);apply();
      }catch(e){}
    })();
    (function(){
      let ticking=false;
      function sp(){const v=getComputedStyle(document.documentElement).getPropertyValue('--parallax-speed');const n=parseFloat(v);return isNaN(n)?0:n}
      function onScroll(){if(ticking)return; ticking=true; requestAnimationFrame(()=>{document.documentElement.style.setProperty('--bp',(-window.scrollY*sp())+'px'); ticking=false})}
      window.addEventListener('scroll',onScroll,{passive:true}); window.addEventListener('resize',onScroll); onScroll();
    })();
  </script>

  <!-- Registrar service worker (asegurate de tener /sw.js en raíz del repo) -->
  <script>
    if('serviceWorker' in navigator){
      window.addEventListener('load',()=>{
        navigator.serviceWorker.register('./sw.js').catch(()=>{});
      });
    }
  </script>

  <!-- === APP === -->
  <script type="text/babel">
    const {useMemo,useState,useEffect,useRef} = React;

    /* ========= Constantes/Helpers ========= */
    const STAT=['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
    const SL={ATA:'Ataque',PAS:'Pase',REG:'Regate',VEL:'Velocidad',DEF:'Defensa',FIS:'Físico',ARQ:'Arco',EQP:'Equipo'};
    const Wt={ATA:.18,DEF:.16,PAS:.14,REG:.14,VEL:.14,FIS:.10,ARQ:.07,EQP:.07};
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const avg=a=>a.length?a.reduce((p,c)=>p+c,0)/a.length:0;
    const globalOf=p=>{let s=0,w=0;for(const k in Wt){s+=(p[k]||0)*Wt[k];w+=Wt[k]}return +(s/w).toFixed(2)};
    const J=(s,d)=>{try{return JSON.parse(s)}catch{return d}};
    const withG=a=>a.map(p=>({...p,_GLOBAL:globalOf(p)}));
    const rarityOf=p=>{const r=Math.round((p._GLOBAL||globalOf(p))*10);if(p.especial||r>=90)return 'special';if(r>=80)return 'gold';if(r>=70)return 'silver';return 'bronze'};

    const SUBS={ATA:['Posición','Definición','Potencia'], PAS:['Visión','Corto','Largo'], REG:['Agilidad','Control','Equilibrio'],
      VEL:['Aceleración','Punta','Arranque'], DEF:['Marcaje','Anticipación','Entradas'], FIS:['Resistencia','Fuerza','Salto'],
      ARQ:['Reflejos','Manos','Saque'], EQP:['Colaboración','Disciplina','Liderazgo']};

    const roleOfPos = (pos='')=>{
      const P=(pos||'').toUpperCase();
      if(P.includes('AR')) return 'Arquero';
      if(P.includes('DF')||P.includes('TI')||P.includes('CB')) return 'Defensa';
      if(P.includes('MC')||P.includes('MU')||P.includes('MD')||P.includes('MI')) return 'Medio';
      if(P.includes('LA')||P.includes('DC')||P.includes('DL')||P.includes('ST')) return 'Delantero';
      return 'Jugador';
    };

    /* color/avatars sin CORS */
    const colorOf = name=>{
      const colors=['#22c55e','#06b6d4','#a78bfa','#f59e0b','#ef4444','#14b8a6','#8b5cf6','#f97316','#10b981','#38bdf8'];
      let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0;
      return colors[h%colors.length];
    };
    const mkAvatar = (name)=>{
      const initials=(name||'F5').split(/\s+/).map(s=>s[0]||'').join('').slice(0,2).toUpperCase();
      const bg=colorOf(name||'F5');
      const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'><rect width='100%' height='100%' rx='24' ry='24' fill='${bg}'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,sans-serif' font-size='72' fill='white' style='font-style:italic;font-weight:800;letter-spacing:1px'>${initials}</text></svg>`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
    };

    /* ========= Seed ========= */
    const SEED=[
      {id:'1',nombre:'Leo',ATA:10,PAS:9,REG:10,VEL:9,DEF:4,FIS:7,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5,especial:true,bandera:'🇦🇷',pos:'LA'},
      {id:'2',nombre:'Fabi',ATA:7,PAS:8,REG:7,VEL:7,DEF:7,FIS:7,ARQ:4,EQP:9,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'MU'},
      {id:'3',nombre:'Cuti',ATA:5,PAS:6,REG:5,VEL:7,DEF:10,FIS:9,ARQ:4,EQP:7,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'DF'},
      {id:'4',nombre:'Dibu',ATA:3,PAS:5,REG:4,VEL:5,DEF:8,FIS:8,ARQ:10,EQP:7,pie:'Derecho',estrellas:5,bandera:'🇦🇷',pos:'AR'},
      {id:'5',nombre:'Papu',ATA:8,PAS:8,REG:9,VEL:8,DEF:5,FIS:6,ARQ:3,EQP:7,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'LA'},
      {id:'6',nombre:'Nico',ATA:7,PAS:7,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'LA'},
      {id:'7',nombre:'Chino',ATA:5,PAS:6,REG:5,VEL:6,DEF:8,FIS:7,ARQ:8,EQP:6,pie:'Izquierdo',estrellas:3,bandera:'🇦🇷',pos:'AR'},
      {id:'8',nombre:'Joa',ATA:6,PAS:6,REG:6,VEL:7,DEF:8,FIS:8,ARQ:5,EQP:7,pie:'Derecho',estrellas:3,bandera:'🇦🇷',pos:'DF'},
      {id:'9',nombre:'Fideo',ATA:8,PAS:9,REG:9,VEL:8,DEF:6,FIS:6,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5,bandera:'🇦🇷',pos:'LA'},
      {id:'10',nombre:'Kuni',ATA:9,PAS:7,REG:8,VEL:9,DEF:5,FIS:7,ARQ:3,EQP:7,pie:'Derecho',estrellas:4,bandera:'🇦🇷',pos:'DC'},
      {id:'11',nombre:'Tomi',ATA:6,PAS:7,REG:6,VEL:7,DEF:7,FIS:7,ARQ:5,EQP:6,pie:'Derecho',estrellas:3,bandera:'🇦🇷',pos:'MC'},
      {id:'12',nombre:'Gonza',ATA:7,PAS:6,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:3,bandera:'🇦🇷',pos:'DF'},
    ].map(p=>({fotoUrl:mkAvatar(p.nombre),...p,_GLOBAL:0}));
    SEED.forEach(p=>p._GLOBAL=globalOf(p));

    /* ========= Química / Emparejado ========= */
    const chemBuildBase=arr=>{const q={};for(const a of arr){q[a.id]={};for(const b of arr){
      if(a.id===b.id){q[a.id][b.id]=10;continue}
      if(q[b.id]?.[a.id]!=null){q[a.id][b.id]=q[b.id][a.id];continue}
      let v=5;if(a.equipoPropio&&b.equipoPropio&&a.equipoPropio===b.equipoPropio)v+=1.2;
      if(a.equipoFavorito&&b.equipoFavorito&&a.equipoFavorito===b.equipoFavorito)v+=.8;
      v+=(((a.EQP+b.EQP)/2)-5)*.15;q[a.id][b.id]=clamp(+v.toFixed(2),1,10)}}return q};
    const applyOverrides=(base,ov)=>{if(!ov)return base;const q=JSON.parse(JSON.stringify(base));for(const a in ov){for(const b in ov[a]){const v=clamp(+ov[a][b],1,10);if(!q[a])q[a]={};if(!q[b])q[b]={};q[a][b]=q[b][a]=v}}return q};
    const chemTeam=(ids,chem)=>{const arr=Array.isArray(ids)?ids.filter(Boolean):[];if(arr.length<=1)return 10;let t=0,p=0;for(let i=0;i<arr.length;i++)for(let j=i+1;j<arr.length;j++){t+=chem[arr[i]]?.[arr[j]]??5;p++}return +(t/(p||1)).toFixed(2)};
    const teamGlobalIds=(ids,map)=>{const arr=Array.isArray(ids)?ids.filter(id=>map[id]):[];return +avg(arr.map(id=>map[id]._GLOBAL)).toFixed(2)};

    /* ========= helpers UI ========= */
    const colorMetric=(v,isChem=false)=>{
      const n=v;
      if(!isChem){
        if(n>=90) return 'text-emerald-400';
        if(n>=80) return 'text-emerald-300';
        if(n>=70) return 'text-amber-300';
        if(n>=60) return 'text-amber-400';
        return 'text-rose-300';
      }else{
        if(n>=9) return 'text-emerald-400';
        if(n>=8) return 'text-emerald-300';
        if(n>=7) return 'text-amber-300';
        if(n>=6) return 'text-amber-400';
        return 'text-rose-300';
      }
    };
    const shuffle=a=>{const x=[...a];for(let i=x.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[x[i],x[j]]=[x[j],x[i]]}return x};
    const diffScore=(A,B,map,chem,k)=>Math.abs((teamGlobalIds(A,map)*10+chemTeam(A,chem)*k)-(teamGlobalIds(B,map)*10+chemTeam(B,chem)*k));
    const seedWithPins=(ids,pA,pB)=>{const A=ids.filter(id=>pA.has(id));const B=ids.filter(id=>pB.has(id));const rest=ids.filter(id=>!pA.has(id)&&!pB.has(id));return{A,B,rest}};
    const fillRandom=(A,B,rest)=>{const r=shuffle(rest);for(const id of r){(A.length<B.length?A:B).push(id);if(A.length===5&&B.length===5)break}};
    const makeBalancedPins=(ids,map,chem,k,pA,pB)=>{
      const{A,B,rest}=seedWithPins(ids,pA,pB);fillRandom(A,B,rest);
      while((A.length<5||B.length<5)&&rest.length>0){const id=rest.pop();(A.length<B.length?A:B).push(id)}
      let best={A:[...A],B:[...B],d:diffScore(A,B,map,chem,k)};
      const freeA=best.A.map((id,i)=>pA.has(id)?-1:i).filter(i=>i>=0);
      const freeB=best.B.map((id,i)=>pB.has(id)?-1:i).filter(i=>i>=0);
      for(let t=0;t<900;t++){if(!freeA.length||!freeB.length)break;const i=freeA[(Math.random()*freeA.length)|0];const j=freeB[(Math.random()*freeB.length)|0];
        [best.A[i],best.B[j]]=[best.B[j],best.A[i]];const d=diffScore(best.A,best.B,map,chem,k);if(d<=best.d||Math.random()<.12){best.d=d}else{[best.A[i],best.B[j]]=[best.B[j],best.A[i]]}}
      return best;
    };

    /* ====== Components ====== */
    const TeamMetric = ({label,value,fmt='int',isChem=false})=>{
      const tcls=colorMetric(value,isChem);
      const show = fmt==='int' ? Math.round(value) : (+value).toFixed(2);
      return (
        <div className="flex items-center justify-between bg-slate-900/70 rounded-xl px-3 py-2 ring-1 ring-slate-700">
          <span className="text-slate-300">{label}</span>
          <span className={`font-extrabold text-lg ${tcls}`}>{show}</span>
        </div>
      );
    };

    const PlayerRow=({p,onClick,team,idx,onDragStart,onDragOver,onDrop})=>(
      <div
        className="flex items-center justify-between bg-slate-900/80 p-2 rounded-xl ring-1 ring-slate-700 mb-1"
        draggable
        onDragStart={e=>onDragStart(e,team,idx)}
        onDragOver={e=>onDragOver(e,team,idx)}
        onDrop={e=>onDrop(e,team,idx)}
      >
        <button onClick={onClick} className="truncate text-left">
          <span className="font-semibold">{p.nombre}</span> <span className="opacity-80">{p.bandera||''}</span>
        </button>
        <span className="font-bold">{Math.round((p._GLOBAL||globalOf(p))*10)}</span>
      </div>
    );

    const RadarChart=({size=260,max=10,keys=STAT,dataSeries})=>{
      const cx=size/2,cy=size/2,r=size*.4,N=keys.length;
      const ang=i=>Math.PI*2*i/N-Math.PI/2;
      const pt=(i,v)=>{const a=ang(i),rr=r*(v/max);return[cx+rr*Math.cos(a),cy+rr*Math.sin(a)]};
      const lv=[2,4,6,8,10];
      return(<svg viewBox={`0 0 ${size} ${size}`} width="100%" className="mx-auto block">
        {lv.map((L,i)=>{const d=keys.map((_,j)=>pt(j,L)).map(([x,y])=>`${x},${y}`).join(' ');return <polygon key={i} points={d} fill="none" stroke="rgba(148,163,184,.25)" strokeWidth={1}/>})}
        {keys.map((k,i)=>{const[x,y]=pt(i,max);return <line key={k} x1={cx} y1={cy} x2={x} y2={y} stroke="rgba(148,163,184,.3)" strokeWidth={1}/>})}
        {keys.map((k,i)=>{const[x,y]=pt(i,max+.9);return <text key={k} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize={11} fill="#cbd5e1">{k}</text>})}
        {dataSeries.map((srs,i)=>{const d=keys.map((k,j)=>pt(j,srs.values[k]??0)).map(([x,y])=>`${x},${y}`).join(' ');return(<g key={i}><polygon points={d} fill={srs.fill} stroke={srs.stroke} strokeWidth={2}/></g>)})}
      </svg>);
    };
    const TC={A:{stroke:'rgba(16,185,129,1)',fill:'rgba(16,185,129,0.18)',dot:'bg-emerald-500'},B:{stroke:'rgba(59,130,246,1)',fill:'rgba(59,130,246,0.18)',dot:'bg-blue-500'}};

    const BarsCompare=({aVals,bVals})=>(
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {[['A',aVals,'#10b981'],['B',bVals,'#3b82f6']].map(([lbl,val,color])=>(
          <div key={lbl} className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
            <div className="mb-2 text-sm font-semibold text-slate-300">Promedios {lbl}</div>
            {STAT.map(k=>(
              <div key={k} className="mb-2">
                <div className="flex justify-between text-sm"><span className="text-slate-300">{k}</span><span className="font-semibold">{val[k].toFixed(2)}</span></div>
                <div className="h-2 w-full rounded bg-slate-700"><div className="h-2 rounded" style={{width:`${Math.max(0,Math.min(100,(val[k]/10)*100))}%`,backgroundColor:color}}/></div>
              </div>
            ))}
          </div>
        ))}
      </div>
    );

    const FifaCard=({p})=>{
      const rate=Math.round((p._GLOBAL||globalOf(p))*10);
      const rare=rarityOf(p);
      const ring = rare==='bronze'?'ring-yellow-800':rare==='silver'?'ring-slate-300':rare==='gold'?'ring-yellow-500':'ring-cyan-300';
      const rareClass = rare==='special' ? 'rarity-special' : `rarity-${rare}`;
      return (
        <div className={`card-rect w-44 ${rareClass} text-slate-900 ring-1 ${ring} shadow`}>
          <div className="card-inner">
            <div className="flex justify-between items-start">
              <div className="text-center leading-4">
                <div className="text-3xl font-black">{rate}</div>
                <div className="text-xs font-bold">{p.pos||'F5'}</div>
                <div className="text-base">{p.bandera||''}</div>
              </div>
              <div className="text-[10px] font-bold bg-white/70 rounded px-1 py-0.5 ring-1 ring-black/10">{roleOfPos(p.pos)}</div>
            </div>
            <div className="mt-2 grid place-items-center">
              <img src={p.fotoUrl} className="h-24 w-24 rounded-xl object-cover ring-2" alt={p.nombre}/>
            </div>
            <div className="mt-2 text-center text-sm font-extrabold">{p.nombre}</div>
            <div className="mt-1 grid grid-cols-2 gap-x-2 gap-y-1 text-[11px] font-semibold">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded-lg bg-white/30 px-2 py-1">
                  <span>{k}</span><span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const MiniCard=({p})=>{
      const rare=rarityOf(p);
      const ring = rare==='bronze'?'ring-yellow-800':rare==='silver'?'ring-slate-300':rare==='gold'?'ring-yellow-500':'ring-cyan-300';
      const rareClass = rare==='special' ? 'rarity-special' : `rarity-${rare}`;
      return (
        <div className={`card-rect ${rareClass} text-slate-900 ring-1 ${ring} shadow w-[104px]`}>
          <div className="card-inner">
            <div className="flex justify-between items-start">
              <div className="text-center leading-4">
                <div className="text-xl font-black">{Math.round((p._GLOBAL||globalOf(p))*10)}</div>
                <div className="text-[10px] font-bold">{p.pos||'F5'}</div>
              </div>
              <div className="h-6 w-6 grid place-items-center bg-white/70 text-[10px] font-extrabold ring-1 ring-black/10 rounded">F5</div>
            </div>
            <div className="mt-1 grid place-items-center">
              <img src={p.fotoUrl} className="h-16 w-16 rounded-lg object-cover ring-2" alt={p.nombre}/>
            </div>
            <div className="mt-1 text-center text-[11px] font-extrabold px-1 leading-tight">{p.nombre}</div>
          </div>
        </div>
      );
    };

    /* ===== Formación ===== */
    const POS_A=[{x:12,y:80},{x:28,y:62},{x:28,y:38},{x:50,y:50},{x:70,y:50}];
    const POS_B=POS_A.map(p=>({x:100-p.x,y:p.y}));

    const FormationBoard=({teamA,teamB,scale=0.50})=>{
      const ref=useRef(null);
      const isDesk=()=>window.matchMedia('(min-width:768px)').matches;
      const scaleLive=isDesk()?scale:Math.max(0.42,Math.min(scale,0.56));

      const makeCanvas=async()=>{
        const el=ref.current; if(!el) return;
        const canvas=await html2canvas(el,{backgroundColor:null,scale:2,useCORS:true,allowTaint:true});
        const url=canvas.toDataURL('image/png'); return {canvas,url};
      };
      const descargar=async()=>{const {url}=await makeCanvas(); const a=document.createElement('a');a.href=url;a.download='formacion_f5c.png';a.click();};
      const [copied,setCopied]=useState(false);
      const copiar=async()=>{
        try{
          const {canvas}=await makeCanvas();
          canvas.toBlob(async b=>{
            if(!b) return;
            await navigator.clipboard.write([new ClipboardItem({'image/png': b})]);
            setCopied(true); setTimeout(()=>setCopied(false),1500);
          });
        }catch{}
      };
      const compartir=async()=>{
        try{
          const {canvas}=await makeCanvas();
          const file=await new Promise(res=>canvas.toBlob(b=>res(new File([b],'formacion_f5c.png',{type:'image/png'})),'image/png'));
          if(navigator.canShare && navigator.canShare({files:[file]})){
            await navigator.share({title:'Formación F5C',files:[file],text:'Formación del partido'});
          }
        }catch(e){}
      };

      return(
        <div className="w-full">
          <div className="text-center mb-2 font-bold">Formación F5C</div>
          <div ref={ref} className="board ring-1 ring-slate-700 shadow-xl mx-auto bg-slate-900/30 relative">
            <img src="assets/cancha.png" alt="Cancha" className="field"/>
            <div className="layer">
              {teamA.map((p,i)=>{const pos=POS_A[i]||POS_A[POS_A.length-1];return(
                <div key={'A'+p.id} className="absolute"
                  style={{left:`${pos.x}%`,top:`${pos.y}%`,transform:`translate(-50%,-50%) scale(${scaleLive})`,transformOrigin:'top left'}}>
                  <MiniCard p={p}/>
                </div>
              )})}
              {teamB.map((p,i)=>{const pos=POS_B[i]||POS_B[POS_B.length-1];return(
                <div key={'B'+p.id} className="absolute"
                  style={{left:`${pos.x}%`,top:`${pos.y}%`,transform:`translate(-50%,-50%) scale(${scaleLive})`,transformOrigin:'top left'}}>
                  <MiniCard p={p}/>
                </div>
              )})}
              <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-[12px] text-slate-200">Generado con F5C</div>
            </div>
          </div>

          <div className="flex flex-wrap justify-center gap-2 mt-3">
            <button onClick={descargar} className="rounded-xl bg-emerald-600 px-3 py-2 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">⬇️ Descargar</button>
            <button onClick={copiar} className={`rounded-xl px-3 py-2 text-sm ring-1 ${copied?'bg-emerald-700 text-white ring-emerald-500':'bg-slate-800 ring-slate-700 hover:bg-slate-700'}`}>{copied?'✅ Copiado':'📋 Copiar'}</button>
            <button onClick={compartir} className="rounded-xl bg-cyan-600 px-3 py-2 text-sm text-white ring-1 ring-cyan-500 hover:bg-cyan-500">📤 Compartir</button>
          </div>
        </div>
      );
    };

    /* ===== Modales ===== */
    const SettingsModal=({
      onClose,kChem,setKChem,listTwoCols,setListTwoCols,onOpenGlossary,onExport,onImport
    })=>{
      const input=useRef(null);
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/60 p-3" onClick={onClose}>
          <div className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
            <div className="mb-1 text-lg font-semibold">Ajustes</div>
            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Peso de Química en Score</div>
              <input type="range" min="0" max="1" step="0.05" value={kChem} onChange={e=>setKChem(+e.target.value)} className="w-full"/>
              <div className="text-xs text-slate-300 mt-1">k = {kChem.toFixed(2)}</div>
            </div>
            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Vista Partido</div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={listTwoCols} onChange={e=>setListTwoCols(e.target.checked)}/>
                <span>{listTwoCols? '2 columnas (A | B)': '1 columna (A debajo de B)'}</span>
              </label>
            </div>
            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-2">
              <div className="text-sm font-semibold">Importar / Exportar</div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onExport} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Exportar JSON</button>
                <button onClick={()=>input.current?.click()} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Importar JSON</button>
                <input ref={input} type="file" accept="application/json" className="hidden" onChange={onImport}/>
              </div>
            </div>
            <div className="flex items-center justify-between">
              <button onClick={onOpenGlossary} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">📘 Glosario</button>
              <button onClick={onClose} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
            </div>
          </div>
        </div>
      );
    };

    const GlossaryModal=({onClose})=>(
      <div className="fixed inset-0 z-50 grid place-items-center bg-black/60 p-3" onClick={onClose}>
        <div className="w-full max-w-3xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 text-sm modal-scroll" onClick={e=>e.stopPropagation()}>
          <div className="flex items-center justify-between">
            <div className="text-lg font-semibold">Glosario</div>
            <button onClick={onClose} className="rounded-lg bg-slate-800 px-2 py-1 ring-1 ring-slate-700">Cerrar</button>
          </div>
          <div className="space-y-3 leading-relaxed text-slate-200">
            <div><b>Rating (jugador)</b>: promedio ponderado de stats con pesos ATA(.18), DEF(.16), PAS(.14), REG(.14), VEL(.14), FIS(.10), ARQ(.07), EQP(.07).</div>
            <div><b>Stats (1–10)</b> y substats: ATA (Posición, Definición, Potencia), PAS (Visión, Corto, Largo), REG (Agilidad, Control, Equilibrio), VEL (Aceleración, Punta, Arranque), DEF (Marcaje, Anticipación, Entradas), FIS (Resistencia, Fuerza, Salto), ARQ (Reflejos, Manos, Saque), EQP (Colaboración, Disciplina, Liderazgo). Cada stat es el promedio de sus substats.</div>
            <div><b>Química (equipo)</b>: afinidad entre parejas (1–10). Sube por equipo propio/favorito compartido y por EQP.</div>
            <div><b>Rating (equipo)</b>: promedio de Ratings individuales (escala 100).</div>
            <div><b>Score</b>: <code>Score = Rating equipo + (Química × k)</code>, con <i>k</i> configurable en Ajustes.</div>
          </div>
        </div>
      </div>
    );

    const Gauge=({label,v})=>(<div className="mb-1"><div className="flex justify-between text-xs"><span>{label}</span><span className="font-semibold">{v}</span></div><div className="h-1.5 rounded bg-slate-700"><div className="h-1.5 rounded" style={{width:`${v*10}%`,backgroundColor:'#22c55e'}}/></div></div>);

    const PlayerDetails=({p,onClose,onEdit,onDelete})=>{
      const s=p.subs||(Object.fromEntries(STAT.map(k=>[k,(SUBS[k]||[]).map(n=>({n,v:p[k]}))])));
      return(
        <div className="fixed inset-0 bg-black/60 grid place-items-center z-50" onClick={onClose}>
          <div className="bg-slate-900 p-4 rounded-2xl w-11/12 max-w-3xl ring-1 ring-slate-700 modal-scroll" onClick={e=>e.stopPropagation()}>
            <div className="flex items-center justify-between mb-2">
              <h2 className="font-bold text-lg">{p.nombre}</h2>
              <div className="flex gap-2">
                <button onClick={onEdit} className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700">Editar</button>
                <button onClick={onDelete} className="rounded bg-rose-700 px-2 py-1 ring-1 ring-rose-500 text-white">Borrar</button>
                <button onClick={onClose} className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700">Cerrar</button>
              </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div className="flex justify-center"><FifaCard p={p}/></div>
              <div className="space-y-3">
                <div className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
                  <div className="mb-2 text-sm font-semibold">Radar</div>
                  <RadarChart size={240} dataSeries={[{label:p.nombre,values:p,stroke:'rgba(34,211,238,1)',fill:'rgba(34,211,238,0.18)'}]}/>
                </div>
                {STAT.map(k=>(
                  <div key={k} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
                    <div className="mb-1 text-sm font-semibold">{SL[k]} <span className="opacity-75">({p[k]})</span></div>
                    {(s[k]||[]).map((it,idx)=>(<Gauge key={idx} label={it.n} v={it.v}/>))}
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    };

    const PlayerForm=({initial,onCancel,onSave})=>{
      const base={nombre:'',bandera:'',pos:'',fotoUrl:'',ATA:5,PAS:5,REG:5,VEL:5,DEF:5,FIS:5,ARQ:5,EQP:5,subs:null};
      const [form,setForm]=useState(()=>{const f=initial?{...initial}:{...base}; if(!f.subs) f.subs=Object.fromEntries(STAT.map(k=>[k,(SUBS[k]||[]).map(n=>({n,v:5}))])); return f;});
      const set=(k,v)=>setForm(f=>({...f,[k]:v}));
      const onFile=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>set('fotoUrl',r.result);r.readAsDataURL(f)};
      const submit=e=>{
        e.preventDefault();
        const c={...form};
        STAT.forEach(k=>{ const arr=(c.subs?.[k]||[]).map(it=>clamp(+it.v||0,1,10)); c[k]=arr.length?clamp(Math.round(avg(arr)),1,10):clamp(parseInt(c[k]||0,10),1,10); });
        if(!c.nombre.trim()) return; if(!c.fotoUrl) c.fotoUrl=mkAvatar(c.nombre);
        c._GLOBAL=globalOf(c);
        onSave(c);
      };
      return(
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/60 p-3" onClick={onCancel}>
          <form className="w-full max-w-2xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 modal-scroll" onSubmit={submit} onClick={e=>e.stopPropagation()}>
            <div className="text-lg font-semibold">{initial?'Editar jugador':'Añadir jugador'}</div>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <label className="space-y-1 col-span-2"><span>Nombre</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.nombre} onChange={e=>set('nombre',e.target.value)} required/></label>
              <label className="space-y-1"><span>Bandera</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.bandera||''} onChange={e=>set('bandera',e.target.value)} placeholder="🇦🇷"/></label>
              <label className="space-y-1"><span>Posición</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.pos||''} onChange={e=>set('pos',e.target.value)} placeholder="AR, DF, MC, LA, DC..."/></label>
              <label className="space-y-1 col-span-2"><span>Foto URL</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.fotoUrl||''} onChange={e=>set('fotoUrl',e.target.value)} placeholder="https://... (o deja vacío)"/>
                <span className="text-xs opacity-80">o subir imagen</span>
                <input type="file" accept="image/*" onChange={onFile} className="w-full text-xs"/></label>
            </div>

            <div className="space-y-2">
              {STAT.map(k=>(
                <div key={k} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
                  <div className="mb-1 text-sm font-semibold">{SL[k]} <span className="opacity-60 text-xs">(se promedia en {k})</span> — <span className="opacity-80">Actual: {form[k]}</span></div>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    {(form.subs?.[k]||SUBS[k].map(n=>({n,v:5}))).map((it,idx)=>(
                      <label key={idx} className="space-y-1">
                        <span className="text-xs">{it.n}</span>
                        <input type="number" min="1" max="10" className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700"
                          value={it.v} onChange={e=>{
                            const v=clamp(parseInt(e.target.value||0,10),1,10);
                            setForm(f=>{
                              const subs={...(f.subs||{})};
                              const arr=[...((subs[k]||SUBS[k].map(n=>({n,v:5}))))];
                              arr[idx]={...arr[idx],v};
                              subs[k]=arr;
                              const gen=clamp(Math.round(avg(arr.map(x=>+x.v||0))),1,10);
                              return {...f,subs,[k]:gen};
                            });
                          }}/>
                      </label>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="flex justify-end gap-2">
              <button type="button" onClick={onCancel} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Cancelar</button>
              <button type="submit" className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">Guardar</button>
            </div>
          </form>
        </div>
      );
    };

    /* ========= APP ========= */
    const App=()=>{
      /* estado persistente */
      const storeP=J(localStorage.getItem('f5.players'),null);
      const initP=withG(Array.isArray(storeP)&&storeP.length?storeP:SEED);
      const[players,setPlayers]=useState(initP);

      /* equipos como ids para poder usar química */
      const map=useMemo(()=>Object.fromEntries(players.map(p=>[p.id,p])),[players]);
      const ids=players.map(p=>p.id);
      const[teamA,setTeamA]=useState(ids.slice(0,5));
      const[teamB,setTeamB]=useState(ids.slice(5,10));
      const[kChem,setKChem]=useState(()=>+(localStorage.getItem('f5.kchem')??0.6));
      const[listTwoCols,setListTwoCols]=useState(()=>{try{return JSON.parse(localStorage.getItem('f5.listTwoCols')??'true')}catch{return true}});
      const[tab,setTab]=useState('partido');
      const[selectedPlayer,setSelectedPlayer]=useState(null);
      const[formPlayer,setFormPlayer]=useState(null);
      const[settingsOpen,setSettingsOpen]=useState(false);
      const[glossaryOpen,setGlossaryOpen]=useState(false);
      const[pinA,setPinA]=useState(()=>new Set(J(localStorage.getItem('f5.pins.A'),[])));
      const[pinB,setPinB]=useState(()=>new Set(J(localStorage.getItem('f5.pins.B'),[])));
      const[chemOverrides,setChemOverrides]=useState(()=>J(localStorage.getItem('f5.chem.overrides'),{}));
      const chem=useMemo(()=>applyOverrides(chemBuildBase(players),chemOverrides),[players,chemOverrides]);

      useEffect(()=>localStorage.setItem('f5.players',JSON.stringify(players)),[players]);
      useEffect(()=>localStorage.setItem('f5.kchem',String(kChem)),[kChem]);
      useEffect(()=>localStorage.setItem('f5.listTwoCols',JSON.stringify(listTwoCols)),[listTwoCols]);
      useEffect(()=>localStorage.setItem('f5.pins.A',JSON.stringify([...pinA])),[pinA]);
      useEffect(()=>localStorage.setItem('f5.pins.B',JSON.stringify([...pinB])),[pinB]);
      useEffect(()=>localStorage.setItem('f5.chem.overrides',JSON.stringify(chemOverrides)),[chemOverrides]);

      /* instalar PWA */
      const [installPrompt,setInstallPrompt]=useState(null);
      useEffect(()=>{const onPrompt=(e)=>{e.preventDefault();setInstallPrompt(e)};window.addEventListener('beforeinstallprompt',onPrompt);return()=>window.removeEventListener('beforeinstallprompt',onPrompt)},[]);

      /* swipe tabs */
      const viewportRef=useRef(null);
      useEffect(()=>{
        const vp=viewportRef.current; if(!vp) return;
        let sx=0,dx=0,active=false;
        const ts=(e)=>{active=true; sx=e.touches[0].clientX; dx=0};
        const tm=(e)=>{if(!active)return; dx=e.touches[0].clientX-sx};
        const te=()=>{if(!active)return; if(dx>60) setTab('partido'); else if(dx<-60) setTab('plantel'); active=false};
        vp.addEventListener('touchstart',ts,{passive:true});
        vp.addEventListener('touchmove',tm,{passive:true});
        vp.addEventListener('touchend',te,{passive:true});
        return ()=>{vp.removeEventListener('touchstart',ts);vp.removeEventListener('touchmove',tm);vp.removeEventListener('touchend',te)};
      },[]);

      /* métricas */
      const arrA=teamA.map(id=>map[id]).filter(Boolean);
      const arrB=teamB.map(id=>map[id]).filter(Boolean);
      const ratingA=teamGlobalIds(teamA,map)*10;
      const ratingB=teamGlobalIds(teamB,map)*10;
      const chemA=chemTeam(teamA,chem);
      const chemB=chemTeam(teamB,chem);
      const scoreA=+(ratingA+chemA*kChem).toFixed(2);
      const scoreB=+(ratingB+chemB*kChem).toFixed(2);
      const diff = Math.abs(scoreA-scoreB);
      const balanceLbl = diff<0.30?'Parejo':(diff<0.80?'Aceptable':'Desbalanceado');
      const balanceCls = diff<0.30?'bg-emerald-600/15 text-emerald-200 ring-emerald-500/30':(diff<0.80?'bg-amber-600/15 text-amber-100 ring-amber-500/30':'bg-rose-600/15 text-rose-200 ring-rose-500/30');

      const avgVals = ids => {const o={}; STAT.forEach(k=>o[k]=+avg(ids.map(id=>map[id][k]||0)).toFixed(2)); return o};
      const aVals=avgVals(teamA), bVals=avgVals(teamB);

      /* drag & drop con intercambio en el slot de destino */
      const dragRef=useRef(null); // {team:'A'|'B', idx:number}
      const onDragStart=(e,team,idx)=>{dragRef.current={team,idx}};
      const onDragOver=(e,team,idx)=>{e.preventDefault()};
      const onDrop=(e,team,idx)=>{
        const src=dragRef.current; if(!src) return;
        const fromTeam = src.team, toTeam = team, fromIdx = src.idx, toIdx = idx;
        const swap = (list, i, j) => { const a=[...list]; const tmp=a[j]; a[j]=a[i]; return {a,tmp}; };

        if(fromTeam==='A' && toTeam==='A'){
          setTeamA(a=>{const na=[...a]; const t=na[toIdx]; na[toIdx]=na[fromIdx]; na[fromIdx]=t; return na;});
        }else if(fromTeam==='B' && toTeam==='B'){
          setTeamB(b=>{const nb=[...b]; const t=nb[toIdx]; nb[toIdx]=nb[fromIdx]; nb[fromIdx]=t; return nb;});
        }else if(fromTeam==='A' && toTeam==='B'){
          const dragged = teamA[fromIdx];
          setTeamA(a=>{const na=[...a]; na[fromIdx]=teamB[toIdx]; return na;});
          setTeamB(b=>{const nb=[...b]; nb[toIdx]=dragged; return nb;});
        }else if(fromTeam==='B' && toTeam==='A'){
          const dragged = teamB[fromIdx];
          setTeamB(b=>{const nb=[...b]; nb[fromIdx]=teamA[toIdx]; return nb;});
          setTeamA(a=>{const na=[...a]; na[toIdx]=dragged; return na;});
        }
        dragRef.current=null;
      };

      /* generar equipos */
      const makeRandom=()=>{
        const pool=players.map(p=>p.id); const s=shuffle(pool).slice(0,10);
        setTeamA(s.slice(0,5)); setTeamB(s.slice(5,10));
      };
      const makeBalanced=()=>{
        const pool=players.map(p=>p.id).slice(0,10);
        const {A,B}=makeBalancedPins(pool,map,chem,kChem,pinA,pinB);
        setTeamA(A); setTeamB(B);
      };

      /* export/import */
      const onExport=()=>{const payload={players,teamA,teamB,kChem,chemOverrides,pinA:[...pinA],pinB:[...pinB]};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='f5c_estado.json';a.click();URL.revokeObjectURL(url)};
      const onImport=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{
            const d=JSON.parse(r.result);
            if(Array.isArray(d.players))setPlayers(withG(d.players));
            if(Array.isArray(d.teamA))setTeamA(d.teamA);
            if(Array.isArray(d.teamB))setTeamB(d.teamB);
            if(typeof d.kChem==='number')setKChem(d.kChem);
            if(d.chemOverrides&&typeof d.chemOverrides==='object')setChemOverrides(d.chemOverrides);
            if(Array.isArray(d.pinA))setPinA(new Set(d.pinA));
            if(Array.isArray(d.pinB))setPinB(new Set(d.pinB));
          }catch{alert('JSON inválido')}};r.readAsText(f)};

      /* CRUD jugadores */
      const addPlayer=()=>setFormPlayer({});
      const savePlayer=(data)=>{
        if(data.id){
          setPlayers(ps=>withG(ps.map(x=>x.id===data.id?{...x,...data}:x)));
        }else{
          const id=String(Date.now());
          setPlayers(ps=>withG([...ps,{...data,id}]));
        }
        setFormPlayer(null);
      };
      const editPlayer=p=>setFormPlayer({...p});
      const deletePlayer=p=>{
        setPlayers(ps=>ps.filter(x=>x.id!==p.id));
        setTeamA(a=>a.filter(id=>id!==p.id));
        setTeamB(b=>b.filter(id=>id!==p.id));
        setSelectedPlayer(null);
      };

      /* install */
      const doInstall=async()=>{try{await installPrompt.prompt()}catch{}};

      /* tabs viewport (para swipe) */
      const trackStyle={transform:`translateX(${tab==='partido'?'0%':'-50%'})`};

      return (
        <div>
          <header className="app-header">
            <div className="hdr-inner">
              <div className="max-w-[1100px] mx-auto flex items-center justify-between">
                <div className="text-3xl font-extrabold brand" style={{lineHeight:'1'}}>
                  <span aria-hidden="true" className="align-middle mr-1">⚽</span> <span className="align-middle">F5C</span>
                </div>
                <button title="Ajustes" className="text-xl" onClick={()=>setSettingsOpen(true)}>⚙️</button>
              </div>
              <div className="tabs-nav">
                <button onClick={()=>setTab('partido')} className={`tab-btn ${tab==='partido'?'active':''}`}>Partido</button>
                <button onClick={()=>setTab('plantel')} className={`tab-btn ${tab==='plantel'?'active':''}`}>Plantel</button>
              </div>
              <div className="text-center mt-1">
                <span className="pill-conv">Convocados {teamA.length+teamB.length}/10</span>
              </div>
            </div>
          </header>

          <main className="max-w-[1100px] mx-auto">
            <div className="tabs-viewport" ref={viewportRef}>
              <div className="tabs-track" style={trackStyle}>
                {/* === PARTIDO === */}
                <section className="tabs-page space-y-3">
                  <div className="flex flex-wrap justify-center gap-3">
                    <button onClick={makeRandom} className="rounded-2xl bg-slate-800 px-4 py-2 text-white ring-1 ring-slate-700 hover:bg-slate-700 text-base font-bold">🎲 AL AZAR</button>
                    <button onClick={makeBalanced} className="rounded-2xl bg-emerald-600 px-4 py-2 text-white ring-1 ring-emerald-500 hover:bg-emerald-500 text-base font-bold">⚖️ EQUILIBRADO</button>
                  </div>

                  <div className={`grid ${listTwoCols?'md:grid-cols-2 gap-4':'grid-cols-1 gap-3'}`}>
                    {/* Columna A */}
                    <div className="space-y-2">
                      <div className="grid grid-cols-3 gap-2">
                        <TeamMetric label="Rating" value={ratingA}/>
                        <TeamMetric label="Química" value={chemA} isChem/>
                        <TeamMetric label="Score" value={scoreA}/>
                      </div>
                      <div className="rounded-2xl bg-slate-900/60 p-3 ring-1 ring-slate-700">
                        <div className="text-sm font-bold mb-2">Equipo A</div>
                        {teamA.map((id,idx)=>{const p=map[id];return(
                          <PlayerRow key={id} p={p} team="A" idx={idx}
                            onClick={()=>setSelectedPlayer(p)}
                            onDragStart={onDragStart}
                            onDragOver={onDragOver}
                            onDrop={onDrop}
                          />
                        )})}
                      </div>
                    </div>

                    {/* Columna B */}
                    <div className="space-y-2">
                      <div className="grid grid-cols-3 gap-2">
                        <TeamMetric label="Rating" value={ratingB}/>
                        <TeamMetric label="Química" value={chemB} isChem/>
                        <TeamMetric label="Score" value={scoreB}/>
                      </div>
                      <div className="rounded-2xl bg-slate-900/60 p-3 ring-1 ring-slate-700">
                        <div className="text-sm font-bold mb-2">Equipo B</div>
                        {teamB.map((id,idx)=>{const p=map[id];return(
                          <PlayerRow key={id} p={p} team="B" idx={idx}
                            onClick={()=>setSelectedPlayer(p)}
                            onDragStart={onDragStart}
                            onDragOver={onDragOver}
                            onDrop={onDrop}
                          />
                        )})}
                      </div>
                    </div>
                  </div>

                  <div className="text-center">
                    <label className="text-sm">
                      <input type="checkbox" checked={listTwoCols} onChange={e=>setListTwoCols(e.target.checked)} className="mr-2"/>
                      Vista 2 columnas
                    </label>
                  </div>

                  <div className={`rounded-2xl p-3 ring-1 ${balanceCls}`}>
                    <div className="flex items-center justify-between text-sm">
                      <div className="font-semibold">Balance del partido</div>
                      <div className="text-xs opacity-80">Diff: {diff.toFixed(2)}</div>
                    </div>
                    <div className="mt-1 text-sm">Resultado: <span className="font-semibold">{balanceLbl}</span> <span className="opacity-80">(A: {scoreA.toFixed(2)} vs B: {scoreB.toFixed(2)})</span></div>
                  </div>

                  <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                    <div className="mb-2 text-center text-sm text-slate-300">Radar comparativo (promedio por stat)</div>
                    <RadarChart dataSeries={[
                      {label:'A',values:aVals,stroke:TC.A.stroke,fill:TC.A.fill},
                      {label:'B',values:bVals,stroke:TC.B.stroke,fill:TC.B.fill}
                    ]}/>
                    <div className="mt-2 flex justify-center gap-4 text-xs text-slate-300">
                      <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TC.A.dot}`}></span> A</span>
                      <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TC.B.dot}`}></span> B</span>
                    </div>
                  </div>

                  <BarsCompare aVals={aVals} bVals={bVals}/>
                  <FormationBoard teamA={arrA} teamB={arrB}/>
                </section>

                {/* === PLANTEL === */}
                <section className="tabs-page space-y-2">
                  <div className="flex justify-end">
                    <button onClick={()=>setFormPlayer({})} className="rounded-xl bg-emerald-600 px-3 py-2 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">+ Añadir jugador</button>
                  </div>

                  <div className="plantel-scroll">
                    {players.map(p=>(
                      <div key={p.id} className="flex items-center justify-between bg-slate-900/70 p-2 rounded-xl ring-1 ring-slate-700 mb-2">
                        <button onClick={()=>setSelectedPlayer(p)} className="truncate text-left">
                          <span className="font-semibold">{p.nombre}</span> <span className="opacity-80">{p.bandera||''}</span>
                        </button>
                        <div className="flex items-center gap-2">
                          <span className="font-bold">{Math.round((p._GLOBAL||globalOf(p))*10)}</span>
                          <button onClick={()=>setFormPlayer(p)} className="text-xs rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700">Editar</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </section>
              </div>
            </div>
          </main>

          {selectedPlayer && <PlayerDetails
            p={selectedPlayer}
            onClose={()=>setSelectedPlayer(null)}
            onEdit={()=>{setFormPlayer(selectedPlayer);setSelectedPlayer(null)}}
            onDelete={()=>deletePlayer(selectedPlayer)}
          />}

          {formPlayer!=null && <PlayerForm initial={formPlayer.id?formPlayer:null} onCancel={()=>setFormPlayer(null)} onSave={savePlayer}/>}

          {settingsOpen && <SettingsModal
            onClose={()=>setSettingsOpen(false)}
            kChem={kChem} setKChem={setKChem}
            listTwoCols={listTwoCols} setListTwoCols={setListTwoCols}
            onOpenGlossary={()=>{setSettingsOpen(false);setGlossaryOpen(true);}}
            onExport={onExport} onImport={onImport}
          />}

          {glossaryOpen && <GlossaryModal onClose={()=>setGlossaryOpen(false)}/>}

          {installPrompt && (
            <button onClick={()=>installPrompt.prompt()} className="install-pill bg-emerald-600 text-white px-3 py-2 rounded-full shadow">
              ⬇️ Instalar
            </button>
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
