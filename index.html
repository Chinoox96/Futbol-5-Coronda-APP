<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Fútbol 5</title>
  <meta name="theme-color" content="#10b981"/>
  <link rel="manifest" id="mf"/>

  <!-- Tailwind y React -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Exportar formación a imagen -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bp: 0px;
      --pitch-image: var(--pitch-image-mobile);
      --pitch-image-mobile: url('assets/cesped-vert.webp');
      --pitch-image-desktop: var(--pitch-image-mobile);
      --pitch-darken: 0.50;
      --parallax-speed: 0.35;
      --header-h: 96px; /* fallback */
    }
    html,body{background:#0b1220;color:#e2e8f0;margin:0;overflow-x:hidden}
    img,svg{max-width:100%;height:auto}

    /* Fondo */
    #bg-parallax{position:fixed;inset:0;z-index:0;
      background-image:
        linear-gradient(rgba(11,18,32,var(--pitch-darken)),rgba(11,18,32,var(--pitch-darken))),
        var(--pitch-image);
      background-repeat:repeat-y,repeat-y;
      background-size:100% auto,100% auto;
      background-position:center var(--bp),center var(--bp);
      will-change:background-position}
    @media (min-width:1024px){
      :root{--parallax-speed:0}
      #bg-parallax{background-repeat:no-repeat,no-repeat;background-size:cover,cover;background-position:center center,center center}
    }
    #root{position:relative;z-index:1}

    /* Header fijo */
    .app-header{
      position:fixed;top:0;left:0;right:0;z-index:40;
      backdrop-filter:blur(10px);
      background:rgba(2,6,23,.9);
      border-bottom:1px solid rgba(30,41,59,.8)
    }
    .header-spacer{height:var(--header-h)}

    /* Tabs */
    .tab-btn{
      padding:.6rem .8rem;font-size:.95rem;border-radius:.9rem;
      border:1px solid rgba(51,65,85,.8);background:rgba(2,6,23,.6);color:#cbd5e1;
      transition:transform .18s ease, background .18s ease, color .18s ease, border-color .18s ease;
    }
    .tab-btn.active{
      background:#0b1220;color:#fff;border-color:#4ade80;
      box-shadow:0 0 0 1px rgba(74,222,128,.25) inset;
      transform:translateY(-1px);
    }
    .tab-nav{position:relative}
    .tab-indicator{
      position:absolute;left:0;bottom:-2px;height:3px;width:50%;
      background:linear-gradient(90deg,#34d399,#22d3ee);
      border-radius:9999px;
      transition:transform .28s cubic-bezier(.22,.7,.12,1);
      will-change:transform;
    }

    /* Carrusel tabs */
    .tabs-viewport{overflow:hidden}
    .tabs-track{display:flex;width:200%;transition:transform .32s cubic-bezier(.22,.7,.12,1);will-change:transform}
    .tabs-page{width:100%;padding:12px}

    /* Card rectangular */
    .card-rect{position:relative;border-radius:16px;padding:8px;overflow:hidden}
    .card-inner{position:relative;z-index:2}

    /* Rarezas */
    .rarity-bronze{background:linear-gradient(180deg,#d3a076,#7a5438)}
    .rarity-silver{background:linear-gradient(180deg,#e5e7eb,#9ca3af)}
    .rarity-gold{background:linear-gradient(180deg,#fde68a,#d97706)}
    .rarity-special{background:transparent}
    .rarity-special::before{
      content:"";position:absolute;inset:-2px;border-radius:18px;
      background:conic-gradient(from 0deg,#22d3ee,#a78bfa,#f472b6,#22d3ee);
      animation:spin 6s linear infinite;filter:saturate(1.2) brightness(1.05);z-index:1;
    }
    .rarity-special::after{
      content:"";position:absolute;inset:2px;border-radius:14px;
      background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(30,41,59,.85));z-index:1;
    }
    @keyframes spin{to{transform:rotate(1turn)}}

    /* Formación responsiva */
    .board {
      position: relative;
      width: 100%;
      max-width: 900px;       /* límite desktop */
      aspect-ratio: 5 / 3;    /* 900 x 540 */
      border-radius: 16px;
      overflow: hidden;
    }
    .board img.field {
      position:absolute;inset:0;
      width:100%;height:100%;object-fit:cover;
    }
    .board .layer { position:absolute; inset:0; }

    /* Evitar que PLANTEL se desborde */
    .plantel-scroll {
      max-height: calc(100vh - var(--header-h) - 190px);
      overflow-y: auto;
      padding-right: 4px;
    }
  </style>
</head>
<body>
  <div id="bg-parallax" aria-hidden="true"></div>
  <div id="root"></div>

  <!-- Manifest dinámico -->
  <script>
    (async()=>{
      try{
        const base = location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const L=document.getElementById('mf');
        const mk=(n,c)=>{const a=document.createElement('canvas');a.width=a.height=n;const x=a.getContext('2d');
          x.fillStyle=c;x.fillRect(0,0,n,n);x.fillStyle='#0b1220';x.textAlign='center';x.textBaseline='middle';
          x.font=`${Math.floor(n*.42)}px sans-serif`;x.fillText('F5',n/2,n/2);return a.toDataURL('image/png')};
        const man={name:'Fútbol 5',short_name:'Futbol5',start_url:base,scope:base,display:'standalone',
          background_color:'#0f172a',theme_color:'#10b981',
          icons:[{src:`${base}icons/icon-192.png`,sizes:'192x192',type:'image/png'},
                 {src:`${base}icons/icon-512.png`,sizes:'512x512',type:'image/png'}]};
        try{
          const r1=await fetch(`${base}icons/icon-192.png`,{method:'HEAD'});
          const r2=await fetch(`${base}icons/icon-512.png`,{method:'HEAD'});
          if(!r1.ok||!r2.ok) throw 0;
        }catch{
          man.icons=[{src:mk(192,'#10b981'),sizes:'192x192',type:'image/png'},
                     {src:mk(512,'#10b981'),sizes:'512x512',type:'image/png'}];
        }
        const b=new Blob([JSON.stringify(man)],{type:'application/manifest+json'});
        L.href=URL.createObjectURL(b);
      }catch(e){console.log('[PWA]',e)}
    })();
  </script>

  <!-- Fondo responsive -->
  <script>
    (function(){
      try{
        const base=location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const m=base+'assets/cesped-vert.webp';
        const d=base+'assets/cesped-horiz.webp';
        document.documentElement.style.setProperty('--pitch-image-mobile',`url('${m}')`);
        function setDesk(v){document.documentElement.style.setProperty('--pitch-image-desktop',v);apply()}
        fetch(d,{method:'HEAD'}).then(r=>setDesk((r&&r.ok)?`url('${d}')`:'var(--pitch-image-mobile)')).catch(()=>setDesk('var(--pitch-image-mobile)'));
        function apply(){
          const isDesk=window.matchMedia('(min-width:1024px)').matches;
          const img=isDesk?'var(--pitch-image-desktop)':'var(--pitch-image-mobile)';
          document.documentElement.style.setProperty('--pitch-image',img)
        }
        window.addEventListener('resize',apply);apply();
      }catch(e){}
    })();
  </script>

  <!-- Parallax -->
  <script>
    (function(){
      let ticking=false;
      function sp(){
        const v=getComputedStyle(document.documentElement).getPropertyValue('--parallax-speed');
        const n=parseFloat(v);return isNaN(n)?0:n
      }
      function onScroll(){
        if(ticking)return;
        ticking=true;
        requestAnimationFrame(()=>{
          document.documentElement.style.setProperty('--bp',(-window.scrollY*sp())+'px');
          ticking=false
        })
      }
      window.addEventListener('scroll',onScroll,{passive:true});
      window.addEventListener('resize',onScroll);
      onScroll();
    })();
  </script>

  <!-- === APP === -->
  <script type="text/babel">
    const {useMemo,useState,useEffect} = React;

    /* ================== Helpers y Constantes ================== */
    const STAT=['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
    const SL={ATA:'Ataque',PAS:'Pase',REG:'Regate',VEL:'Velocidad',DEF:'Defensa',FIS:'Físico',ARQ:'Arco',EQP:'Equipo'};
    const TC={
      A:{stroke:'rgba(16,185,129,1)',fill:'rgba(16,185,129,0.18)',dot:'bg-emerald-500',hex:'#10b981'},
      B:{stroke:'rgba(59,130,246,1)',fill:'rgba(59,130,246,0.18)',dot:'bg-blue-500',hex:'#3b82f6'}
    };
    const Wt={ATA:.18,DEF:.16,PAS:.14,REG:.14,VEL:.14,FIS:.10,ARQ:.07,EQP:.07};
    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const avg=a=>a.length?a.reduce((p,c)=>p+c,0)/a.length:0;
    const globalOf=p=>{let s=0,w=0;for(const k in Wt){s+=(p[k]||0)*Wt[k];w+=Wt[k]}return +(s/w).toFixed(2)};
    const J=(s,d)=>{try{return JSON.parse(s)}catch{return d}};
    const withG=a=>a.map(p=>({...p,_GLOBAL:globalOf(p)}));
    const rarityOf=p=>{const r=Math.round((p._GLOBAL||globalOf(p))*10);if(p.especial||r>=90)return 'special';if(r>=80)return 'gold';if(r>=70)return 'silver';return 'bronze'};

    const SUBS={
      ATA:['Posición','Definición','Potencia'], PAS:['Visión','Corto','Largo'],
      REG:['Agilidad','Control','Equilibrio'], VEL:['Aceleración','Punta','Arranque'],
      DEF:['Marcaje','Anticipación','Entradas'], FIS:['Resistencia','Fuerza','Salto'],
      ARQ:['Reflejos','Manos','Saque'], EQP:['Colaboración','Disciplina','Liderazgo']
    };
    const hR=s=>{let h=0;for(let i=0;i<s.length;i++)h=(h*33+s.charCodeAt(i))>>>0;return (h%1000)/1000};
    const substatsOf=p=>{const o={};for(const k of STAT){o[k]=(SUBS[k]||[]).map((n,i)=>{const base=p[k]||5;const noise=(hR((p.id||'')+k+i)-.5)*2;const v=clamp(Math.round(base+noise),1,10);return{n,v}})}return o};

    /* ========= Avatares base64 para evitar CORS ========= */
    const colorOf = name=>{
      const colors=['#22c55e','#06b6d4','#a78bfa','#f59e0b','#ef4444','#14b8a6','#8b5cf6','#f97316','#10b981','#38bdf8'];
      let h=0; for(let i=0;i<name.length;i++) h=(h*31+name.charCodeAt(i))>>>0;
      return colors[h%colors.length];
    };
    const mkAvatar = (name)=>{
      const initials = (name||'F5').split(/\s+/).map(s=>s[0]||'').join('').slice(0,2).toUpperCase();
      const bg = colorOf(name||'F5');
      const svg = `
        <svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>
          <rect width='100%' height='100%' rx='24' ry='24' fill='${bg}'/>
          <text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle'
                font-family='system-ui,Segoe UI,Roboto,sans-serif' font-size='72' fill='white'
                style='font-weight:700'>${initials}</text>
        </svg>`;
      return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
    };

    const SEED=[
      {id:'1', nombre:'Leo',  equipoPropio:'La 10',  equipoFavorito:'Barcelona', fotoUrl:mkAvatar('Leo'),  ATA:10,PAS:9, REG:10,VEL:9, DEF:4,FIS:7,ARQ:3, EQP:8, pie:'Izquierdo',estrellas:5,especial:true},
      {id:'2', nombre:'Fabi', equipoPropio:'La 10',  equipoFavorito:'Colón',     fotoUrl:mkAvatar('Fabi'), ATA:7, PAS:8, REG:7, VEL:7, DEF:7,FIS:7,ARQ:4, EQP:9, pie:'Derecho',estrellas:4},
      {id:'3', nombre:'Cuti', equipoPropio:'Muralla', equipoFavorito:'Belgrano',  fotoUrl:mkAvatar('Cuti'), ATA:5, PAS:6, REG:5, VEL:7, DEF:10,FIS:9,ARQ:4,EQP:7,pie:'Derecho',estrellas:4},
      {id:'4', nombre:'Dibu', equipoPropio:'Muralla', equipoFavorito:'Arsenal',   fotoUrl:mkAvatar('Dibu'), ATA:3, PAS:5, REG:4, VEL:5, DEF:8,FIS:8,ARQ:10,EQP:7,pie:'Derecho',estrellas:5},
      {id:'5', nombre:'Papu', equipoPropio:'Tiki',    equipoFavorito:'San Lorenzo',fotoUrl:mkAvatar('Papu'),ATA:8,PAS:8,REG:9,VEL:8,DEF:5,FIS:6,ARQ:3,EQP:7,pie:'Derecho',estrellas:4},
      {id:'6', nombre:'Nico', equipoPropio:'Tiki',    equipoFavorito:'Boca',      fotoUrl:mkAvatar('Nico'), ATA:7,PAS:7,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:4},
      {id:'7', nombre:'Chino',equipoPropio:'Muralla', equipoFavorito:"Newell's",  fotoUrl:mkAvatar('Chino'),ATA:5,PAS:6,REG:5,VEL:6,DEF:8,FIS:7,ARQ:8,EQP:6,pie:'Izquierdo',estrellas:3},
      {id:'8', nombre:'Joa',  equipoPropio:'La 10',  equipoFavorito:'River',     fotoUrl:mkAvatar('Joa'),  ATA:6,PAS:6,REG:6,VEL:7,DEF:8,FIS:8,ARQ:5,EQP:7,pie:'Derecho',estrellas:3},
      {id:'9', nombre:'Fideo',equipoPropio:'Tiki',   equipoFavorito:'Rosario C.',fotoUrl:mkAvatar('Fideo'),ATA:8,PAS:9,REG:9,VEL:8,DEF:6,FIS:6,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5},
      {id:'10',nombre:'Kuni', equipoPropio:'La 10',  equipoFavorito:'Independiente',fotoUrl:mkAvatar('Kuni'),ATA:9,PAS:7,REG:8,VEL:9,DEF:5,FIS:7,ARQ:3,EQP:7,pie:'Derecho',estrellas:4},
      {id:'11',nombre:'Tomi', equipoPropio:'Muralla',equipoFavorito:'Talleres',  fotoUrl:mkAvatar('Tomi'), ATA:6,PAS:7,REG:6,VEL:7,DEF:7,FIS:7,ARQ:5,EQP:6,pie:'Derecho',estrellas:3},
      {id:'12',nombre:'Gonza',equipoPropio:'Tiki',   equipoFavorito:'Racing',    fotoUrl:mkAvatar('Gonza'),ATA:7,PAS:6,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:3}
    ];

    /* ================== Química y Emparejado ================== */
    const chemBuildBase=arr=>{const q={};for(const a of arr){q[a.id]={};for(const b of arr){
      if(a.id===b.id){q[a.id][b.id]=10;continue}
      if(q[b.id]?.[a.id]!=null){q[a.id][b.id]=q[b.id][a.id];continue}
      let v=5;
      if(a.equipoPropio&&b.equipoPropio&&a.equipoPropio===b.equipoPropio)v+=1.2;
      if(a.equipoFavorito&&b.equipoFavorito&&a.equipoFavorito===b.equipoFavorito)v+=.8;
      v+=(((a.EQP+b.EQP)/2)-5)*.15;
      q[a.id][b.id]=clamp(+v.toFixed(2),1,10)
    }}return q};
    const applyOverrides=(base,ov)=>{if(!ov)return base;const q=JSON.parse(JSON.stringify(base));for(const a in ov){for(const b in ov[a]){const v=clamp(+ov[a][b],1,10);if(!q[a])q[a]={};if(!q[b])q[b]={};q[a][b]=q[b][a]=v}}return q};
    const chemTeam=(ids,chem)=>{const arr=Array.isArray(ids)?ids.filter(Boolean):[];if(arr.length<=1)return 10;let t=0,p=0;for(let i=0;i<arr.length;i++)for(let j=i+1;j<arr.length;j++){t+=chem[arr[i]]?.[arr[j]]??5;p++}return +(t/(p||1)).toFixed(2)};
    const teamGlobal=(ids,map)=>{const arr=Array.isArray(ids)?ids.filter(id=>map[id]):[];return +avg(arr.map(id=>map[id]._GLOBAL)).toFixed(2)};
    const teamScoreUI=(ids,map,chem,k)=>+(teamGlobal(ids,map,chem)+chemTeam(ids,chem)*k).toFixed(2);
    const shuffle=a=>{const x=[...a];for(let i=x.length-1;i>0;i--){const j=(Math.random()*(i+1)|0);[x[i],x[j]]=[x[j],x[i]]}return x};
    const scoreDiff=(A,B,map,chem,k)=>{const sA=teamScoreUI(A,map,chem,k),sB=teamScoreUI(B,map,chem,k);return{A:[...A],B:[...B],diff:Math.abs(sA-sB),m:{sA,sB}}};
    const seedWithPins=(ids,pA,pB)=>{const A=ids.filter(id=>pA.has(id));const B=ids.filter(id=>pB.has(id));const rest=ids.filter(id=>!pA.has(id)&&!pB.has(id));return{A,B,rest}};
    const fillRandom=(A,B,rest)=>{const r=shuffle(rest);for(const id of r){(A.length<B.length?A:B).push(id);if(A.length===5&&B.length===5)break}};
    const balancedWithPins=(ids,map,chem,k,pA,pB)=>{
      const{A,B,rest}=seedWithPins(ids,pA,pB);fillRandom(A,B,rest);
      while((A.length<5||B.length<5)&&rest.length>0){const id=rest.pop();(A.length<B.length?A:B).push(id)}
      let best=scoreDiff(A,B,map,chem,k);
      const freeA=best.A.map((id,i)=>pA.has(id)?-1:i).filter(i=>i>=0);
      const freeB=best.B.map((id,i)=>pB.has(id)?-1:i).filter(i=>i>=0);
      for(let t=0;t<900;t++){
        if(!freeA.length||!freeB.length)break;
        const i=freeA[(Math.random()*freeA.length)|0];
        const j=freeB[(Math.random()*freeB.length)|0];
        [best.A[i],best.B[j]]=[best.B[j],best.A[i]];
        const cur=scoreDiff(best.A,best.B,map,chem,k);
        if(cur.diff<=best.diff||Math.random()<.12)best=cur;else[best.A[i],best.B[j]]=[best.B[j],best.A[i]]
      }
      return{A:best.A,B:best.B,m:best.m}
    };

    /* ================== UI ================== */
    const Pill=({children,className=''})=> <span className={`inline-block rounded-full px-2 py-0.5 text-xs ${className}`}>{children}</span>;
    const Stars=({n=0})=>{const s=clamp(Math.round(n),0,5);return(<div className="flex gap-1 text-amber-300" title={`${s} estrellas`}>{Array.from({length:5}).map((_,i)=>(<span key={i}>{i<s?'★':'☆'}</span>))}</div>)};

    /* Card principal */
    const FifaCard=({p,small=false})=>{
      const rate=Math.round((p._GLOBAL||globalOf(p))*10);
      const rare=rarityOf(p);
      const sizeClass= small ? 'w-36' : 'w-44';
      const ring = rare==='bronze'?'ring-yellow-800':rare==='silver'?'ring-slate-300':rare==='gold'?'ring-yellow-500':'ring-cyan-300';
      const rareClass = rare==='special' ? 'rarity-special' : `rarity-${rare}`;
      return (
        <div className={`card-rect ${sizeClass} ${rareClass} text-slate-900 ring-1 ${ring} shadow`}>
          <div className="card-inner">
            <div className="flex justify-between items-start">
              <div className="text-center leading-4">
                <div className="text-3xl font-black">{rate}</div>
                <div className="text-xs font-bold">{p.pos||'F5'}</div>
                <div className="text-base">{p.bandera||''}</div>
              </div>
              {p.escudoUrl
                ? <img src={p.escudoUrl} className="h-9 w-8 object-contain ring-1 ring-black/10 rounded" alt="escudo"/>
                : <div className="h-9 w-8 grid place-items-center bg-white/70 text-xs font-extrabold ring-1 ring-black/10 rounded">{(p.equipoPropio||'').slice(0,2).toUpperCase()}</div>}
            </div>
            <div className="mt-2 grid place-items-center">
              <img src={p.fotoUrl} className={`rounded-xl object-cover ring-2 ${ring} ${small?'h-20 w-20':'h-24 w-24'}`} alt={p.nombre}/>
            </div>
            <div className="mt-2 text-center text-sm font-extrabold truncate">{p.nombre}</div>
            <div className="mt-1 grid grid-cols-2 gap-x-2 gap-y-1 text-[11px] font-semibold">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded-lg bg-white/30 px-2 py-1">
                  <span>{k}</span><span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    /* === Formación: misma FifaCard, escalada y posicionada por porcentaje === */
    const FormationBoard = ({teamA=[], teamB=[], map, scale=0.62}) => {
      // Posiciones en % (referencia 900x540)
      const posA = [{x:7.8,y:7.4},{x:10.6,y:25.9},{x:9.4,y:48.1},{x:10.6,y:70.4},{x:7.8,y:88.9}];
      const posB = [{x:92.2,y:7.4},{x:89.4,y:25.9},{x:90.6,y:48.1},{x:89.4,y:70.4},{x:92.2,y:88.9}];

      const exportar = async ()=>{
        const el=document.getElementById('formation-board'); if(!el) return;
        const canvas=await html2canvas(el,{backgroundColor:null,scale:2});
        const url=canvas.toDataURL('image/png');
        const a=document.createElement('a');a.href=url;a.download='formacion_f5.png';a.click();
      };

      const CardOnField = ({id,xy})=>{
        const p=map[id]; if(!p) return null;
        const t=`translate(-50%, -50%) scale(${scale})`;
        return (
          <div style={{position:'absolute',left:xy.x+'%',top:xy.y+'%',transform:t,transformOrigin:'top left'}}>
            <FifaCard p={p}/>
          </div>
        );
      };

      return (
        <div className="w-full">
          <div id="formation-board" className="board ring-1 ring-slate-700 shadow-xl mx-auto bg-slate-900/30">
            <img src="assets/cancha.png" alt="Cancha" className="field"/>
            <div className="layer pointer-events-none">
              <div className="absolute top-3 left-1/2 -translate-x-1/2 px-4 py-1.5 rounded-xl bg-slate-900/70 text-white text-sm sm:text-base font-bold">
                Partido F5 - Formación
              </div>
              {teamA.map((id,i)=><CardOnField key={'A'+id} id={id} xy={posA[i]||posA[posA.length-1]}/>)}
              {teamB.map((id,i)=><CardOnField key={'B'+id} id={id} xy={posB[i]||posB[posB.length-1]}/>)}
              <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-[12px] text-slate-200">Generado con Fútbol 5</div>
            </div>
          </div>

          <div className="flex justify-center mt-2">
            <button onClick={exportar} className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">
              Descargar imagen de la formación
            </button>
          </div>
        </div>
      );
    };

    /* ====== Resto de componentes (Player list, modales) ====== */
    const PlayerChemList=({player,players,chem,teamIdsA=[],teamIdsB=[],onEditChem})=>{
      const list=players.filter(p=>p.id!==player.id).map(p=>({...p,_chem:chem[player.id]?.[p.id]??5,onA:teamIdsA.includes(p.id),onB:teamIdsB.includes(p.id)})).sort((a,b)=>b._chem-a._chem);
      return(
        <div className="space-y-3">
          <div className="flex justify-center"><FifaCard p={player} small/></div>
          <div className="max-h-72 overflow-auto space-y-1">
            {list.map(o=>(
              <div key={o.id} className={`flex items-center justify-between rounded-lg px-2 py-1 text-sm ${o.onA?'bg-emerald-600/15 ring-1 ring-emerald-500/30':o.onB?'bg-blue-600/15 ring-1 ring-blue-500/30':'bg-slate-800/60 ring-1 ring-slate-700'}`}>
                <div className="flex items-center gap-2 min-w-0"><img src={o.fotoUrl} className="h-7 w-7 rounded-full object-cover ring-1 ring-slate-700" alt=""/><span className="truncate">{o.nombre}</span></div>
                <div className="flex items-center gap-2"><span className="font-semibold w-6 text-right">{o._chem}</span>{onEditChem&&<button onClick={()=>onEditChem(player.id,o.id,o._chem)} className="rounded px-2 py-0.5 text-xs ring-1 ring-slate-600 bg-slate-800 hover:bg-slate-700">✏️</button>}</div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    const PinButtons=({id,pinA,pinB,setPinA,setPinB})=>{
      const onA=pinA.has(id), onB=pinB.has(id);
      const toggle=t=>{
        if(t==='A'){const nA=new Set(pinA),nB=new Set(pinB);onA?nA.delete(id):nA.add(id);nB.delete(id);setPinA(nA);setPinB(nB)}
        else       {const nA=new Set(pinA),nB=new Set(pinB);onB?nB.delete(id):nB.add(id);nA.delete(id);setPinA(nA);setPinB(nB)}
      };
      return(<div className="flex gap-1">
        <button title="Fijar en A" onClick={()=>toggle('A')} className={`h-7 w-7 rounded-lg text-xs font-bold ring-1 ${onA?'bg-emerald-600 text-white ring-emerald-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>A</button>
        <button title="Fijar en B" onClick={()=>toggle('B')} className={`h-7 w-7 rounded-lg text-xs font-bold ring-1 ${onB?'bg-blue-600 text-white ring-blue-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>B</button>
      </div>);
    };

    const PlayerRow=({p,selected,onToggle,onOpen,pinA,pinB,setPinA,setPinB,disableAdd})=>{
      const disabled=!selected && disableAdd;
      return(
        <div className="flex items-center gap-3 rounded-xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <img src={p.fotoUrl} alt={p.nombre} className="h-10 w-10 rounded-full object-cover ring-1 ring-slate-700"/>
          <div className="min-w-0 flex-1">
            <div className="flex items-center justify-between gap-2">
              <button onClick={onOpen} className="min-w-0 text-left">
                <div className="truncate text-base font-semibold">{p.nombre}</div>
                <div className="mt-0.5 flex flex-wrap items-center gap-1 text-xs text-slate-400">
                  <Pill className="bg-slate-800/80 text-slate-200">Rating: {Math.round(p._GLOBAL*10)}</Pill>
                  {p.equipoPropio&&<Pill className="bg-indigo-600/20 text-indigo-200">Propio: {p.equipoPropio}</Pill>}
                  {p.equipoFavorito&&<Pill className="bg-cyan-600/20 text-cyan-200">Fav: {p.equipoFavorito}</Pill>}
                  {p.pie&&<Pill className="bg-amber-600/20 text-amber-200">Pie: {p.pie}</Pill>}
                  {(p.estrellas!=null)&&<Pill className="bg-yellow-600/20 text-yellow-100">★ {p.estrellas}</Pill>}
                </div>
              </button>
              <div className="flex items-center gap-2">
                <PinButtons id={p.id} pinA={pinA} pinB={pinB} setPinA={setPinA} setPinB={setPinB}/>
                <button onClick={onToggle} disabled={disabled} className={`rounded-xl px-3 py-1 text-sm ring-1 ${selected?'bg-emerald-600 text-white ring-emerald-500':disabled?'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>{selected? '✓ Convocado' : '+ Convocar'}</button>
              </div>
            </div>
            <div className="mt-2 grid grid-cols-4 gap-1 text-[11px] text-slate-300">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1"><span className="font-medium" title={SL[k]}>{k}</span><span className="tabular-nums">{p[k]}</span></div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    const PlayerDetails=({p})=>{
      const s=p.subs||substatsOf(p);
      return(
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
          <div className="flex justify-center"><FifaCard p={p}/></div>
          <div className="space-y-3">
            <div className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Ficha</div>
              <div className="grid grid-cols-2 gap-2 text-sm">
                <div className="rounded-lg bg-slate-900/60 p-2">Propio:<div className="font-semibold">{p.equipoPropio||'-'}</div></div>
                <div className="rounded-lg bg-slate-900/60 p-2">Favorito:<div className="font-semibold">{p.equipoFavorito||'-'}</div></div>
                <div className="rounded-lg bg-slate-900/60 p-2">Pie hábil:<div className="font-semibold">{p.pie||'-'}</div></div>
                <div className="rounded-lg bg-slate-900/60 p-2">Valoración:<div className="font-semibold"><Stars n={p.estrellas||0}/></div></div>
              </div>
            </div>
            {STAT.map(k=>(
              <div key={k} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
                <div className="mb-1 text-sm font-semibold">{SL[k]} <span className="opacity-75">({p[k]})</span></div>
                {(s[k]||[]).map((it,idx)=>(<div key={idx} className="mb-1">
                  <div className="flex justify-between text-xs"><span>{it.n}</span><span className="font-semibold">{it.v}</span></div>
                  <div className="h-1.5 rounded bg-slate-700"><div className="h-1.5 rounded" style={{width:`${it.v*10}%`,backgroundColor:'#22c55e'}}/></div>
                </div>))}
              </div>
            ))}
          </div>
        </div>
      );
    };

    const PlayerFormModal=({initial,onCancel,onSave})=>{
      const base={nombre:'',equipoPropio:'',equipoFavorito:'',fotoUrl:'',escudoUrl:'',bandera:'',pos:'',ATA:5,PAS:5,REG:5,VEL:5,DEF:5,FIS:5,ARQ:5,EQP:5,subs:null,pie:'Derecho',estrellas:3,especial:false};
      const [form,setForm]=useState(()=>{const f=initial?{...initial}:{...base}; if(!f.subs) f.subs=substatsOf(f); if(!f.fotoUrl) f.fotoUrl=mkAvatar(f.nombre||'F5'); return f;});
      const [showFlags,setShowFlags]=useState(false);
      const set=(k,v)=>setForm(f=>({...f,[k]:v}));
      const onFile=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>set('fotoUrl',r.result);r.readAsDataURL(f)};
      const onSubmit=e=>{
        e.preventDefault();
        const c={...form};
        STAT.forEach(k=>{
          const arr=(c.subs?.[k]||[]).map(it=>clamp(+it.v||0,1,10));
          c[k]=arr.length?clamp(Math.round(avg(arr)),1,10):clamp(parseInt(c[k]||0,10),1,10);
        });
        if(!c.nombre.trim()) return;
        if(!c.fotoUrl) c.fotoUrl=mkAvatar(c.nombre);
        onSave(c);
      };
      const FLAGS='🇦🇷,🇧🇷,🇺🇾,🇵🇾,🇨🇱,🇧🇴,🇵🇪,🇨🇴,🇪🇨,🇲🇽,🇪🇸,🇵🇹,🇮🇹,🇫🇷,🇩🇪,🇬🇧,🇺🇸,🇯🇵'.split(',');

      return(
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onCancel}>
          <form className="w-full max-w-2xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 max-h-[85vh] overflow-auto" onSubmit={onSubmit} onClick={e=>e.stopPropagation()}>
            <div className="text-lg font-semibold">{initial?'Editar jugador':'Añadir jugador'}</div>

            <div className="grid grid-cols-2 gap-2 text-sm">
              <label className="space-y-1 col-span-2">
                <span>Nombre</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.nombre} onChange={e=>{set('nombre',e.target.value); if(!form.fotoUrl) set('fotoUrl',mkAvatar(e.target.value||'F5'));}} required/>
              </label>

              <label className="space-y-1 col-span-2">
                <span>Foto URL</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.fotoUrl||''} placeholder="https://... (o deja el avatar automático)" onChange={e=>set('fotoUrl',e.target.value)}/>
                <span className="text-xs opacity-80">o subir imagen</span>
                <input type="file" accept="image/*" onChange={onFile} className="w-full text-xs"/>
              </label>

              <label className="space-y-1">
                <span>Equipo propio</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.equipoPropio||''} onChange={e=>set('equipoPropio',e.target.value)}/>
              </label>

              <label className="space-y-1">
                <span>Equipo favorito</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.equipoFavorito||''} onChange={e=>set('equipoFavorito',e.target.value)}/>
              </label>

              <label className="space-y-1">
                <span>Escudo URL</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.escudoUrl||''} placeholder="https://..." onChange={e=>set('escudoUrl',e.target.value)}/>
              </label>

              <label className="space-y-1">
                <span>Posición</span>
                <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.pos||''} placeholder="DC, MC, DF..." onChange={e=>set('pos',e.target.value)}/>
              </label>

              <label className="space-y-1 col-span-2">
                <span>Bandera (emoji)</span>
                <div className="flex gap-2">
                  <input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.bandera||''} placeholder="🇦🇷" onChange={e=>set('bandera',e.target.value)}/>
                  <button type="button" onClick={()=>setShowFlags(s=>!s)} className="rounded bg-slate-800 px-2 ring-1 ring-slate-700">Elegir</button>
                </div>
                {showFlags&&(
                  <div className="mt-1 max-h-24 overflow-auto rounded bg-slate-800 p-2 ring-1 ring-slate-700 flex flex-wrap gap-1">
                    {FLAGS.map(f=>(<button type="button" key={f} onClick={()=>{set('bandera',f);setShowFlags(false)}} className="rounded bg-slate-700 px-2 text-base">{f}</button>))}
                  </div>
                )}
              </label>

              <label className="space-y-1">
                <span>Pie hábil</span>
                <select className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.pie||'Derecho'} onChange={e=>set('pie',e.target.value)}>
                  <option>Derecho</option><option>Izquierdo</option><option>Ambidiestro</option>
                </select>
              </label>

              <label className="space-y-1">
                <span>Estrellas (1..5)</span>
                <input type="number" min="1" max="5" className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.estrellas||3} onChange={e=>set('estrellas',clamp(parseInt(e.target.value||0,10),1,5))}/>
              </label>

              <label className="space-y-1">
                <span>Especial</span>
                <div>
                  <input type="checkbox" checked={!!form.especial} onChange={e=>set('especial',e.target.checked)}/> 
                  <span className="text-xs opacity-80"> Rareza animada (borde)</span>
                </div>
              </label>
            </div>

            <div className="space-y-2">
              {STAT.map(k=>(
                <div key={k} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
                  <div className="mb-1 text-sm font-semibold">
                    {SL[k]} <span className="opacity-60 text-xs">(se promedia en {k})</span> — 
                    <span className="opacity-80"> Actual: {form[k]}</span>
                  </div>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                    {(form.subs?.[k]||SUBS[k].map(n=>({n,v:5}))).map((it,idx)=>(
                      <label key={idx} className="space-y-1">
                        <span className="text-xs">{it.n}</span>
                        <input
                          type="number" min="1" max="10"
                          className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700"
                          value={it.v}
                          onChange={e=>{
                            const v=clamp(parseInt(e.target.value||0,10),1,10);
                            setForm(f=>{
                              const subs={...(f.subs||{})};
                              const arr=[...((subs[k]||SUBS[k].map(n=>({n,v:5}))))];
                              arr[idx]={...arr[idx],v};
                              subs[k]=arr;
                              const gen=clamp(Math.round(avg(arr.map(x=>+x.v||0))),1,10);
                              return {...f,subs,[k]:gen};
                            });
                          }}
                        />
                      </label>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="flex justify-end gap-2">
              <button type="button" onClick={onCancel} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">
                Cancelar
              </button>
              <button type="submit" className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">
                Guardar
              </button>
            </div>
          </form>
        </div>
      );
    };

    const PlayerModal=({player,onClose,players,chem,teamIdsA=[],teamIdsB=[],onEditChem})=>{
      const[mode,setMode]=useState('det'); if(!player)return null;
      return(
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
          <div className="w-full max-w-5xl max-h-[88vh] overflow-auto rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700"
               onClick={e=>e.stopPropagation()}>
            <div className="mb-2 flex items-center gap-3">
              <div className="text-sm opacity-80">Jugador</div>
              <div className="truncate font-semibold">{player.nombre}</div>
              <button onClick={onClose}
                      className="ml-auto rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">
                Cerrar
              </button>
            </div>
            <div className="mb-3 flex flex-wrap gap-2">
              <button onClick={()=>setMode('det')}
                      className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='det'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>
                Detalles
              </button>
              <button onClick={()=>setMode('quim')}
                      className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='quim'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>
                Química
              </button>
            </div>
            {mode==='det'
              ? <PlayerDetails p={player}/>
              : <PlayerChemList player={player} players={players} chem={chem}
                                teamIdsA={teamIdsA} teamIdsB={teamIdsB}
                                onEditChem={onEditChem}/>}
          </div>
        </div>
      );
    };

    /* =================== Ajustes =================== */
    const SettingsModal=({onClose,kChem,setKChem,onExport,onImport,onReset,parallaxOn,setParallaxOn,formScale,setFormScale})=>{
      const input=React.useRef(null);
      return(
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
          <div className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700"
               onClick={e=>e.stopPropagation()}>
            <div className="mb-1 text-lg font-semibold">Ajustes</div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Peso de Química en Score</div>
              <input type="range" min="0" max="1" step="0.05" value={kChem}
                     onChange={e=>setKChem(+e.target.value)} className="w-full"/>
              <div className="text-xs text-slate-300 mt-1">k = {kChem.toFixed(2)} (UI)</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Tamaño tarjeta en formación</div>
              <input type="range" min="0.45" max="0.9" step="0.01" value={formScale}
                     onChange={e=>setFormScale(+e.target.value)} className="w-full"/>
              <div className="text-xs text-slate-300 mt-1">escala = {formScale.toFixed(2)}</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-2">
              <div className="text-sm font-semibold">Importar / Exportar</div>
              <div className="flex flex-wrap gap-2">
                <button onClick={onExport}
                        className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">
                  Exportar JSON
                </button>
                <button onClick={()=>input.current?.click()}
                        className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">
                  Importar JSON
                </button>
                <input ref={input} type="file" accept="application/json" className="hidden" onChange={onImport}/>
                <button onClick={onReset}
                        className="ml-auto rounded-xl bg-rose-700 px-3 py-1 text-sm text-white ring-1 ring-rose-500 hover:bg-rose-600">
                  Restablecer seed
                </button>
              </div>
              <div className="text-xs text-slate-400">El JSON incluye fotos (si subiste archivo se guarda base64).</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Parallax de fondo</div>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={parallaxOn} onChange={e=>setParallaxOn(e.target.checked)}/>
                <span>{parallaxOn?'Activado':'Desactivado'}</span>
              </label>
              <div className="text-xs text-slate-400 mt-1">
                En PC con parallax desactivado, el césped queda fijo a pantalla completa.
              </div>
            </div>

            <div className="text-right">
              <button onClick={onClose}
                      className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">
                Cerrar
              </button>
            </div>
          </div>
        </div>
      );
    };

    /* =================== APP =================== */
    const App=()=>{
      const storeP=J(localStorage.getItem('f5.players'),null);
      const initP=withG(Array.isArray(storeP)&&storeP.length?storeP:SEED);
      const[players,setPlayers]=useState(initP);
      const[selected,setSelected]=useState(()=>new Set(J(localStorage.getItem('f5.selected'),[])));
      const[teams,setTeams]=useState(()=>J(localStorage.getItem('f5.teams'),null));
      const[kChem,setKChem]=useState(()=>+(localStorage.getItem('f5.kchem')??0.6));
      const[pinA,setPinA]=useState(()=>new Set(J(localStorage.getItem('f5.pins.A'),[])));
      const[pinB,setPinB]=useState(()=>new Set(J(localStorage.getItem('f5.pins.B'),[])));
      const[chemOverrides,setChemOverrides]=useState(()=>J(localStorage.getItem('f5.chem.overrides'),{}));
      const[history,setHistory]=useState(()=>{const h=J(localStorage.getItem('f5.history'),[]);return Array.isArray(h)?h:[]});
      const[parallaxOn,setParallaxOn]=useState(()=>{const s=localStorage.getItem('f5.parallax');if(s!=null)try{return JSON.parse(s)}catch{}return !window.matchMedia('(min-width:1024px)').matches});
      const[formScale,setFormScale]=useState(()=>+(localStorage.getItem('f5.formScale')??0.62));
      const[tab,setTab]=useState('partido'); // partido | plantel
      const[modal,setModal]=useState(null);
      const[form,setForm]=useState(null);
      const[settings,setSettings]=useState(false);
      const[q,setQ]=useState('');
      const[sort,setSort]=useState('global-desc');

      const map=useMemo(()=>Object.fromEntries(players.map(p=>[p.id,p])),[players]);
      const chem=useMemo(()=>applyOverrides(chemBuildBase(players),chemOverrides),[players,chemOverrides]);

      // Persistencia
      useEffect(()=>localStorage.setItem('f5.players',JSON.stringify(players)),[players]);
      useEffect(()=>localStorage.setItem('f5.selected',JSON.stringify([...selected])),[selected]);
      useEffect(()=>localStorage.setItem('f5.teams',JSON.stringify(teams)),[teams]);
      useEffect(()=>localStorage.setItem('f5.kchem',String(kChem)),[kChem]);
      useEffect(()=>localStorage.setItem('f5.pins.A',JSON.stringify([...pinA])),[pinA]);
      useEffect(()=>localStorage.setItem('f5.pins.B',JSON.stringify([...pinB])),[pinB]);
      useEffect(()=>localStorage.setItem('f5.chem.overrides',JSON.stringify(chemOverrides)),[chemOverrides]);
      useEffect(()=>localStorage.setItem('f5.history',JSON.stringify(history)),[history]);
      useEffect(()=>localStorage.setItem('f5.parallax',JSON.stringify(parallaxOn)),[parallaxOn]);
      useEffect(()=>localStorage.setItem('f5.formScale',String(formScale)),[formScale]);

      // Aplicar parallaxOn a la variable CSS
      useEffect(()=>{
        const isDesk=window.matchMedia('(min-width:1024px)').matches;
        const speed = parallaxOn ? (isDesk ? 0 : 0.35) : 0;
        document.documentElement.style.setProperty('--parallax-speed', String(speed));
      },[parallaxOn]);

      // medir header para spacer
      useEffect(()=>{
        const el=document.querySelector('.app-header');
        const setH=()=>{ if(el){ document.documentElement.style.setProperty('--header-h', el.offsetHeight+'px'); } };
        setH(); window.addEventListener('resize',setH); return ()=>window.removeEventListener('resize',setH);
      },[]);

      const convocados=[...selected];
      const canMake=convocados.length===10;
      const reachedMax=convocados.length>=10;
      const invalidPins=pinA.size>5||pinB.size>5;

      const toggle=id=>setSelected(s=>{const n=new Set(s);if(n.has(id))n.delete(id);else{if(reachedMax)return n;n.add(id)}return n});
      const makeR=()=>{if(!canMake||invalidPins)return;const ids=[...convocados];ids.sort(()=>Math.random()-.5);setTeams({A:ids.slice(0,5),B:ids.slice(5)})};
      const makeB=()=>{if(!canMake||invalidPins)return;const{A,B}=balancedWithPins(convocados,map,chem,kChem,pinA,pinB);setTeams({A,B})};

      const onSave=data=>{
        if(form&&form.id){
          setPlayers(p=>withG(p.map(x=>x.id===form.id?{...x,...data}:x)))
        }else{
          const id=String(Date.now());
          setPlayers(p=>withG([...p,{id,...data}]))
        }
        setForm(null);
      };
      const onDel=id=>{
        setPlayers(p=>p.filter(x=>x.id!==id));
        setSelected(s=>{const n=new Set(s);n.delete(id);return n});
        setTeams(t=>t?{A:t.A.filter(x=>x!==id),B:t.B.filter(x=>x!==id)}:t);
        setPinA(a=>{const n=new Set(a);n.delete(id);return n});
        setPinB(b=>{const n=new Set(b);n.delete(id);return n});
      };

      const onExport=()=>{const payload={players,selected:[...selected],teams,kChem,pinA:[...pinA],pinB:[...pinB],chemOverrides,history};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='futbol5_estado.json';a.click();URL.revokeObjectURL(url)};
      const onImport=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{
          const d=JSON.parse(r.result);
          if(Array.isArray(d.players))setPlayers(withG(d.players));
          if(Array.isArray(d.selected))setSelected(new Set(d.selected));
          if(d.teams?.A&&d.teams?.B)setTeams(d.teams);
          if(typeof d.kChem==='number')setKChem(d.kChem);
          if(Array.isArray(d.pinA))setPinA(new Set(d.pinA));
          if(Array.isArray(d.pinB))setPinB(new Set(d.pinB));
          if(d.chemOverrides&&typeof d.chemOverrides==='object')setChemOverrides(d.chemOverrides);
          if(Array.isArray(d.history))setHistory(d.history);
        }catch{alert('JSON inválido')}};r.readAsText(f)};

      const reset=()=>{setPlayers(withG(SEED));setSelected(new Set());setTeams(null);setKChem(0.6);setPinA(new Set());setPinB(new Set());setChemOverrides({});setHistory([])};

      const editChem=(a,b,cur)=>{
        const nameA=map[a]?.nombre||a;
        const nameB=map[b]?.nombre||b;
        const v=prompt(`Química ${nameA} ↔ ${nameB} (1..10)`,String(cur??5));
        if(v==null)return;const n=clamp(parseFloat(v),1,10);
        setChemOverrides(o=>{const c={...o};if(!c[a])c[a]={};if(!c[b])c[b]={};c[a][b]=c[b][a]=+n.toFixed(2);return c})
      };

      const filtered=[...players].filter(p=>{
        const t=q.trim().toLowerCase();if(!t)return true;
        return(p.nombre||'').toLowerCase().includes(t)||(p.equipoPropio||'').toLowerCase().includes(t)||(p.equipoFavorito||'').toLowerCase().includes(t)
      });
      filtered.sort((a,b)=>{switch(sort){
        case'global-asc':return a._GLOBAL-b._GLOBAL;
        case'nombre':return a.nombre.localeCompare(b.nombre);
        default:return b._GLOBAL-a._GLOBAL;
      }});

      const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;
      const install=()=>alert('En Android: menú (⋮) → Agregar a pantalla de inicio.\nEn iOS: Compartir → Añadir a pantalla de inicio.');

      return (
        <div className="mx-auto max-w-screen-md text-slate-100">
          {/* HEADER */}
          <header className="app-header">
            <div className="px-3 py-2 flex items-center justify-between gap-2">
              <div className="text-sm opacity-75">⚽</div>
              <h1 className="text-lg font-bold text-center flex-1">F5 App Coronda</h1>
              <div className={`rounded-xl px-3 py-1 text-sm ring-1 ${selected.size<10?'bg-amber-600/20 text-amber-200 ring-amber-500/40':'bg-emerald-600/20 text-emerald-200 ring-emerald-500/40'}`}>
                Convocados: {selected.size}/10
              </div>
              <button onClick={()=>setSettings(true)}
                      className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">⚙️</button>
            </div>
            <nav className="tab-nav px-3 pb-2 grid grid-cols-2 gap-2">
              <button onClick={()=>setTab('partido')} className={`tab-btn ${tab==='partido'?'active':''}`}>PARTIDO</button>
              <button onClick={()=>setTab('plantel')} className={`tab-btn ${tab==='plantel'?'active':''}`}>PLANTEL</button>
              <span className="tab-indicator" style={{transform:`translateX(${tab==='partido'?'0%':'100%'})`}}></span>
            </nav>
          </header>
          <div className="header-spacer"></div>

          {/* CONTENEDOR animado */}
          <div className="tabs-viewport">
            <div className="tabs-track" style={{transform:`translateX(${tab==='partido'?'0%':'-50%'})`}}>

              {/* Página PARTIDO */}
              <section className="tabs-page space-y-3">
                {selected.size!==10 && (
                  <div className="rounded-xl bg-amber-600/15 p-3 text-amber-100 ring-1 ring-amber-600/30">
                    Necesitás exactamente 10 convocados. Elegilos en <b>PLANTEL</b>.
                  </div>
                )}

                {teams && (
                  <>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800">
                        <div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TC.A.dot}`}/> <span>Equipo A</span></div>
                      </div>
                      <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800">
                        <div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TC.B.dot}`}/> <span>Equipo B</span></div>
                      </div>
                    </div>

                    <FormationBoard teamA={teams.A} teamB={teams.B} map={map} scale={formScale}/>

                    <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
                      <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                        <div className="mb-2 font-semibold">Barras - A</div>
                        <div className="space-y-2">
                          {STAT.map(k=>(
                            <div key={k}>
                              <div className="mb-1 flex items-center justify-between text-sm"><span className="text-slate-300">{k}</span><span className="font-semibold">{Math.round(avg(teams.A.map(id=>map[id][k]))*10)/10}</span></div>
                              <div className="h-2 w-full rounded bg-slate-700"><div className="h-2 rounded" style={{width:`${Math.max(0,Math.min(100,(avg(teams.A.map(id=>map[id][k]))/10)*100))}%`,backgroundColor:TC.A.hex}}/></div>
                            </div>
                          ))}
                        </div>
                      </div>
                      <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                        <div className="mb-2 font-semibold">Barras - B</div>
                        <div className="space-y-2">
                          {STAT.map(k=>(
                            <div key={k}>
                              <div className="mb-1 flex items-center justify-between text-sm"><span className="text-slate-300">{k}</span><span className="font-semibold">{Math.round(avg(teams.B.map(id=>map[id][k]))*10)/10}</span></div>
                              <div className="h-2 w-full rounded bg-slate-700"><div className="h-2 rounded" style={{width:`${Math.max(0,Math.min(100,(avg(teams.B.map(id=>map[id][k]))/10)*100))}%`,backgroundColor:TC.B.hex}}/></div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </>
                )}

                {/* Acciones de armado */}
                <div className="sticky bottom-2 mt-4 grid grid-cols-2 gap-2">
                  <button onClick={makeR}
                          disabled={!(selected.size===10)}
                          className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${selected.size===10?'bg-slate-800 text-slate-100 ring-slate-700 hover:bg-slate-700':'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed'}`}>
                    🎲 Azar
                  </button>
                  <button onClick={makeB}
                          disabled={!(selected.size===10)}
                          className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${selected.size===10?'bg-emerald-600 text-white ring-emerald-500 hover:bg-emerald-500':'bg-emerald-600/40 text-emerald-200 ring-emerald-800 cursor-not-allowed'}`}>
                    ⚖️ Equilibrado
                  </button>
                </div>
              </section>

              {/* Página PLANTEL */}
              <section className="tabs-page space-y-2">
                <div className="mb-2 grid grid-cols-1 gap-2 sm:grid-cols-3">
                  <input value={q} onChange={e=>setQ(e.target.value)}
                         placeholder="Buscar nombre / club / favorito"
                         className="rounded-xl bg-slate-900/70 p-2 text-sm ring-1 ring-slate-800"/>
                  <select value={sort} onChange={e=>setSort(e.target.value)}
                          className="rounded-xl bg-slate-900/70 p-2 text-sm ring-1 ring-slate-800">
                    <option value="global-desc">Orden: Global ↓</option>
                    <option value="global-asc">Orden: Global ↑</option>
                    <option value="nombre">Orden: Nombre</option>
                  </select>
                  <div className="flex gap-2">
                    <button onClick={()=>setForm({})}
                            className="flex-1 rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">
                      + Añadir
                    </button>
                    <button onClick={()=>{setSelected(new Set());setTeams(null)}}
                            className="flex-1 rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">
                      Limpiar
                    </button>
                  </div>
                </div>

                {(pinA.size>5||pinB.size>5)&&(
                  <div className="rounded-xl bg-rose-600/15 p-2 text-sm text-rose-100 ring-1 ring-rose-500/30">
                    No podés fijar más de 5 por equipo.
                  </div>
                )}

                <div className="plantel-scroll space-y-2">
                  {filtered.map(p=>(
                    <div key={p.id} className="space-y-2">
                      <PlayerRow p={p}
                                 selected={selected.has(p.id)}
                                 onToggle={()=>toggle(p.id)}
                                 onOpen={()=>setModal(p)}
                                 pinA={pinA} pinB={pinB}
                                 setPinA={setPinA} setPinB={setPinB}
                                 disableAdd={selected.size>=10}/>
                      <div className="-mt-2 mb-2 flex gap-2 pl-14">
                        <button onClick={()=>setForm(p)}
                                className="rounded-xl bg-slate-800 px-2 py-1 text-xs ring-1 ring-slate-700 hover:bg-slate-700">
                          Editar
                        </button>
                        <button onClick={()=>onDel(p.id)}
                                className="rounded-xl bg-rose-700 px-2 py-1 text-xs text-white ring-1 ring-rose-500 hover:bg-rose-600">
                          Borrar
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </section>

            </div>
          </div>

          {!isStandalone&&(
            <button onClick={install}
                    className="fixed bottom-20 right-3 z-50 rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-lg ring-1 ring-emerald-500 hover:bg-emerald-500">
              📲 Instalar
            </button>
          )}

          <footer className="mt-6 mx-3 rounded-xl bg-slate-900/60 p-3 text-[12px] text-slate-300 ring-1 ring-slate-800">
            <div className="font-semibold">Leyenda:</div>
            <div>ATA=Ataque — PAS=Pase — REG=Regate — VEL=Velocidad — DEF=Defensa — FIS=Físico — ARQ=Arco — EQP=Trabajo en equipo</div>
            <div className="mt-1 text-[11px] opacity-80">Cada stat tiene 3 substats. Se editan en “Añadir/Editar”.</div>
          </footer>

          {/* Modales */}
          <PlayerModal player={modal} onClose={()=>setModal(null)}
                       players={players} chem={chem}
                       teamIdsA={teams?.A||[]} teamIdsB={teams?.B||[]}
                       onEditChem={(a,b,cur)=>{editChem(a,b,cur)}}/>
          {form&&<PlayerFormModal initial={form.id?form:null} onCancel={()=>setForm(null)} onSave={onSave}/>}
          {settings&&<SettingsModal onClose={()=>setSettings(false)} kChem={kChem} setKChem={setKChem}
                                    onExport={onExport} onImport={onImport} onReset={reset}
                                    parallaxOn={parallaxOn} setParallaxOn={setParallaxOn}
                                    formScale={formScale} setFormScale={setFormScale}/>}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
