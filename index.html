<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Language" content="es" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>F√∫tbol 5 - Generador</title>
  <meta name="theme-color" content="#10b981" />
  <!-- Tailwind v√≠a CDN (sin build) -->
  <script src="https://cdn.tailwindcss.com" onerror="this.onerror=null;this.src='https://unpkg.com/tailwindcss@3.4.4/dist/tailwind.min.js'"></script>
  <!-- React 18 UMD + Babel Standalone para compilar JSX en el navegador -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js'"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js'"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js'"></script>
  <!-- Base relativa: hace que ./sw.js, ./icons/ funcionen tanto en / como en /<repo>/ -->
  <base href="./" />
  <!-- Manifest: lo trataremos de cargar EST√ÅTICO si existe; si no, se inyecta din√°mico -->
  <link rel="manifest" id="dynamic-manifest-link" />
  <link rel="icon" href="./icons/icon-192.png" />
  <style> html,body{background:#0b1220;color:#e2e8f0} </style>
</head>
<body>
  <!-- Overlay de errores fatal (aparece si falla algo JS/CDN) -->
  <script>
    (function(){
      function showFatal(msg){
        var el=document.getElementById('fatal');
        if(!el){ el=document.createElement('div'); el.id='fatal'; el.style.position='fixed'; el.style.inset='0'; el.style.background='rgba(2,6,23,0.98)'; el.style.color='#fca5a5'; el.style.zIndex='99999'; el.style.padding='16px'; el.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, monospace'; el.style.overflow='auto'; document.body.appendChild(el);} 
        el.innerHTML='<div style="max-width:900px;margin:0 auto">'+
          '<h2 style="font-weight:700;margin:0 0 12px">‚ö†Ô∏è Error cargando la app</h2>'+
          '<pre style="white-space:pre-wrap">'+String(msg)+'</pre>'+
          '<p style="opacity:.9">Prob√°: recargar sin cach√© (Ctrl/Cmd+Shift+R), revisar conexi√≥n/CDNs, o decirme qu√© sale aqu√≠.</p>'+
        '</div>';
      }
      window.addEventListener('error', function(e){ showFatal((e.error&&e.error.stack)||e.message||String(e)); });
      window.addEventListener('unhandledrejection', function(e){ showFatal((e.reason&&e.reason.stack)||String(e.reason)); });
      window.__showFatal=showFatal;
    })();
  </script>

  <div id="root"><div id="boot" class="mx-auto max-w-screen-md p-3">Cargando‚Ä¶</div></div>

  <!-- Verificador de librer√≠as por si las CDNs fallan -->
  <script>
    setTimeout(function(){
      if(!window.React||!window.ReactDOM){
        (window.__showFatal||alert)('No se carg√≥ React/ReactDOM desde la CDN. ¬øBloqueador o conexi√≥n?');
      } else if(!window.Babel){
        (window.__showFatal||alert)('No se carg√≥ Babel Standalone. El JSX no puede compilarse en el navegador.');
      }
    },3000);
  </script>

  <script type="text/babel">
    const { useMemo, useState, useEffect } = React;

    // ================= PWA: manifest est√°tico o din√°mico + SW =================
    (async function ensureManifest(){
      try{
        const base = document.querySelector('base')?.getAttribute('href') || './';
        const linkEl = document.getElementById('dynamic-manifest-link');
        // 1) Intentar manifest est√°tico si existe (mejor para Lighthouse/Chrome DevTools)
        const staticUrl = base + 'manifest.webmanifest';
        try {
          const headRes = await fetch(staticUrl, { method: 'HEAD' });
          if (headRes.ok) { linkEl.setAttribute('href', staticUrl); return; }
        } catch {}
        // 2) Si no existe, inyectar din√°mico como antes
        const manifest = {
          name: 'F√∫tbol 5',
          short_name: 'Futbol5',
          start_url: base,
          display: 'standalone',
          background_color: '#0f172a',
          theme_color: '#10b981',
          icons: [
            { src: base + 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: base + 'icons/icon-512.png', sizes: '512x512', type: 'image/png' }
          ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        const url = URL.createObjectURL(blob);
        linkEl.setAttribute('href', url);
      }catch(e){ console.log('[PWA] manifest din√°mico fall√≥', e); }
    })();

    (function registerSW(){
      if ('serviceWorker' in navigator) {
        const base = document.querySelector('base')?.getAttribute('href') || './';
        // Registrar /sw.js relativo a la p√°gina actual
        const swUrl = new URL('sw.js', location.href).pathname;
        navigator.serviceWorker.register(swUrl, { scope: base }).then(
          reg => console.log('[PWA] SW OK (scope=', base, ')', reg),
          err => console.log('[PWA] SW FAIL', err)
        );
      }
    })();

    // ================= Tipos / Datos =================
    /** @typedef {{ id:string, nombre:string, fotoUrl?:string, escudoUrl?:string, equipoPropio?:string, equipoFavorito?:string, ATA:number, PAS:number, REG:number, VEL:number, DEF:number, FIS:number, ARQ:number, EQP:number, _GLOBAL?:number }} Jugador */

    /** @type {Jugador[]} */
    const SEED_JUGADORES = [
      { id: '1', nombre: 'Leo',  equipoPropio: 'La 10', equipoFavorito: 'Barcelona',   fotoUrl: 'https://i.pravatar.cc/150?img=1',  ATA:10,PAS:9, REG:10,VEL:9, DEF:4, FIS:7, ARQ:3, EQP:8 },
      { id: '2', nombre: 'Fabi', equipoPropio: 'La 10', equipoFavorito: 'Col√≥n',       fotoUrl: 'https://i.pravatar.cc/150?img=6',  ATA:7, PAS:8, REG:7, VEL:7, DEF:7, FIS:7, ARQ:4, EQP:9 },
      { id: '3', nombre: 'Cuti', equipoPropio: 'Muralla', equipoFavorito: 'Belgrano',   fotoUrl: 'https://i.pravatar.cc/150?img=4',  ATA:5, PAS:6, REG:5, VEL:7, DEF:10,FIS:9, ARQ:4, EQP:7 },
      { id: '4', nombre: 'Dibu', equipoPropio: 'Muralla', equipoFavorito: 'Arsenal',    fotoUrl: 'https://i.pravatar.cc/150?img=5',  ATA:3, PAS:5, REG:4, VEL:5, DEF:8, FIS:8, ARQ:10,EQP:7 },
      { id: '5', nombre: 'Papu', equipoPropio: 'Tiki',    equipoFavorito: 'San Lorenzo', fotoUrl: 'https://i.pravatar.cc/150?img=9',  ATA:8, PAS:8, REG:9, VEL:8, DEF:5, FIS:6, ARQ:3, EQP:7 },
      { id: '6', nombre: 'Nico', equipoPropio: 'Tiki',    equipoFavorito: 'Boca',       fotoUrl: 'https://i.pravatar.cc/150?img=8',  ATA:7, PAS:7, REG:7, VEL:8, DEF:6, FIS:7, ARQ:4, EQP:6 },
      { id: '7', nombre: 'Chino',equipoPropio: 'Muralla', equipoFavorito: "Newell's",  fotoUrl: 'https://i.pravatar.cc/150?img=10', ATA:5, PAS:6, REG:5, VEL:6, DEF:8, FIS:7, ARQ:8, EQP:6 },
      { id: '8', nombre: 'Joa',  equipoPropio: 'La 10', equipoFavorito: 'River',       fotoUrl: 'https://i.pravatar.cc/150?img=7',  ATA:6, PAS:6, REG:6, VEL:7, DEF:8, FIS:8, ARQ:5, EQP:7 },
      { id: '9', nombre: 'Fideo',equipoPropio: 'Tiki',    equipoFavorito: 'Rosario C.', fotoUrl: 'https://i.pravatar.cc/150?img=3',  ATA:8, PAS:9, REG:9, VEL:8, DEF:6, FIS:6, ARQ:3, EQP:8 },
      { id: '10',nombre: 'Kuni', equipoPropio: 'La 10', equipoFavorito: 'Independiente',fotoUrl: 'https://i.pravatar.cc/150?img=2',  ATA:9, PAS:7, REG:8, VEL:9, DEF:5, FIS:7, ARQ:3, EQP:7 },
      { id: '11',nombre: 'Tomi', equipoPropio: 'Muralla', equipoFavorito: 'Talleres',   fotoUrl: 'https://i.pravatar.cc/150?img=11', ATA:6, PAS:7, REG:6, VEL:7, DEF:7, FIS:7, ARQ:5, EQP:6 },
      { id: '12',nombre: 'Gonza',equipoPropio: 'Tiki',    equipoFavorito: 'Racing',     fotoUrl: 'https://i.pravatar.cc/150?img=12', ATA:7, PAS:6, REG:7, VEL:8, DEF:6, FIS:7, ARQ:4, EQP:6 },
    ];

    const STAT_KEYS = ['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
    const STAT_LABEL = { ATA:'Ataque', PAS:'Pase', REG:'Regate', VEL:'Velocidad', DEF:'Defensa', FIS:'F√≠sico', ARQ:'Arco', EQP:'Equipo' };
    const TEAM_COLORS = {
      A: { stroke: 'rgba(16,185,129,1)', fill: 'rgba(16,185,129,0.18)', dotClass: 'bg-emerald-500', hex: '#10b981' },
      B: { stroke: 'rgba(59,130,246,1)', fill: 'rgba(59,130,246,0.18)', dotClass: 'bg-blue-500',    hex: '#3b82f6' },
    };
    const WEIGHTS = { ATA:0.18, DEF:0.16, PAS:0.14, REG:0.14, VEL:0.14, FIS:0.10, ARQ:0.07, EQP:0.07 };
    const K_CHEM = 0.6;

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const avg = (arr) => (arr.length ? arr.reduce((p,c)=>p+c,0)/arr.length : 0);
    const globalOf = (p) => { let s=0,w=0; for (const k of Object.keys(WEIGHTS)){ s+=(p[k]||0)*WEIGHTS[k]; w+=WEIGHTS[k]; } return Number((s/w).toFixed(2)); };

    const buildChemistry = (players) => {
      const q={};
      for(const a of players){ q[a.id]={}; for(const b of players){ if(a.id===b.id){q[a.id][b.id]=10; continue;} if(q[b.id]?.[a.id]!=null){ q[a.id][b.id]=q[b.id][a.id]; continue;} let v=5; if(a.equipoPropio&&b.equipoPropio&&a.equipoPropio===b.equipoPropio) v+=1.2; if(a.equipoFavorito&&b.equipoFavorito&&a.equipoFavorito===b.equipoFavorito) v+=0.8; const eqpBonus=((a.EQP+b.EQP)/2 - 5)*0.15; v+=eqpBonus; q[a.id][b.id]=clamp(Number(v.toFixed(2)),1,10);} }
      return q;
    };
    const teamChemistry = (ids, chem) => { if(ids.length<=1) return 10; let t=0,p=0; for(let i=0;i<ids.length;i++) for(let j=i+1;j<ids.length;j++){ t+= chem[ids[i]]?.[ids[j]] ?? 5; p++; } return Number((t/(p||1)).toFixed(2)); };
    const teamGlobal = (ids, map) => Number(avg(ids.map(id=>map[id]._GLOBAL)).toFixed(2));
    const teamScore  = (ids, map, chem) => Number((teamGlobal(ids,map)+teamChemistry(ids,chem)*K_CHEM).toFixed(2));
    const randomSplit = (ids) => { const s=[...ids].sort(()=>Math.random()-0.5); const m=Math.floor(s.length/2); return [s.slice(0,m), s.slice(m)]; };
    const scoreDiff = (A,B,map,chem) => { const sA=teamScore(A,map,chem), sB=teamScore(B,map,chem); return {A:[...A],B:[...B],diff:Math.abs(sA-sB),m:{sA,sB}}; };
    const balancedSplit = (ids,map,chem) => { let [A,B]=randomSplit(ids); let best=scoreDiff(A,B,map,chem); const iter=900; for(let t=0;t<iter;t++){ const i=Math.floor(Math.random()*A.length), j=Math.floor(Math.random()*B.length); [A[i],B[j]]=[B[j],A[i]]; const cur=scoreDiff(A,B,map,chem); if(cur.diff<=best.diff || Math.random()<0.12){ best=cur; } else { [A[i],B[j]]=[B[j],A[i]]; } } return { A:best.A, B:best.B, m:best.m }; };

    const Pill = ({ children, className='' }) => <span className={`inline-block rounded-full px-2 py-0.5 text-xs ${className}`}>{children}</span>;

    function PlayerRow({ p, selected, onToggle, onOpen }){
      return (
        <div className="flex items-center gap-3 rounded-xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <img src={p.fotoUrl} alt={p.nombre} className="h-10 w-10 rounded-full object-cover ring-1 ring-slate-700" />
          <div className="min-w-0 flex-1">
            <div className="flex items-center justify-between">
              <button onClick={onOpen} className="min-w-0 text-left">
                <div className="truncate text-base font-semibold">{p.nombre}</div>
                <div className="mt-0.5 flex flex-wrap items-center gap-1 text-xs text-slate-400">
                  <Pill className="bg-slate-800/80 text-slate-200">Global: {p._GLOBAL}</Pill>
                  {p.equipoPropio && <Pill className="bg-indigo-600/20 text-indigo-200">Propio: {p.equipoPropio}</Pill>}
                  {p.equipoFavorito && <Pill className="bg-cyan-600/20 text-cyan-200">Fav: {p.equipoFavorito}</Pill>}
                </div>
              </button>
              <button onClick={onToggle} className={`ml-3 rounded-xl px-3 py-1 text-sm ring-1 ${selected ? 'bg-emerald-600 text-white ring-emerald-500' : 'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>
                {selected ? '‚úì Convocado' : '+ Convocar'}
              </button>
            </div>
            <div className="mt-2 grid grid-cols-4 gap-1 text-[11px] text-slate-300">
              {STAT_KEYS.map(k => (
                <div key={k} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1">
                  <span className="font-medium" title={STAT_LABEL[k]}>{k}</span>
                  <span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function TeamCard({ title, teamKey, ids, map, chem, onOpenPlayer }){
      const g = teamGlobal(ids, map);
      const c = teamChemistry(ids, chem);
      const s = teamScore(ids, map, chem);
      const color = TEAM_COLORS[teamKey] || TEAM_COLORS.A;
      return (
        <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <div className="mb-2 flex items-center justify-between">
            <h3 className="flex items-center gap-2 text-base font-semibold">
              <span className={`h-2.5 w-2.5 rounded-full ${color.dotClass}`} /> {title}
            </h3>
            <div className="text-xs text-slate-400">Jugadores: {ids.length}</div>
          </div>
          <div className="mb-3 grid grid-cols-3 gap-2 text-sm">
            <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Global</div><div className="text-lg font-bold">{g}</div></div>
            <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Qu√≠mica</div><div className="text-lg font-bold">{c}</div></div>
            <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Score</div><div className="text-lg font-bold">{s}</div></div>
          </div>
          <ul className="space-y-1 text-sm">
            {ids.map(id => (
              <li key={id} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1">
                <button onClick={()=>onOpenPlayer(map[id])} className="truncate text-left hover:underline">{map[id].nombre}</button>
                <span className="text-slate-300">G:{map[id]._GLOBAL} - EQP:{map[id].EQP}</span>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    function RadarChart({ size=260, max=10, keys=STAT_KEYS, dataSeries }){
      const cx = size/2, cy = size/2, r = size*0.4; const N = keys.length;
      const angleFor = (i) => (Math.PI*2 * i / N) - Math.PI/2;
      const point = (i, value) => { const a=angleFor(i); const rr=r*(value/max); return [cx+rr*Math.cos(a), cy+rr*Math.sin(a)]; };
      const gridLevels = [2,4,6,8,10];
      return (
        <svg width={size} height={size} className="mx-auto block">
          {gridLevels.map((lvl, idx)=>{ const pts = keys.map((_,i)=>point(i,lvl)).map(([x,y])=>`${x},${y}`).join(' '); return <polygon key={idx} points={pts} fill="none" stroke="rgba(148,163,184,0.25)" strokeWidth={1}/>; })}
          {keys.map((k,i)=>{ const [x,y]=point(i,max); return <line key={k} x1={cx} y1={cy} x2={x} y2={y} stroke="rgba(148,163,184,0.3)" strokeWidth={1}/>; })}
          {keys.map((k,i)=>{ const [x,y]=point(i,max+0.9); return <text key={k} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize={11} fill="#cbd5e1">{k}</text>; })}
          {dataSeries.map((s,idx)=>{ const pts = keys.map((k,i)=>point(i,s.values[k]??0)).map(([x,y])=>`${x},${y}`).join(' '); return (<g key={idx}><polygon points={pts} fill={s.fill} stroke={s.stroke} strokeWidth={2}/></g>); })}
        </svg>
      );
    }

    function BarsChart({ values, max=10, accent }){
      const color = accent || '#22d3ee';
      return (
        <div className="space-y-2">
          {STAT_KEYS.map(k=> (
            <div key={k}>
              <div className="mb-1 flex items-center justify-between text-sm">
                <span className="text-slate-300" title={STAT_LABEL[k]}>{k}</span>
                <span className="font-semibold">{values[k]}</span>
              </div>
              <div className="h-2 w-full rounded bg-slate-700">
                <div className="h-2 rounded" style={{ width: `${Math.max(0, Math.min(100, (values[k]/max)*100))}%`, backgroundColor: color }} />
              </div>
            </div>
          ))}
        </div>
      );
    }

    function PlayerModal({ player, onClose }){
      const [mode, setMode] = useState('radar');
      if (!player) return null;
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
          <div className="w-full max-w-md rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
            <div className="mb-2 flex items-center gap-3">
              <img src={player.fotoUrl} alt={player.nombre} className="h-12 w-12 rounded-xl object-cover ring-1 ring-slate-700" />
              <div className="min-w-0">
                <div className="truncate text-lg font-semibold">{player.nombre}</div>
                <div className="text-xs text-slate-400">Global: {player._GLOBAL} - Propio: {player.equipoPropio||'-'} - Fav: {player.equipoFavorito||'-'}</div>
              </div>
              <button onClick={onClose} className="ml-auto rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
            </div>
            <div className="mb-3 flex gap-2">
              <button onClick={()=>setMode('radar')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='radar'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Radar</button>
              <button onClick={()=>setMode('barras')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='barras'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Barras</button>
            </div>
            {mode==='radar' ? (
              <RadarChart dataSeries={[{ label: player.nombre, values: player, stroke:'rgba(34,211,238,1)', fill:'rgba(34,211,238,0.18)' }]} />
            ) : (
              <BarsChart values={player} />
            )}
          </div>
        </div>
      );
    }

    function teamAverages(ids, map){ const out={}; STAT_KEYS.forEach(k=>{ out[k]= Number(avg(ids.map(id=>map[id][k])).toFixed(2)); }); return out; }

    function TeamRadarCompare({ A, B, map }){
      const avgA = teamAverages(A, map);
      const avgB = teamAverages(B, map);
      return (
        <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
          <div className="mb-2 text-center text-sm text-slate-300">Radar comparativo (promedio por stat)</div>
          <RadarChart dataSeries={[
            { label:'A', values: avgA, stroke: TEAM_COLORS.A.stroke, fill: TEAM_COLORS.A.fill },
            { label:'B', values: avgB, stroke: TEAM_COLORS.B.stroke, fill: TEAM_COLORS.B.fill },
          ]} />
          <div className="mt-2 flex justify-center gap-4 text-xs text-slate-300">
            <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TEAM_COLORS.A.dotClass}`}></span> Equipo A</span>
            <span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TEAM_COLORS.B.dotClass}`}></span> Equipo B</span>
          </div>
        </div>
      );
    }

    function BalanceIndicator({ A, B, map, chem }){
      const sA = teamScore(A, map, chem);
      const sB = teamScore(B, map, chem);
      const diff = Number(Math.abs(sA - sB).toFixed(2));
      let label='Parejo', classes='bg-emerald-600/15 text-emerald-200 ring-emerald-500/30';
      if (diff >= 0.8) { label='Desbalanceado'; classes='bg-rose-600/15 text-rose-200 ring-rose-500/30'; }
      else if (diff >= 0.3) { label='Aceptable'; classes='bg-amber-600/15 text-amber-100 ring-amber-500/30'; }
      return (
        <div className={`rounded-2xl p-3 ring-1 ${classes}`}>
          <div className="flex items-center justify-between text-sm">
            <div className="font-semibold">Balance del partido</div>
            <div className="text-xs opacity-80">Diff: {diff}</div>
          </div>
          <div className="mt-1 text-sm">Resultado: <span className="font-semibold">{label}</span> <span className="opacity-80">(A: {sA} vs B: {sB})</span></div>
          <div className="mt-1 text-xs opacity-80">Umbrales: Parejo &lt; 0.30 - Aceptable &lt; 0.80 - Desbalanceado ‚â• 0.80</div>
      );
    }

    function TeamMiniSummary({ ids, map, chem }){
      const g = teamGlobal(ids, map);
      const c = teamChemistry(ids, chem);
      const s = teamScore(ids, map, chem);
      return (
        <div className="grid grid-cols-3 gap-1 text-center">
          <div>
            <div className="text-slate-400 text-xs">Global</div>
            <div className="font-bold">{g}</div>
          </div>
          <div>
            <div className="text-slate-400 text-xs">Qu√≠mica</div>
            <div className="font-bold">{c}</div>
          </div>
          <div>
            <div className="text-slate-400 text-xs">Score</div>
            <div className="font-bold">{s}</div>
          </div>
        </div>
      );
    }

    function App(){
      const players = useMemo(()=> SEED_JUGADORES.map(p=> ({...p, _GLOBAL: globalOf(p)})), []);
      const map = useMemo(()=> Object.fromEntries(players.map(p=>[p.id,p])), [players]);
      const chem = useMemo(()=> buildChemistry(players), [players]);

      const [selected, setSelected] = useState(()=> new Set());
      const [teams, setTeams] = useState(null);
      const [tab, setTab] = useState('partido');
      const [modalPlayer, setModalPlayer] = useState(null);

      // Bot√≥n de instalar universal (Android muestra prompt, iOS muestra instrucciones)
      const [deferredPrompt, setDeferredPrompt] = useState(null);
      const [showInstallInfo, setShowInstallInfo] = useState(false);
      const [swReady, setSwReady] = useState(false);
      const [hasManifest, setHasManifest] = useState(false);

      useEffect(()=>{
        const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); };
        window.addEventListener('beforeinstallprompt', handler);
        // estado SW + manifest
        if (navigator.serviceWorker?.getRegistration) {
          navigator.serviceWorker.getRegistration().then(r => setSwReady(!!r));
        }
        setHasManifest(!!document.querySelector('link[rel="manifest"][href]'));
        return () => window.removeEventListener('beforeinstallprompt', handler);
      },[]);

      const convocados = Array.from(selected);
      const canMake = convocados.length === 10;
      const toggleSelect = (id) => setSelected(prev => { const n=new Set(prev); n.has(id)?n.delete(id):n.add(id); return n; });
      const makeRandom   = () => { if (!canMake) return; const [A,B] = randomSplit(convocados); setTeams({A,B}); };
      const makeBalanced = () => { if (!canMake) return; const {A,B} = balancedSplit(convocados,map,chem); setTeams({A,B}); };

      useEffect(()=>{ runDevTests(players, map, chem); },[players, map, chem]);

      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isAndroid = /android/i.test(navigator.userAgent);

      const onInstallClick = async () => {
        if (deferredPrompt) {
          try { await deferredPrompt.prompt(); await deferredPrompt.userChoice; } catch {} finally { setDeferredPrompt(null); }
        } else {
          setShowInstallInfo(true);
        }
      };

      return (
        <div className="mx-auto max-w-screen-md p-3 text-slate-100">
          <header className="sticky top-0 z-10 mb-3 rounded-xl bg-slate-950/90 p-3 ring-1 ring-slate-800 backdrop-blur">
            <div className="flex items-center justify-between">
              <h1 className="text-lg font-bold">F√∫tbol 5 - Generador</h1>
              <div className={`rounded-xl px-3 py-1 text-sm ring-1 ${convocados.length<10?'bg-amber-600/20 text-amber-200 ring-amber-500/40': convocados.length>10?'bg-rose-600/20 text-rose-200 ring-rose-500/40':'bg-emerald-600/20 text-emerald-200 ring-emerald-500/40'}`}>
                Convocados: {convocados.length}/10
              </div>
            </div>
            <nav className="mt-2 grid grid-cols-2 gap-2">
              <button onClick={()=>setTab('partido')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='partido'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>‚öΩ Partido</button>
              <button onClick={()=>setTab('plantel')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='plantel'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>üë• Plantel</button>
            </nav>
            {tab==='partido' && teams && (
              <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800"><div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TEAM_COLORS.A.dotClass}`} />Equipo A</div><TeamMiniSummary ids={teams.A} map={map} chem={chem}/></div>
                <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800"><div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TEAM_COLORS.B.dotClass}`} />Equipo B</div><TeamMiniSummary ids={teams.B} map={map} chem={chem}/></div>
              </div>
            )}
          </header>

          {tab==='plantel' ? (
            <section className="space-y-2">
              {players.map(p => (
                <PlayerRow key={p.id} p={p} selected={selected.has(p.id)} onToggle={()=>toggleSelect(p.id)} onOpen={()=>setModalPlayer(p)} />
              ))}
            </section>
          ) : (
            <section className="space-y-3">
              {!canMake && (
                <div className="rounded-xl bg-amber-600/15 p-3 text-amber-100 ring-1 ring-amber-600/30">
                  Necesit√°s exactamente 10 convocados. Elegilos en la pesta√±a <span className="font-semibold">Plantel</span>.
                </div>
              )}

              {teams && (
                <>
                  <TeamCard title="Equipo A" teamKey="A" ids={teams.A} map={map} chem={chem} onOpenPlayer={(p)=>setModalPlayer(p)} />
                  <TeamCard title="Equipo B" teamKey="B" ids={teams.B} map={map} chem={chem} onOpenPlayer={(p)=>setModalPlayer(p)} />

                  <BalanceIndicator A={teams.A} B={teams.B} map={map} chem={chem} />

                  <TeamRadarCompare A={teams.A} B={teams.B} map={map} />
                  <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
                    <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                      <div className="mb-2 font-semibold">Barras - Equipo A (promedios)</div>
                      <BarsChart values={teamAverages(teams.A, map)} accent={TEAM_COLORS.A.hex} />
                    </div>
                    <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
                      <div className="mb-2 font-semibold">Barras - Equipo B (promedios)</div>
                      <BarsChart values={teamAverages(teams.B, map)} accent={TEAM_COLORS.B.hex} />
                    </div>
                  </div>
                </>
              )}
            </section>
          )}

          {tab==='partido' && (
            <div className="sticky bottom-2 mt-4 grid grid-cols-2 gap-2">
              <button onClick={makeRandom} disabled={!canMake} className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${canMake?'bg-slate-800 text-slate-100 ring-slate-700 hover:bg-slate-700':'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed'}`}>üé≤ Azar</button>
              <button onClick={makeBalanced} disabled={!canMake} className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${canMake?'bg-emerald-600 text-white ring-emerald-500 hover:bg-emerald-500':'bg-emerald-600/40 text-emerald-200 ring-emerald-800 cursor-not-allowed'}`}>‚öñÔ∏è Equilibrado</button>
            </div>
          )}

          {/* Bot√≥n flotante SIEMPRE visible */}
          {!isStandalone && (
            <button onClick={onInstallClick} className="fixed bottom-20 right-3 z-50 rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-lg ring-1 ring-emerald-500 hover:bg-emerald-500">üì≤ Instalar</button>
          )}

          {/* Modal de ayuda de instalaci√≥n */}
          {showInstallInfo && (
            <div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={()=>setShowInstallInfo(false)}>
              <div className="w-full max-w-md rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
                <div className="mb-2 text-lg font-semibold">Instalar como app</div>
                <div className="space-y-2 text-sm text-slate-300">
                  <div><span className="font-semibold">Estado PWA:</span> SW: {swReady? 'ok':'faltante'} - Manifest: {hasManifest? 'ok':'faltante'}</div>
                  {isAndroid && (
                    <div>
                      <div className="font-semibold">Android (Chrome)</div>
                      <ol className="list-decimal pl-5 space-y-1">
                        <li>Asegurate de tener <code>/sw.js</code> y <code>/icons/</code> subidos.</li>
                        <li>Si no aparece el prompt autom√°tico, abr√≠ el men√∫ (‚ãÆ) y eleg√≠ <b>Agregar a pantalla de inicio</b>.</li>
                      </ol>
                    </div>
                  )}
                  {isIOS && (
                    <div>
                      <div className="font-semibold">iOS (Safari)</div>
                      <ol className="list-decimal pl-5 space-y-1">
                        <li>Toc√° <b>Compartir</b> y luego <b>A√±adir a pantalla de inicio</b>.</li>
                        <li>iOS no muestra bot√≥n de instalar autom√°tico por pol√≠tica de Apple.</li>
                      </ol>
                    </div>
                  )}
                  {!isAndroid && !isIOS && (
                    <div>Pod√©s instalar desde el men√∫ del navegador: <b>Instalar app</b> o <b>Agregar a pantalla de inicio</b>.</div>
                  )}
                </div>
                <div className="mt-4 text-right">
                  <button onClick={()=>setShowInstallInfo(false)} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
                </div>
              </div>
            </div>
          )}

          <footer className="mt-6 rounded-xl bg-slate-900/60 p-3 text-[12px] text-slate-300 ring-1 ring-slate-800">
            <div className="font-semibold">Leyenda:</div>
            <div>ATA=Ataque - PAS=Pase - REG=Regate - VEL=Velocidad - DEF=Defensa - FIS=F√≠sico - ARQ=Arco - EQP=Trabajo en equipo</div>
          </footer>

          <PlayerModal player={modalPlayer} onClose={()=>setModalPlayer(null)} />
        </div>
      );
    }

    // ================= DEV TESTS =================
    function runDevTests(players, map, chem){
      try{
        const log=(...a)=>console.log('[DEV TEST]',...a);
        const assert=(c,m)=>{ if(!c) console.error('[DEV TEST FAIL]',m); else log('OK:',m); };
        const g0 = globalOf(players[0]);
        assert(g0>=1 && g0<=10, `global jugador[0] dentro de 1..10 (g0=${g0})`);
        const ids10 = players.slice(0,10).map(p=>p.id); const [ra,rb]=randomSplit(ids10); assert(ra.length===5 && rb.length===5, `randomSplit 5/5 (got ${ra.length}/${rb.length})`);
        const {A:ba, B:bb, m:{sA, sB}} = balancedSplit(ids10, map, chem); assert(ba.length===5 && bb.length===5, 'balancedSplit 5/5'); const diff=Math.abs(sA-sB); assert(diff>=0, `balancedSplit diff>=0 (${diff.toFixed(2)})`);
        const qc = teamChemistry(ba, chem); assert(qc>=1 && qc<=10, `teamChemistry 1..10 (${qc})`);
        const sc = teamScore(ba, map, chem); const gg = teamGlobal(ba, map); assert(Number.isFinite(sc), `teamScore finito (${sc})`); assert(sc >= gg + 0.6, `teamScore (${sc}) >= teamGlobal (${gg}) + 0.6`);
        const ta = teamAverages(ba, map); assert(STAT_KEYS.every(k=>typeof ta[k]==='number'), `teamAverages claves num√©ricas (${JSON.stringify(ta)})`);
        const a=players[0].id, b=players[1].id; assert(chem[a][b]===chem[b][a], `qu√≠mica sim√©trica (chem[${a}][${b}]==chem[${b}][${a}])`);
        const ids12 = players.map(p=>p.id); const [r12a,r12b]=randomSplit(ids12); assert(r12a.length===6 && r12b.length===6, `randomSplit 12‚Üí6/6 (got ${r12a.length}/${r12b.length})`);
        const before = JSON.stringify(ids10); balancedSplit(ids10, map, chem); const after = JSON.stringify(ids10); assert(before===after, 'balancedSplit no muta input');
        // Nuevos tests
        const okRange = players.every(p=> STAT_KEYS.every(k=> p[k] >= 1 && p[k] <= 10));
        assert(okRange, 'todos los stats est√°n en 1..10');
        const diagOk = players.every(p=> chem[p.id][p.id] === 10);
        assert(diagOk, 'qu√≠mica propia = 10 para cada jugador');
        const avgCheck = teamAverages(players.slice(0,5).map(p=>p.id), map);
        assert(STAT_KEYS.every(k=> Number.isFinite(avgCheck[k])), 'teamAverages no produce NaN');
      }catch(err){ console.error('[DEV TEST ERROR]', err); }
    }

    // Montaje
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>

</body>
</html>
