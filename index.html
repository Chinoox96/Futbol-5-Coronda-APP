<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>F√∫tbol 5</title>
  <meta name="theme-color" content="#10b981"/>
  <link rel="manifest" id="mf"/>

  <!-- Tailwind + React + Babel (modo simple) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{ --bg-y: 0px; --pitch-darken: .55; }
    html,body{background:#0b1220;color:#e2e8f0;margin:0;overflow-x:hidden}
    /* Parallax: c√©sped que se desplaza al scrollear */
    body::before{
      content:""; position:fixed; inset:0;
      background-image:url('./assets/cesped.jpg');
      background-size:cover; background-repeat:no-repeat;
      background-position:center var(--bg-y);
      will-change:background-position;
      z-index:-2;
    }
    /* Oscurecer para que el contenido sea legible sobre el c√©sped */
    body::after{ content:""; position:fixed; inset:0;
      background: rgba(11,18,32,var(--pitch-darken)); z-index:-1;
    }
    img,svg{max-width:100%;height:auto}
  </style>
</head>
<body>
<div id="root"></div>

<!-- Parallax controlador -->
<script>
  // Desplaza el fondo m√°s lento que el scroll (0.4x)
  window.addEventListener('scroll', ()=>{
    document.documentElement.style.setProperty('--bg-y', (window.scrollY*0.4)+'px');
  }, {passive:true});
</script>

<!-- Manifest + Service Worker (auto) -->
<script>
(async()=>{
  try{
    const base = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/[^/]+$/,'');
    const link = document.getElementById('mf');

    // Crea √≠conos de fallback (canvas) si no existen
    const makeIcon=(n,c)=>{const a=document.createElement('canvas');a.width=a.height=n;const x=a.getContext('2d');x.fillStyle=c;x.fillRect(0,0,n,n);x.fillStyle='#0b1220';x.textAlign='center';x.textBaseline='middle';x.font=`${Math.floor(n*.42)}px sans-serif`;x.fillText('F5',n/2,n/2);return a.toDataURL('image/png')};

    const manifest={
      name:'F√∫tbol 5', short_name:'Futbol5',
      start_url:base, scope:base, display:'standalone',
      background_color:'#0f172a', theme_color:'#10b981',
      icons:[
        {src:`${base}icons/icon-192.png`,sizes:'192x192',type:'image/png'},
        {src:`${base}icons/icon-512.png`,sizes:'512x512',type:'image/png'}
      ]
    };

    try{
      const r1=await fetch(`${base}icons/icon-192.png`,{method:'HEAD'});
      const r2=await fetch(`${base}icons/icon-512.png`,{method:'HEAD'});
      if(!r1.ok||!r2.ok) throw new Error('icons missing');
    }catch{
      manifest.icons=[
        {src:makeIcon(192,'#10b981'),sizes:'192x192',type:'image/png'},
        {src:makeIcon(512,'#10b981'),sizes:'512x512',type:'image/png'}
      ];
    }

    const blob=new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    link.href=URL.createObjectURL(blob);

    if('serviceWorker' in navigator){
      navigator.serviceWorker.register(`${base}sw.js`,{scope:base}).catch(()=>{});
    }
  }catch(e){ console.log('[PWA]',e) }
})();
</script>

<!-- APP React -->
<script type="text/babel">
const {useMemo,useState,useEffect,useRef} = React;

/* ---------- Config/const ---------- */
const STAT=['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
const SL={ATA:'Ataque',PAS:'Pase',REG:'Regate',VEL:'Velocidad',DEF:'Defensa',FIS:'F√≠sico',ARQ:'Arco',EQP:'Equipo'};
const TC={A:{stroke:'rgba(16,185,129,1)',fill:'rgba(16,185,129,0.18)',dot:'bg-emerald-500',hex:'#10b981'},B:{stroke:'rgba(59,130,246,1)',fill:'rgba(59,130,246,0.18)',dot:'bg-blue-500',hex:'#3b82f6'}};
const W={ATA:.18,DEF:.16,PAS:.14,REG:.14,VEL:.14,FIS:.10,ARQ:.07,EQP:.07};
const K=0.6;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const avg=a=>a.length?a.reduce((p,c)=>p+c,0)/a.length:0;
const globalOf=p=>{let s=0,w=0;for(const k in W){s+=(p[k]||0)*W[k];w+=W[k]}return +(s/w).toFixed(2)};

/* ---------- Seed ---------- */
const SEED=[
{id:'1',nombre:'Leo',equipoPropio:'La 10',equipoFavorito:'Barcelona',fotoUrl:'https://i.pravatar.cc/150?img=1',ATA:10,PAS:9,REG:10,VEL:9,DEF:4,FIS:7,ARQ:3,EQP:8},
{id:'2',nombre:'Fabi',equipoPropio:'La 10',equipoFavorito:'Col√≥n',fotoUrl:'https://i.pravatar.cc/150?img=6',ATA:7,PAS:8,REG:7,VEL:7,DEF:7,FIS:7,ARQ:4,EQP:9},
{id:'3',nombre:'Cuti',equipoPropio:'Muralla',equipoFavorito:'Belgrano',fotoUrl:'https://i.pravatar.cc/150?img=4',ATA:5,PAS:6,REG:5,VEL:7,DEF:10,FIS:9,ARQ:4,EQP:7},
{id:'4',nombre:'Dibu',equipoPropio:'Muralla',equipoFavorito:'Arsenal',fotoUrl:'https://i.pravatar.cc/150?img=5',ATA:3,PAS:5,REG:4,VEL:5,DEF:8,FIS:8,ARQ:10,EQP:7},
{id:'5',nombre:'Papu',equipoPropio:'Tiki',equipoFavorito:'San Lorenzo',fotoUrl:'https://i.pravatar.cc/150?img=9',ATA:8,PAS:8,REG:9,VEL:8,DEF:5,FIS:6,ARQ:3,EQP:7},
{id:'6',nombre:'Nico',equipoPropio:'Tiki',equipoFavorito:'Boca',fotoUrl:'https://i.pravatar.cc/150?img=8',ATA:7,PAS:7,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6},
{id:'7',nombre:'Chino',equipoPropio:'Muralla',equipoFavorito:"Newell's",fotoUrl:'https://i.pravatar.cc/150?img=10',ATA:5,PAS:6,REG:5,VEL:6,DEF:8,FIS:7,ARQ:8,EQP:6},
{id:'8',nombre:'Joa',equipoPropio:'La 10',equipoFavorito:'River',fotoUrl:'https://i.pravatar.cc/150?img=7',ATA:6,PAS:6,REG:6,VEL:7,DEF:8,FIS:8,ARQ:5,EQP:7},
{id:'9',nombre:'Fideo',equipoPropio:'Tiki',equipoFavorito:'Rosario C.',fotoUrl:'https://i.pravatar.cc/150?img=3',ATA:8,PAS:9,REG:9,VEL:8,DEF:6,FIS:6,ARQ:3,EQP:8},
{id:'10',nombre:'Kuni',equipoPropio:'La 10',equipoFavorito:'Independiente',fotoUrl:'https://i.pravatar.cc/150?img=2',ATA:9,PAS:7,REG:8,VEL:9,DEF:5,FIS:7,ARQ:3,EQP:7},
{id:'11',nombre:'Tomi',equipoPropio:'Muralla',equipoFavorito:'Talleres',fotoUrl:'https://i.pravatar.cc/150?img=11',ATA:6,PAS:7,REG:6,VEL:7,DEF:7,FIS:7,ARQ:5,EQP:6},
{id:'12',nombre:'Gonza',equipoPropio:'Tiki',equipoFavorito:'Racing',fotoUrl:'https://i.pravatar.cc/150?img=12',ATA:7,PAS:6,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6}
];

/* ---------- Storage keys ---------- */
const KEYS={
  players:'f5.players', selected:'f5.selected', teams:'f5.teams',
  kchem:'f5.kchem', pins:'f5.pins', overrides:'f5.chemOverrides', history:'f5.history'
};
const J=(s,d)=>{try{return JSON.parse(s)}catch{return d}};
const withG=a=>a.map(p=>({...p,_GLOBAL:globalOf(p)}));

/* ---------- Qu√≠mica ---------- */
const normPair=(a,b)=> a<b ? a+'|'+b : b+'|'+a;
const chemBuild=(arr,overrides={})=>{
  const q={};
  for(const a of arr){
    q[a.id]={};
    for(const b of arr){
      if(a.id===b.id){ q[a.id][b.id]=10; continue }
      if(q[b.id]?.[a.id]!=null){ q[a.id][b.id]=q[b.id][a.id]; continue }
      const key=normPair(a.id,b.id);
      if(key in overrides){ q[a.id][b.id]=clamp(+overrides[key],1,10); continue }
      let v=5;
      if(a.equipoPropio && b.equipoPropio && a.equipoPropio===b.equipoPropio) v+=1.2;
      if(a.equipoFavorito && b.equipoFavorito && a.equipoFavorito===b.equipoFavorito) v+=0.8;
      v+=(((a.EQP+b.EQP)/2)-5)*0.15;
      q[a.id][b.id]=clamp(+v.toFixed(2),1,10);
    }
  }
  return q;
};
const chemTeam=(ids,chem)=>{
  if(ids.length<=1) return 10;
  let t=0,p=0;
  for(let i=0;i<ids.length;i++) for(let j=i+1;j<ids.length;j++){ t+=chem[ids[i]]?.[ids[j]]??5; p++ }
  return +(t/(p||1)).toFixed(2);
};

/* ---------- Team score ---------- */
const teamGlobal=(ids,map)=>+avg(ids.map(id=>map[id]._GLOBAL)).toFixed(2);
const teamScoreUI=(ids,map,chem,k)=>+(teamGlobal(ids,map)+chemTeam(ids,chem)*k).toFixed(2);

/* ---------- Balanceo ---------- */
const randSplit=ids=>{const s=[...ids].sort(()=>Math.random()-.5);const m=Math.floor(s.length/2);return[s.slice(0,m),s.slice(m)]};
const scoreDiff=(A,B,map,chem,k=K)=>{const sA=teamScoreUI(A,map,chem,k),sB=teamScoreUI(B,map,chem,k);return{A:[...A],B:[...B],diff:Math.abs(sA-sB),m:{sA,sB}}};
const improveSwap=(A,B,map,chem,k=K,iter=300)=>{
  let best=scoreDiff(A,B,map,chem,k);
  for(let t=0;t<iter;t++){
    const i=Math.floor(Math.random()*A.length), j=Math.floor(Math.random()*B.length);
    [A[i],B[j]]=[B[j],A[i]];
    const cur=scoreDiff(A,B,map,chem,k);
    if(cur.diff<=best.diff) best=cur; else [A[i],B[j]]=[B[j],A[i]];
  }
  return {A:best.A,B:best.B,m:best.m};
};
const balancedSimple=(ids,map,chem,k=K)=>{
  let[A,B]=randSplit(ids);
  return improveSwap(A,B,map,chem,k,600);
};
const balancedWithPins=(ids,map,chem,k,pins={})=>{
  const pinA=ids.filter(id=>pins[id]==='A');
  const pinB=ids.filter(id=>pins[id]==='B');
  if(pinA.length>5 || pinB.length>5) return null; // inv√°lido
  let A=[...pinA], B=[...pinB];
  const rest=ids.filter(id=>!pins[id]);
  // Greedy: agrega uno por uno al lado que deja menor diff (respetando cupo 5)
  for(const id of rest){
    const canA=A.length<5, canB=B.length<5;
    if(canA && !canB){ A.push(id); continue }
    if(canB && !canA){ B.push(id); continue }
    if(canA && canB){
      const dA=Math.abs(teamScoreUI([...A,id],map,chem,k)-teamScoreUI(B,map,chem,k));
      const dB=Math.abs(teamScoreUI(A,map,chem,k)-teamScoreUI([...B,id],map,chem,k));
      (dA<=dB?A:B).push(id);
    }
  }
  // Mejora por swaps (pero manteniendo pins)
  const isPinnedA=new Set(pinA), isPinnedB=new Set(pinB);
  let best=scoreDiff(A,B,map,chem,k);
  for(let t=0;t<400;t++){
    const i=Math.floor(Math.random()*A.length), j=Math.floor(Math.random()*B.length);
    const ida=A[i], idb=B[j];
    if(isPinnedA.has(ida) || isPinnedB.has(idb)) continue;
    [A[i],B[j]]=[B[j],A[i]];
    const cur=scoreDiff(A,B,map,chem,k);
    if(cur.diff<=best.diff) best=cur; else [A[i],B[j]]=[B[j],A[i]];
  }
  return {A:best.A,B:best.B,m:best.m};
};

/* ---------- UI helpers ---------- */
const Pill=({children,className=''})=> <span className={`inline-block rounded-full px-2 py-0.5 text-xs ${className}`}>{children}</span>;

/* ---------- Components ---------- */
const PlayerRow=({p,selected,onToggle,onOpen,pinA,pinB,onPin})=> (
  <div className="flex items-center gap-3 rounded-xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
    <img src={p.fotoUrl} alt={p.nombre} className="h-10 w-10 rounded-full object-cover ring-1 ring-slate-700"/>
    <div className="min-w-0 flex-1">
      <div className="flex items-center justify-between">
        <button onClick={onOpen} className="min-w-0 text-left">
          <div className="truncate text-base font-semibold">{p.nombre}</div>
          <div className="mt-0.5 flex flex-wrap items-center gap-1 text-xs text-slate-300">
            <Pill className="bg-slate-800/80 text-slate-200">Global: {p._GLOBAL}</Pill>
            {p.equipoPropio&&<Pill className="bg-indigo-600/20 text-indigo-200">Propio: {p.equipoPropio}</Pill>}
            {p.equipoFavorito&&<Pill className="bg-cyan-600/20 text-cyan-200">Fav: {p.equipoFavorito}</Pill>}
          </div>
        </button>
        <div className="flex items-center gap-2">
          <button onClick={()=>onPin('A')} title="Fijar en Equipo A" className={`rounded-lg px-2 py-1 text-xs ring-1 ${pinA?'bg-emerald-600 text-white ring-emerald-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>üìå A</button>
          <button onClick={()=>onPin('B')} title="Fijar en Equipo B" className={`rounded-lg px-2 py-1 text-xs ring-1 ${pinB?'bg-blue-600 text-white ring-blue-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>üìå B</button>
          <button onClick={onToggle} className={`rounded-xl px-3 py-1 text-sm ring-1 ${selected?'bg-emerald-600 text-white ring-emerald-500':'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'}`}>{selected?'‚úì Convocado':'+ Convocar'}</button>
        </div>
      </div>
      <div className="mt-2 grid grid-cols-4 gap-1 text-[11px] text-slate-300">{STAT.map(k=> (
        <div key={k} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1"><span className="font-medium" title={SL[k]}>{k}</span><span className="tabular-nums">{p[k]}</span></div>
      ))}</div>
    </div>
  </div>
);

const TeamCard=({title,teamKey,ids,map,chem,onOpenPlayer,kChem})=>{
  const g=teamGlobal(ids,map), c=chemTeam(ids,chem), s=teamScoreUI(ids,map,chem,kChem), col=TC[teamKey]||TC.A;
  return (<div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700">
    <div className="mb-2 flex items-center justify-between">
      <h3 className="flex items-center gap-2 text-base font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${col.dot}`} /> {title}</h3>
      <div className="text-xs text-slate-300">Jugadores: {ids.length}</div>
    </div>
    <div className="mb-3 grid grid-cols-3 gap-2 text-sm">
      <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Global</div><div className="text-lg font-bold">{g}</div></div>
      <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Qu√≠mica</div><div className="text-lg font-bold">{c}</div></div>
      <div className="rounded-xl bg-slate-800/70 p-2 text-center"><div className="text-slate-400">Score</div><div className="text-lg font-bold">{s}</div></div>
    </div>
    <ul className="space-y-1 text-sm">{ids.map(id=>(
      <li key={id} className="flex items-center justify-between rounded-lg bg-slate-800/60 px-2 py-1">
        <button onClick={()=>onOpenPlayer(map[id])} className="truncate text-left hover:underline">{map[id].nombre}</button>
        <span className="text-slate-300">G:{map[id]._GLOBAL} - EQP:{map[id].EQP}</span>
      </li>
    ))}</ul>
  </div>);
};

const RadarChart=({size,max=10,keys=STAT,dataSeries})=>{
  const w=(typeof window!=='undefined'&&window.innerWidth)||320;
  const s=size??Math.max(180,Math.min(260,Math.floor(w*.85)));
  const cx=s/2,cy=s/2,r=s*.4,N=keys.length;
  const ang=i=>Math.PI*2*i/N-Math.PI/2;
  const pt=(i,v)=>{const a=ang(i),rr=r*(v/max);return[cx+rr*Math.cos(a),cy+rr*Math.sin(a)]};
  const lv=[2,4,6,8,10];
  return (<svg viewBox={`0 0 ${s} ${s}`} width="100%" className="mx-auto block">
    {lv.map((L,i)=>{const d=keys.map((_,j)=>pt(j,L)).map(([x,y])=>`${x},${y}`).join(' ');return <polygon key={i} points={d} fill="none" stroke="rgba(148,163,184,.25)" strokeWidth={1}/>})}
    {keys.map((k,i)=>{const[x,y]=pt(i,max);return <line key={k} x1={cx} y1={cy} x2={x} y2={y} stroke="rgba(148,163,184,.3)" strokeWidth={1}/>})}
    {keys.map((k,i)=>{const[x,y]=pt(i,max+.9);return <text key={k} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize={11} fill="#cbd5e1">{k}</text>})}
    {dataSeries.map((srs,i)=>{const d=keys.map((k,j)=>pt(j,srs.values[k]??0)).map(([x,y])=>`${x},${y}`).join(' ');return(<g key={i}><polygon points={d} fill={srs.fill} stroke={srs.stroke} strokeWidth={2}/></g>)})}
  </svg>);
};

const BarsChart=({values,max=10,accent})=>{
  const c=accent||'#22d3ee';
  return (<div className="space-y-2">
    {STAT.map(k=>(<div key={k}>
      <div className="mb-1 flex items-center justify-between text-sm"><span className="text-slate-300" title={SL[k]}>{k}</span><span className="font-semibold">{values[k]}</span></div>
      <div className="h-2 w-full rounded bg-slate-700"><div className="h-2 rounded" style={{width:`${Math.max(0,Math.min(100,(values[k]/max)*100))}%`,backgroundColor:c}}/></div>
    </div>))}
  </div>);
};

const PlayerChemList=({player,players,chem,teamIdsA=[],teamIdsB=[],onEditChem})=>{
  const list=players.filter(p=>p.id!==player.id).map(p=>({
    ...p,
    _chem:chem[player.id]?.[p.id]??5,
    onA:teamIdsA.includes(p.id), onB:teamIdsB.includes(p.id)
  })).sort((a,b)=>b._chem-a._chem);
  return (<div className="max-h-72 overflow-auto space-y-1">
    {list.map(o=>(
      <div key={o.id} className={`flex items-center justify-between rounded-lg px-2 py-1 text-sm ${o.onA?'bg-emerald-600/15 ring-1 ring-emerald-500/30':o.onB?'bg-blue-600/15 ring-1 ring-blue-500/30':'bg-slate-800/60 ring-1 ring-slate-700'}`}>
        <div className="flex items-center gap-2 min-w-0"><img src={o.fotoUrl} className="h-7 w-7 rounded-full object-cover ring-1 ring-slate-700"/><span className="truncate">{o.nombre}</span></div>
        <div className="flex items-center gap-2">
          <span className="font-semibold">{o._chem}</span>
          <button onClick={()=>onEditChem(o.id)} title="Editar qu√≠mica" className="rounded-md bg-slate-700 px-2 py-0.5 text-xs hover:bg-slate-600">‚úèÔ∏è</button>
        </div>
      </div>
    ))}
  </div>);
};

const PlayerModal=({player,onClose,players,chem,teamIdsA=[],teamIdsB=[],onEditChem})=>{
  const[mode,setMode]=useState('radar');
  if(!player) return null;
  return (<div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
    <div className="w-full max-w-md rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
      <div className="mb-2 flex items-center gap-3">
        <img src={player.fotoUrl} alt={player.nombre} className="h-12 w-12 rounded-xl object-cover ring-1 ring-slate-700"/>
        <div className="min-w-0"><div className="truncate text-lg font-semibold">{player.nombre}</div>
        <div className="text-xs text-slate-300">Global: {player._GLOBAL} - Propio: {player.equipoPropio||'-'} - Fav: {player.equipoFavorito||'-'}</div></div>
        <button onClick={onClose} className="ml-auto rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
      </div>
      <div className="mb-3 flex gap-2">
        <button onClick={()=>setMode('radar')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='radar'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Radar</button>
        <button onClick={()=>setMode('barras')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='barras'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Barras</button>
        <button onClick={()=>setMode('quim')} className={`rounded-xl px-3 py-1 text-sm ring-1 ${mode==='quim'?'bg-cyan-600 text-white ring-cyan-500':'bg-slate-800 text-slate-200 ring-slate-700'}`}>Qu√≠mica</button>
      </div>
      {mode==='radar'
        ? <RadarChart dataSeries={[{label:player.nombre,values:player,stroke:'rgba(34,211,238,1)',fill:'rgba(34,211,238,0.18)'}]}/>
        : (mode==='barras'
            ? <BarsChart values={player}/>
            : <PlayerChemList player={player} players={players} chem={chem} teamIdsA={teamIdsA} teamIdsB={teamIdsB} onEditChem={onEditChem}/>
          )}
    </div>
  </div>);
};

const teamAvg=(ids,map)=>{const o={};STAT.forEach(k=>o[k]=+avg(ids.map(id=>map[id][k])).toFixed(2));return o};
const TeamRadarCompare=({A,B,map})=>{const a=teamAvg(A,map),b=teamAvg(B,map);return(<div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700"><div className="mb-2 text-center text-sm text-slate-300">Radar comparativo (promedio por stat)</div><RadarChart dataSeries={[{label:'A',values:a,stroke:TC.A.stroke,fill:TC.A.fill},{label:'B',values:b,stroke:TC.B.stroke,fill:TC.B.fill}]}/><div className="mt-2 flex justify-center gap-4 text-xs text-slate-300"><span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TC.A.dot}`}></span> Equipo A</span><span className="inline-flex items-center gap-1"><span className={`h-2 w-2 rounded-full ${TC.B.dot}`}></span> Equipo B</span></div></div>)};

const BalanceIndicator=({A,B,map,chem,kChem})=>{
  const sA=teamScoreUI(A,map,chem,kChem), sB=teamScoreUI(B,map,chem,kChem);
  const d=+Math.abs(sA-sB).toFixed(2);
  let lb='Parejo', cls='bg-emerald-600/15 text-emerald-200 ring-emerald-500/30';
  if(d>=.8){ lb='Desbalanceado'; cls='bg-rose-600/15 text-rose-200 ring-rose-500/30' }
  else if(d>=.3){ lb='Aceptable'; cls='bg-amber-600/15 text-amber-100 ring-amber-500/30' }
  return (<div className={`rounded-2xl p-3 ring-1 ${cls}`}>
    <div className="flex items-center justify-between text-sm"><div className="font-semibold">Balance del partido</div><div className="text-xs opacity-80">Diff: {d}</div></div>
    <div className="mt-1 text-sm">Resultado: <span className="font-semibold">{lb}</span> <span className="opacity-80">(A: {sA} vs B: {sB})</span></div>
    <div className="mt-1 text-xs opacity-80">Umbrales: Parejo {'<'} 0.30 - Aceptable {'<'} 0.80 - Desbalanceado ‚â• 0.80</div>
  </div>);
};

const TeamMiniSummary=({ids,map,chem,kChem})=>{
  const g=teamGlobal(ids,map), c=chemTeam(ids,chem), s=teamScoreUI(ids,map,chem,kChem);
  return(<div className="grid grid-cols-3 gap-1 text-center">
    <div><div className="text-slate-400 text-xs">Global</div><div className="font-bold">{g}</div></div>
    <div><div className="text-slate-400 text-xs">Qu√≠mica</div><div className="font-bold">{c}</div></div>
    <div><div className="text-slate-400 text-xs">Score</div><div className="font-bold">{s}</div></div>
  </div>);
};

const PlayerFormModal=({initial,onCancel,onSave})=>{
  const[form,setForm]=useState(()=>initial||{nombre:'',equipoPropio:'',equipoFavorito:'',fotoUrl:'',ATA:5,PAS:5,REG:5,VEL:5,DEF:5,FIS:5,ARQ:5,EQP:5});
  const ref=useRef(null);
  const set=(k,v)=>setForm(f=>({...f,[k]:v}));
  const onFile=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>set('fotoUrl',r.result);r.readAsDataURL(f)};
  const onSubmit=e=>{e.preventDefault();const c={...form};STAT.forEach(k=>c[k]=clamp(parseInt(c[k]||0,10),1,10));if(!c.nombre.trim())return;onSave(c)};
  return (<div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onCancel}>
    <form className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onSubmit={onSubmit} onClick={e=>e.stopPropagation()}>
      <div className="text-lg font-semibold">{initial?'Editar jugador':'A√±adir jugador'}</div>
      <div className="grid grid-cols-2 gap-2 text-sm">
        <label className="space-y-1"><span>Nombre</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.nombre} onChange={e=>set('nombre',e.target.value)} required/></label>
        <label className="space-y-1"><span>Foto URL</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.fotoUrl||''} placeholder="https://..." onChange={e=>set('fotoUrl',e.target.value)}/></label>
        <label className="space-y-1 col-span-2"><span>o subir imagen</span><input ref={ref} type="file" accept="image/*" onChange={onFile} className="w-full text-xs"/></label>
        <label className="space-y-1"><span>Equipo propio</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.equipoPropio||''} onChange={e=>set('equipoPropio',e.target.value)}/></label>
        <label className="space-y-1"><span>Equipo favorito</span><input className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form.equipoFavorito||''} onChange={e=>set('equipoFavorito',e.target.value)}/></label>
      </div>
      <div className="grid grid-cols-4 gap-2 text-sm">
        {STAT.map(k=>(<label key={k} className="space-y-1"><span title={SL[k]}>{k}</span><input type="number" min="1" max="10" className="w-full rounded bg-slate-800 p-2 ring-1 ring-slate-700" value={form[k]} onChange={e=>set(k,e.target.value)}/></label>))}
      </div>
      <div className="flex justify-end gap-2">
        <button type="button" onClick={onCancel} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cancelar</button>
        <button type="submit" className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">Guardar</button>
      </div>
    </form>
  </div>);
};

const SettingsModal=({onClose,kChem,setKChem,onExport,onImport,onReset,onShare})=>{
  const input=useRef(null);
  return (<div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
    <div className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700" onClick={e=>e.stopPropagation()}>
      <div className="mb-1 text-lg font-semibold">Ajustes</div>
      <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
        <div className="mb-1 text-sm font-semibold">Peso de Qu√≠mica en Score</div>
        <input type="range" min="0" max="1" step="0.05" value={kChem} onChange={e=>setKChem(+e.target.value)} className="w-full"/>
        <div className="text-xs text-slate-300 mt-1">k = {kChem.toFixed(2)} (UI)</div>
      </div>
      <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-2">
        <div className="text-sm font-semibold">Importar / Exportar / Compartir</div>
        <div className="flex flex-wrap gap-2">
          <button onClick={onExport} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Exportar JSON</button>
          <button onClick={()=>input.current?.click()} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Importar JSON</button>
          <input ref={input} type="file" accept="application/json" className="hidden" onChange={onImport}/>
          <button onClick={onShare} className="rounded-xl bg-cyan-600 px-3 py-1 text-sm text-white ring-1 ring-cyan-500 hover:bg-cyan-500">üîó Compartir</button>
          <button onClick={onReset} className="ml-auto rounded-xl bg-rose-700 px-3 py-1 text-sm text-white ring-1 ring-rose-500 hover:bg-rose-600">Restablecer seed</button>
        </div>
        <div className="text-xs text-slate-400">El JSON incluye fotos (base64 si subiste archivo), pins, overrides de qu√≠mica e historial.</div>
      </div>
      <div className="text-right"><button onClick={onClose} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button></div>
    </div>
  </div>);
};

const HistoryModal=({items,onClose,onRestore,onDelete})=>{
  return (<div className="fixed inset-0 z-50 grid place-items-center bg-black/50 p-3" onClick={onClose}>
    <div className="w-full max-w-md rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 space-y-2" onClick={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between">
        <div className="text-lg font-semibold">Historial de partidos</div>
        <button onClick={onClose} className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700">Cerrar</button>
      </div>
      {items.length===0 && <div className="text-sm text-slate-300">No hay guardados a√∫n.</div>}
      <ul className="space-y-2 max-h-80 overflow-auto">
        {items.map((it,idx)=>(
          <li key={it.ts} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
            <div className="flex items-center justify-between text-sm">
              <div className="font-medium">#{items.length-idx} ‚Äî {new Date(it.ts).toLocaleString()}</div>
              <div className="text-xs opacity-80">Diff {Math.abs(it.m.sA-it.m.sB).toFixed(2)}</div>
            </div>
            <div className="mt-1 grid grid-cols-2 gap-2 text-xs">
              <div className="rounded-lg bg-slate-900/70 p-2"><div className="font-semibold">A</div><div>{it.A.map(n=>it.map[n].nombre).join(', ')}</div></div>
              <div className="rounded-lg bg-slate-900/70 p-2"><div className="font-semibold">B</div><div>{it.B.map(n=>it.map[n].nombre).join(', ')}</div></div>
            </div>
            <div className="mt-2 flex gap-2">
              <button onClick={()=>onRestore(it)} className="rounded-lg bg-emerald-600 px-3 py-1 text-xs text-white ring-1 ring-emerald-500 hover:bg-emerald-500">Restaurar</button>
              <button onClick={()=>onDelete(it.ts)} className="rounded-lg bg-rose-700 px-3 py-1 text-xs text-white ring-1 ring-rose-500 hover:bg-rose-600">Borrar</button>
            </div>
          </li>
        ))}
      </ul>
    </div>
  </div>);
};

/* ---------- App ---------- */
const App=()=>{
  // estado base
  const storeP=J(localStorage.getItem(KEYS.players),null);
  const initP=withG(Array.isArray(storeP)&&storeP.length?storeP:SEED);
  const [players,setPlayers]=useState(initP);
  const [selected,setSelected]=useState(()=>new Set(J(localStorage.getItem(KEYS.selected),[])));
  const [teams,setTeams]=useState(()=>J(localStorage.getItem(KEYS.teams),null));
  const [kChem,setKChem]=useState(()=>+ (localStorage.getItem(KEYS.kchem)??K));
  const [pins,setPins]=useState(()=>J(localStorage.getItem(KEYS.pins),{}));
  const [overrides,setOverrides]=useState(()=>J(localStorage.getItem(KEYS.overrides),{}));
  const [history,setHistory]=useState(()=>J(localStorage.getItem(KEYS.history),[]));

  // derivados
  const map=useMemo(()=>Object.fromEntries(players.map(p=>[p.id,p])),[players]);
  const chem=useMemo(()=>chemBuild(players,overrides),[players,overrides]);

  // ui
  const [tab,setTab]=useState('partido');
  const [modal,setModal]=useState(null);
  const [form,setForm]=useState(null);
  const [settings,setSettings]=useState(false);
  const [deferred,setDeferred]=useState(null);
  const [showInst,setShowInst]=useState(false);
  const [query,setQuery]=useState('');
  const [sort,setSort]=useState('gdesc'); // gdesc/gasc/nombre
  const [histOpen,setHistOpen]=useState(false);

  // listeners + persistencia
  useEffect(()=>{const h=e=>{e.preventDefault();setDeferred(e)};window.addEventListener('beforeinstallprompt',h);return()=>window.removeEventListener('beforeinstallprompt',h)},[]);
  useEffect(()=>localStorage.setItem(KEYS.players,JSON.stringify(players)),[players]);
  useEffect(()=>localStorage.setItem(KEYS.selected,JSON.stringify([...selected])),[selected]);
  useEffect(()=>localStorage.setItem(KEYS.teams,JSON.stringify(teams)),[teams]);
  useEffect(()=>localStorage.setItem(KEYS.kchem,String(kChem)),[kChem]);
  useEffect(()=>localStorage.setItem(KEYS.pins,JSON.stringify(pins)),[pins]);
  useEffect(()=>localStorage.setItem(KEYS.overrides,JSON.stringify(overrides)),[overrides]);
  useEffect(()=>localStorage.setItem(KEYS.history,JSON.stringify(history)),[history]);

  const convocados=[...selected];
  const canMake=convocados.length===10;

  // acciones b√°sicas
  const toggle=id=>setSelected(s=>{const n=new Set(s);n.has(id)?n.delete(id):n.add(id);return n});
  const onAdd=()=>setForm({});
  const onEdit=p=>setForm(p);
  const onSave=data=>{
    if(form&&form.id){ setPlayers(p=>withG(p.map(x=>x.id===form.id?{...x,...data}:x))) }
    else { const id=String(Date.now()); setPlayers(p=>withG([...p,{id,...data}])) }
    setForm(null);
  };
  const onDel=id=>{
    setPlayers(p=>p.filter(x=>x.id!==id));
    setSelected(s=>{const n=new Set(s);n.delete(id);return n});
    setTeams(t=>t?{A:t.A.filter(x=>x!==id),B:t.B.filter(x=>x!==id)}:t);
    setPins(p=>{const cp={...p}; delete cp[id]; return cp});
  };
  const onExport=()=>{
    const payload={players,selected:[...selected],teams,kChem,pins,overrides,history};
    const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url;a.download='futbol5_estado.json';a.click();URL.revokeObjectURL(url);
  };
  const onImport=e=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{try{
      const d=JSON.parse(r.result);
      if(Array.isArray(d.players)) setPlayers(withG(d.players));
      if(Array.isArray(d.selected)) setSelected(new Set(d.selected));
      if(d.teams?.A&&d.teams?.B) setTeams(d.teams);
      if(typeof d.kChem==='number') setKChem(d.kChem);
      if(d.pins) setPins(d.pins);
      if(d.overrides) setOverrides(d.overrides);
      if(Array.isArray(d.history)) setHistory(d.history);
    }catch{alert('JSON inv√°lido')}};
    r.readAsText(f);
  };
  const onShare=async()=>{
    const payload={players,selected:[...selected],teams,kChem,pins,overrides,history};
    try{ await navigator.clipboard.writeText(JSON.stringify(payload)); alert('Copiado al portapapeles ‚úî') }catch{ alert('No se pudo copiar') }
  };
  const reset=()=>{ setPlayers(withG(SEED)); setSelected(new Set()); setTeams(null); setKChem(K); setPins({}); setOverrides({}); };

  // balanceo
  const makeR=()=>{ if(!canMake) return; const[A,B]=randSplit(convocados); setTeams({A,B}) };
  const makeB=()=>{
    if(!canMake) return;
    const res=balancedWithPins(convocados,map,chem,kChem,pins) || balancedSimple(convocados,map,chem,kChem);
    if(!res){ alert('Demasiados jugadores fijados en A o B (m√°ximo 5 por equipo)'); return }
    setTeams({A:res.A,B:res.B});
  };

  // pins
  const togglePin=(id,side)=>setPins(p=>{
    const cur=p[id]; const n={...p};
    if(cur===side) delete n[id]; else n[id]=side;
    return n;
  });

  // qu√≠mica manual
  const setChemPair=(a,b,val)=>{
    const v=clamp(parseInt(val,10),1,10);
    setOverrides(o=>({...o,[normPair(a,b)]:v}));
  };

  // historial
  const saveMatch=()=>{
    if(!teams) return;
    const m=scoreDiff(teams.A,teams.B,map,chem,kChem).m;
    const item={ts:Date.now(),A:[...teams.A],B:[...teams.B],m, map}; // incluye map para mostrar nombres
    setHistory(h=>[item,...h].slice(0,50));
    alert('Partido guardado ‚úî');
  };
  const restoreMatch=it=>{ setTeams({A:[...it.A],B:[...it.B]}); setHistOpen(false) };
  const deleteMatch=ts=> setHistory(h=>h.filter(x=>x.ts!==ts));

  const install=async()=>{
    if(deferred){ try{ await deferred.prompt(); await deferred.userChoice }catch{} finally{ setDeferred(null) } }
    else setShowInst(true);
  };
  const isStandalone=window.matchMedia('(display-mode: standalone)').matches||window.navigator.standalone;

  // filtros/orden
  const filtered = players
    .filter(p=>p.nombre.toLowerCase().includes(query.toLowerCase()))
    .sort((a,b)=> sort==='gasc' ? (a._GLOBAL-b._GLOBAL) : sort==='nombre' ? a.nombre.localeCompare(b.nombre) : (b._GLOBAL-a._GLOBAL));

  return (<div className="mx-auto max-w-screen-md p-3 text-slate-100">
    <header className="sticky top-0 z-10 mb-3 rounded-xl bg-slate-950/90 p-3 ring-1 ring-slate-800 backdrop-blur">
      <div className="flex items-center justify-between gap-2">
        <h1 className="text-lg font-bold">F√∫tbol 5 - Generador</h1>
        <div className="flex items-center gap-2">
          <div className={`rounded-xl px-3 py-1 text-sm ring-1 ${convocados.length<10?'bg-amber-600/20 text-amber-200 ring-amber-500/40':convocados.length>10?'bg-rose-600/20 text-rose-200 ring-rose-500/40':'bg-emerald-600/20 text-emerald-200 ring-emerald-500/40'}`}>Convocados: {convocados.length}/10</div>
          <button onClick={()=>setSettings(true)} className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700">‚öôÔ∏è</button>
        </div>
      </div>

      <nav className="mt-2 grid grid-cols-3 gap-2">
        <button onClick={()=>setTab('partido')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='partido'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>‚öΩ Partido</button>
        <button onClick={()=>setTab('plantel')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='plantel'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>üë• Plantel</button>
        <button onClick={()=>setTab('ayuda')} className={`rounded-xl px-3 py-2 text-sm ring-1 ${tab==='ayuda'?'bg-slate-800 text-white ring-slate-600':'bg-slate-900/70 text-slate-200 ring-slate-800'}`}>‚ÑπÔ∏è Ayuda</button>
      </nav>

      {tab==='partido'&&teams&&(<div className="mt-2 grid grid-cols-2 gap-2 text-sm">
        <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800"><div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TC.A.dot}`}/>Equipo A</div><TeamMiniSummary ids={teams.A} map={map} chem={chem} kChem={kChem}/></div>
        <div className="rounded-xl bg-slate-900/70 p-2 ring-1 ring-slate-800"><div className="flex items-center gap-2 font-semibold"><span className={`h-2.5 w-2.5 rounded-full ${TC.B.dot}`}/>Equipo B</div><TeamMiniSummary ids={teams.B} map={map} chem={chem} kChem={kChem}/></div>
      </div>)}
    </header>

    {tab==='plantel'? (
      <section className="space-y-2">
        <div className="mb-2 grid grid-cols-1 gap-2 sm:grid-cols-3">
          <div className="sm:col-span-2 flex gap-2">
            <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Buscar jugador..." className="w-full rounded-xl bg-slate-900/70 px-3 py-2 text-sm ring-1 ring-slate-700"/>
            <select value={sort} onChange={e=>setSort(e.target.value)} className="rounded-xl bg-slate-900/70 px-2 py-2 text-sm ring-1 ring-slate-700">
              <option value="gdesc">Global ‚Üì</option>
              <option value="gasc">Global ‚Üë</option>
              <option value="nombre">Nombre</option>
            </select>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={onAdd} className="rounded-xl bg-emerald-600 px-3 py-2 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500">+ A√±adir</button>
            <button onClick={()=>{setSelected(new Set());setTeams(null)}} className="rounded-xl bg-slate-800 px-3 py-2 text-sm ring-1 ring-slate-700 hover:bg-slate-700">Limpiar</button>
          </div>
        </div>

        {filtered.map(p=>(
          <div key={p.id} className="space-y-2">
            <PlayerRow
              p={p}
              selected={selected.has(p.id)}
              onToggle={()=>toggle(p.id)}
              onOpen={()=>setModal(p)}
              pinA={pins[p.id]==='A'}
              pinB={pins[p.id]==='B'}
              onPin={(side)=>togglePin(p.id,side)}
            />
            <div className="-mt-2 mb-2 flex flex-wrap gap-2 pl-14">
              <button onClick={()=>onEdit(p)} className="rounded-xl bg-slate-800 px-2 py-1 text-xs ring-1 ring-slate-700 hover:bg-slate-700">Editar</button>
              <button onClick={()=>onDel(p.id)} className="rounded-xl bg-rose-700 px-2 py-1 text-xs text-white ring-1 ring-rose-500 hover:bg-rose-600">Borrar</button>
            </div>
          </div>
        ))}
      </section>
    ) : (tab==='ayuda' ? (
      <section className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700 text-sm leading-relaxed">
        <p><b>Consejos:</b> fij√° üìå jugadores en A o B para que el equilibrio los respete; edit√° la qu√≠mica entre pares desde la ficha (Qu√≠mica ‚Üí ‚úèÔ∏è); guard√° partidos y restauralos desde el historial.</p>
        <p className="mt-2">Fondo con c√©sped: coloc√° tu imagen en <code>assets/cesped.jpg</code>. Pod√©s ajustar la oscuridad con <code>--pitch-darken</code> en CSS.</p>
      </section>
    ) : (
      <section className="space-y-3">
        {!canMake&&(<div className="rounded-xl bg-amber-600/15 p-3 text-amber-100 ring-1 ring-amber-600/30">Necesit√°s exactamente 10 convocados. Elegilos en <span className="font-semibold">Plantel</span>.</div>)}
        {teams&&(<>
          <TeamCard title="Equipo A" teamKey="A" ids={teams.A} map={map} chem={chem} onOpenPlayer={setModal} kChem={kChem}/>
          <TeamCard title="Equipo B" teamKey="B" ids={teams.B} map={map} chem={chem} onOpenPlayer={setModal} kChem={kChem}/>
          <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
            <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700"><div className="mb-2 font-semibold">Barras - Equipo A</div><BarsChart values={teamAvg(teams.A,map)} accent={TC.A.hex}/></div>
            <div className="rounded-2xl bg-slate-900/70 p-3 ring-1 ring-slate-700"><div className="mb-2 font-semibold">Barras - Equipo B</div><BarsChart values={teamAvg(teams.B,map)} accent={TC.B.hex}/></div>
          </div>
          <BalanceIndicator A={teams.A} B={teams.B} map={map} chem={chem} kChem={kChem}/>
          <TeamRadarCompare A={teams.A} B={teams.B} map={map}/>
        </>)}
      </section>
    ))}

    {tab==='partido'&&(<div className="sticky bottom-2 mt-4 grid grid-cols-2 gap-2">
      <button onClick={makeR} disabled={!canMake} className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${canMake?'bg-slate-800 text-slate-100 ring-slate-700 hover:bg-slate-700':'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed'}`}>üé≤ Azar</button>
      <button onClick={makeB} disabled={!canMake} className={`rounded-2xl px-4 py-3 text-base font-semibold ring-1 ${canMake?'bg-emerald-600 text-white ring-emerald-500 hover:bg-emerald-500':'bg-emerald-600/40 text-emerald-200 ring-emerald-800 cursor-not-allowed'}`}>‚öñÔ∏è Equilibrado</button>
      </div>)}

    {teams && tab==='partido' && (<div className="mt-2 flex gap-2">
      <button onClick={saveMatch} className="rounded-xl bg-slate-800 px-3 py-2 text-sm ring-1 ring-slate-700 hover:bg-slate-700">üíæ Guardar</button>
      <button onClick={()=>setHistOpen(true)} className="rounded-xl bg-slate-800 px-3 py-2 text-sm ring-1 ring-slate-700 hover:bg-slate-700">üóÇÔ∏è Historial</button>
    </div>)}

    {!isStandalone&&(<button onClick={install} className="fixed bottom-20 right-3 z-50 rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-lg ring-1 ring-emerald-500 hover:bg-emerald-500">üì≤ Instalar</button>)}

    <footer className="mt-6 rounded-xl bg-slate-900/60 p-3 text-[12px] text-slate-300 ring-1 ring-slate-800">
      <div className="font-semibold">Leyenda:</div>
      <div>ATA=Ataque - PAS=Pase - REG=Regate - VEL=Velocidad - DEF=Defensa - FIS=F√≠sico - ARQ=Arco - EQP=Trabajo en equipo</div>
    </footer>

    <PlayerModal
      player={modal}
      onClose={()=>setModal(null)}
      players={players}
      chem={chem}
      teamIdsA={teams?.A||[]}
      teamIdsB={teams?.B||[]}
      onEditChem={(other)=>{
        const cur=chem[modal.id]?.[other]??5;
        const nv=prompt('Qu√≠mica 1‚Äì10', String(cur));
        if(!nv) return;
        const v=clamp(parseInt(nv,10),1,10);
        setChemPair(modal.id, other, v);
      }}
    />

    {form&&<PlayerFormModal initial={form.id?form:null} onCancel={()=>setForm(null)} onSave={onSave}/>}
    {settings&&<SettingsModal onClose={()=>setSettings(false)} kChem={kChem} setKChem={setKChem} onExport={onExport} onImport={onImport} onReset={reset} onShare={onShare}/>}
    {histOpen&&<HistoryModal items={history} onClose={()=>setHistOpen(false)} onRestore={restoreMatch} onDelete={deleteMatch}/>}
  </div>);
};

/* ---------- Mini tests ---------- */
(function t(){try{
  const ps=withG(SEED);const m=Object.fromEntries(ps.map(p=>[p.id,p]));
  const ch=chemBuild(ps);const ids=ps.slice(0,10).map(p=>p.id);
  const[a,b]=randSplit(ids); if(a.length+b.length!==ids.length) throw 'split';
  const g0=globalOf(ps[0]); if(!(g0>=1&&g0<=10)) throw 'global rango';
  const bb=balancedSimple(ids,m,ch); if(!(bb.A.length===5&&bb.B.length===5)) throw 'balanced 5/5';
  if(!(chemTeam(bb.A,ch)>=1&&chemTeam(bb.A,ch)<=10)) throw 'chem 1..10';
  const pins={}; pins[ids[0]]='A'; pins[ids[1]]='B';
  const bp=balancedWithPins(ids,m,ch,0.6,pins); if(!(bp.A.includes(ids[0])&&bp.B.includes(ids[1]))) throw 'pins';
  console.log('[TEST OK]');
}catch(e){console.error('[TEST FAIL]',e)}})();

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>