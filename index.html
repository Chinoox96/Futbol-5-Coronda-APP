<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>F5C</title>
  <meta name="theme-color" content="#10b981"/>
  <link id="mf" rel="manifest" href="manifest.json" />


  <!-- iOS icons -->
  <link rel="apple-touch-icon" sizes="192x192" href="./icons/icon-192.png"/>
  <link rel="apple-touch-icon" sizes="512x512" href="./icons/icon-512.png"/>

  <!-- Favicon m√≠nimo -->
  <link rel="icon" href="data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%2310b981'/%3E%3Ctext x='50%25' y='54%25' font-family='system-ui,Segoe UI,Roboto,sans-serif' font-size='64' text-anchor='middle' dominant-baseline='middle' font-weight='700' fill='%230b1220'%3EF5%3C/text%3E%3C/svg%3E"/>

  <!-- Tailwind + React + Babel -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Export/Share -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bp: 0px;
      --pitch-image: var(--pitch-image-mobile);
      --pitch-image-mobile: url('assets/cesped-vert.webp');
      --pitch-image-desktop: var(--pitch-image-mobile);
      --pitch-darken: 0.50;
      --parallax-speed: 0.35;
      --header-h: 140px; /* un poco m√°s alto para que no tape nada */
    }
    html,body{
      background:#0b1220;
      color:#e2e8f0;
      margin:0;
      overflow-x:hidden;
    }
    img,svg{max-width:100%;height:auto}

    /* Fondo (degradado + c√©sped) */
    #bg-parallax{
      position:fixed;inset:0;z-index:0;
      background-image:
        linear-gradient(90deg, rgba(59,130,246,.15), rgba(16,185,129,.12), rgba(239,68,68,.15)),
        radial-gradient(1200px 600px at 50% -300px, rgba(16,185,129,.12), transparent 60%),
        linear-gradient(rgba(11,18,32,var(--pitch-darken)),rgba(11,18,32,var(--pitch-darken))),
        var(--pitch-image);
      background-repeat:no-repeat,no-repeat,repeat-y,repeat-y;
      background-size:cover,cover,100% auto,100% auto;
      background-position:center top,center top,center var(--bp),center var(--bp);
    }
    @media (min-width:1024px){
      :root{--parallax-speed:0}
      #bg-parallax{
        background-size:cover,cover,100% auto,100% auto;
        background-position:center,center,center,center;
      }
    }
    #root{position:relative;z-index:1}

    /* Header */
    .app-header{
      position:fixed;top:0;left:0;right:0;z-index:50;backdrop-filter:blur(10px);
      background:rgba(8,12,22,.94);border-bottom:1px solid rgba(30,41,59,.8);
      background-image:
        radial-gradient(1200px 120px at 50% 0, rgba(148,163,184,.06), transparent 70%),
        repeating-linear-gradient(45deg, rgba(148,163,184,.04) 0 6px, transparent 6px 12px);
    }
    .header-spacer{height:var(--header-h)}
    .title-fifa{font-style:italic;letter-spacing:.5px}

    /* Tabs */
    .tabs-bar{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:.5rem;
      margin-top:.75rem;
    }
    .tab-large{
      border-radius:14px;
      padding:.75rem 1rem;
      font-weight:700;
      text-align:center;
      border:1px solid rgba(51,65,85,.8);
      background:rgba(2,6,23,.6);
      color:#cbd5e1;
      transition:all .2s;
    }
    .tab-large.active{
      background:#0b1220;
      color:#fff;
      border-color:#4ade80;
      box-shadow:0 0 0 1px rgba(74,222,128,.25) inset;
    }

    /* Carrusel de pesta√±as */
    .tabs-viewport{overflow:hidden}
    .tabs-track{
      display:flex;
      width:200%;
      transition:transform .32s cubic-bezier(.22,.7,.12,1);
      touch-action:pan-y;
    }
    .tabs-page{width:100%;padding:12px}

    /* Cards FIFA base */
    .card-rect{
      position:relative;
      border-radius:16px;
      padding:8px;
      overflow:hidden;
    }
    .card-inner{position:relative;z-index:2}
    .rarity-bronze{background:linear-gradient(180deg,#d3a076,#7a5438)}
    .rarity-silver{background:linear-gradient(180deg,#e5e7eb,#9ca3af)}
    .rarity-gold{background:linear-gradient(180deg,#fde68a,#d97706)}

    .rarity-special{
      position:relative;
      background:transparent;
    }
    .rarity-special::before{
      content:"";
      position:absolute;inset:-2px;border-radius:18px;
      background:conic-gradient(from 0deg,#22d3ee,#a78bfa,#f472b6,#22d3ee);
      animation:spin 6s linear infinite;
    }
    .rarity-special::after{
      content:"";
      position:absolute;inset:2px;border-radius:14px;
      background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(30,41,59,.85));
    }

    /* Legendaria extra */
    .rarity-legendary{
      position:relative;
      background:transparent;
    }
    .rarity-legendary::before{
      content:"";
      position:absolute;inset:-2px;border-radius:18px;
      background:conic-gradient(from 0deg,#f97316,#eab308,#22c55e,#3b82f6,#a855f7,#f97316);
      animation:spin 8s linear infinite;
    }
    .rarity-legendary::after{
      content:"";
      position:absolute;inset:2px;border-radius:14px;
      background:linear-gradient(180deg,rgba(15,23,42,.96),rgba(15,23,42,.9));
    }

    @keyframes spin{to{transform:rotate(1turn)}}

    /* Cancha (16:9) */
    .board{
      position:relative;
      width:100%;
      max-width:980px;
      aspect-ratio:16/9;
      border-radius:16px;
      overflow:hidden;
    }
    .board img.field{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .board .layer{
      position:absolute;
      inset:0;
    }

    /* Bot√≥n instalar */
    .install-pill{
      position:fixed;
      right:12px;
      bottom:12px;
      z-index:60;
    }
  </style>
</head>
<body>
  <div id="bg-parallax" aria-hidden="true"></div>
  <div id="root"></div>

  <!-- Manifest con ruta est√°tica para evitar advertencias del navegador -->
  <script>
    (function(){
      const link = document.getElementById('mf');
      const basePath = location.pathname.endsWith('/')
        ? location.pathname
        : location.pathname.replace(/[^/]+$/,'');
      link.href = (basePath || '/') + 'manifest.json';
    })();
  </script>

  <!-- Fondo responsive -->
  <script>
    (function(){
      try{
        const base=location.pathname.endsWith('/')?location.pathname:location.pathname.replace(/[^/]+$/,'');
        const m=base+'assets/cesped-vert.webp';
        const d=base+'assets/cesped-horiz.webp';
        document.documentElement.style.setProperty('--pitch-image-mobile',`url('${m}')`);
        function setDesk(v){
          document.documentElement.style.setProperty('--pitch-image-desktop',v);
          apply();
        }
        fetch(d,{method:'HEAD'}).then(r=>setDesk((r&&r.ok)?`url('${d}')`:'var(--pitch-image-mobile)')).catch(()=>setDesk('var(--pitch-image-mobile)'));
        function apply(){
          const isDesk=window.matchMedia('(min-width:1024px)').matches;
          const img=isDesk?'var(--pitch-image-desktop)':'var(--pitch-image-mobile)';
          document.documentElement.style.setProperty('--pitch-image',img);
        }
        window.addEventListener('resize',apply);apply();
      }catch(e){}
    })();
  </script>

  <!-- Parallax -->
  <script>
    (function(){
      let ticking=false;
      function sp(){
        const v=getComputedStyle(document.documentElement).getPropertyValue('--parallax-speed');
        const n=parseFloat(v);return isNaN(n)?0:n;
      }
      function onScroll(){
        if(ticking)return;
        ticking=true;
        requestAnimationFrame(()=>{
          document.documentElement.style.setProperty('--bp',(-window.scrollY*sp())+'px');
          ticking=false;
        });
      }
      window.addEventListener('scroll',onScroll,{passive:true});
      window.addEventListener('resize',onScroll);
      onScroll();
    })();
  </script>

  <!-- SW registro -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./sw.js', {updateViaCache:'none'})
          .then(reg => reg.update())
          .catch(()=>{});
      });
      window.addEventListener('appinstalled', ()=>console.log('[PWA] instalada'));
    }
  </script>

  <!-- Ajustar altura del header (queda como backup, pero ahora usamos un valor c√≥modo por defecto) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const header = document.querySelector('.app-header');
      const spacer = document.querySelector('.header-spacer');
      if (header && spacer) {
        const h = header.offsetHeight || 140;
        spacer.style.height = h + 'px';
        document.documentElement.style.setProperty('--header-h', h + 'px');
      }
    });
  </script>

  <!-- === APP === -->
  <script type="text/babel">
    const {useMemo,useState,useEffect,useRef} = React;

    /* ========= Constantes + helpers ========= */
    const STAT=['ATA','PAS','REG','VEL','DEF','FIS','ARQ','EQP'];
    const SL={
      ATA:'Ataque',PAS:'Pase',REG:'Regate',VEL:'Velocidad',
      DEF:'Defensa',FIS:'F√≠sico',ARQ:'Arco',EQP:'Equipo'
    };
    const SUBS={
      ATA:['Posici√≥n','Definici√≥n','Potencia'],
      PAS:['Visi√≥n','Pase corto','Pase largo'],
      REG:['Agilidad','Control','Equilibrio'],
      VEL:['Aceleraci√≥n','Pico','Arranque'],
      DEF:['Marcaje','Anticipaci√≥n','Entradas'],
      FIS:['Resistencia','Fuerza','Salto'],
      ARQ:['Reflejos','Manos','Saque'],
      EQP:['Colaboraci√≥n','Disciplina','Liderazgo']
    };
    const POS_OPTIONS=[
      {code:'AR',label:'Arquero',alias:['PO','POR']},
      {code:'DFC',label:'Defensa Central',alias:['DF','DFI','DFD']},
      {code:'LATI',label:'Lateral Izquierdo',alias:['LI','LAI']},
      {code:'LATD',label:'Lateral Derecho',alias:['LD','LAD']},
      {code:'MCD',label:'Mediocentro Defensivo',alias:['VOL']},
      {code:'MC',label:'Mediocampista Central',alias:['MCO','MED']},
      {code:'MEI',label:'Mediocampista Izquierdo',alias:['MI']},
      {code:'MED',label:'Mediocampista Derecho',alias:['MD']},
      {code:'EI',label:'Extremo Izquierdo'},
      {code:'ED',label:'Extremo Derecho'},
      {code:'DC',label:'Delantero Centro',alias:['DEL']},
      {code:'MP',label:'Media Punta',alias:['ENG']},
    ];
    const FLAG_OPTIONS=[
      {code:'üá¶üá∑',label:'Argentina'},
      {code:'üá∫üáæ',label:'Uruguay'},
      {code:'üá®üá±',label:'Chile'},
      {code:'üáµüáæ',label:'Paraguay'},
      {code:'üáßüá∑',label:'Brasil'},
      {code:'üáßüá¥',label:'Bolivia'},
      {code:'üáµüá™',label:'Per√∫'},
      {code:'üá®üá¥',label:'Colombia'},
      {code:'üáªüá™',label:'Venezuela'},
      {code:'üá≤üáΩ',label:'M√©xico'},
      {code:'üá™üá∏',label:'Espa√±a'},
      {code:'üáÆüáπ',label:'Italia'},
      {code:'üá´üá∑',label:'Francia'},
      {code:'üá©üá™',label:'Alemania'},
      {code:'üè≥Ô∏è',label:'Otra'},
    ];
    const FOOT_OPTIONS=['Derecho','Izquierdo','Ambidiestro'];
    const Wt={ATA:.18,DEF:.16,PAS:.14,REG:.14,VEL:.14,FIS:.10,ARQ:.07,EQP:.07};

    const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
    const avg=a=>a.length?a.reduce((p,c)=>p+c,0)/a.length:0;
    const J = (s, d) => {
      if (!s) return d;
      try {
        const parsed = JSON.parse(s);
        return parsed ?? d;
      } catch {
        return d;
      }
    };

    const globalOf=p=>{
      let s=0,w=0;
      for(const k in Wt){
        s+=(p[k]||0)*Wt[k];
        w+=Wt[k];
      }
      return +(s/w).toFixed(2);
    };
    const withG = (a) => (a || []).map(p => ({ ...p, _GLOBAL: globalOf(p) }));
    const posInfoOf=(code)=>{
      return POS_OPTIONS.find(o=>o.code===code || o.alias?.includes(code)) || null;
    };

    const cleanPlayers = (arr = []) => withG(
      arr.map((p, idx) => {
        const { _GLOBAL, ...rest } = p || {};
        const base = { id: rest.id || String(Date.now() + idx), ...rest };
        STAT.forEach(k => {
          base[k] = clamp(+base[k] || 5, 1, 10);
        });
        const posInfo = posInfoOf(base.pos);
        base.pos = posInfo?.code || base.pos || 'MC';
        base.posicion = base.posicion || posInfo?.label || base.pos || 'Mediocampista Central';
        base.pie = base.pie || 'Derecho';
        base.bandera = base.bandera || 'üè≥Ô∏è';
        return base;
      })
    );

    const rarityOf=p=>{
      const r=Math.round((p._GLOBAL||globalOf(p))*10);
      if (p.legendaria) return 'legendary';
      if (p.especial || r>=90) return 'special';
      if (r>=80) return 'gold';
      if (r>=70) return 'silver';
      return 'bronze';
    };

    const colorNum100 = v =>
      v>=90?'text-emerald-400':
      v>=80?'text-emerald-300':
      v>=70?'text-amber-300':
      v>=60?'text-amber-200':'text-rose-300';

    const colorNum10  = v =>
      v>=9?'text-emerald-400':
      v>=8?'text-emerald-300':
      v>=7?'text-amber-300':
      v>=6?'text-amber-200':'text-rose-300';

    const hexA=(hex,a)=>{
      const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)||[];
      const r=parseInt(m[1]||'10',16),
            g=parseInt(m[2]||'b9',16),
            b=parseInt(m[3]||'81',16);
      return `rgba(${r},${g},${b},${a})`;
    };

    const colorOf=n=>[
      '#22c55e','#06b6d4','#a78bfa','#f59e0b','#ef4444',
      '#14b8a6','#8b5cf6','#f97316','#10b981','#3b82f6'
    ][[...n].reduce((h,c)=>(h*31+c.charCodeAt(0))>>>0,0)%10];

    const mkAvatar=n=>'data:image/svg+xml;utf8,'+encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='160' height='160'>
        <rect width='100%' height='100%' rx='24' ry='24' fill='${colorOf(n)}'/>
        <text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle'
          font-family='system-ui,Segoe UI,Roboto,sans-serif'
          font-size='72' fill='white'
          style='font-style:italic;font-weight:800;letter-spacing:1px'>
          ${(n||'F5').split(/\\s+/).map(s=>s[0]||'').join('').slice(0,2).toUpperCase()}
        </text>
      </svg>`
    );

    /* ==== Balanceo ==== */
    const shuffle=a=>{
      const x=[...a];
      for(let i=x.length-1;i>0;i--){
        const j=(Math.random()*(i+1)|0);
        [x[i],x[j]]=[x[j],x[i]];
      }
      return x;
    };
    const seedWithPins=(ids,pA,pB)=>{
      const A=ids.filter(id=>pA.has(id));
      const B=ids.filter(id=>pB.has(id));
      const rest=ids.filter(id=>!pA.has(id)&&!pB.has(id));
      return{A:[...A],B:[...B],rest};
    };
    const teamGlobal=(ids,map)=>+avg(ids.map(id=>map[id]?map[id]._GLOBAL:0)).toFixed(2);
    const chemTeam=(ids,chem)=>{
      const arr=Array.isArray(ids)?ids.filter(Boolean):[];
      if(arr.length<=1)return 10;
      let t=0,p=0;
      for(let i=0;i<arr.length;i++)
        for(let j=i+1;j<arr.length;j++){
          t+=chem[arr[i]]?.[arr[j]]??5;
          p++;
        }
      return +(t/(p||1)).toFixed(2);
    };
    const teamScoreUI=(ids,map,chem,k)=>
      +(teamGlobal(ids,map)+chemTeam(ids,chem)*k).toFixed(2);
    const scoreDiff=(A,B,map,chem,k)=>{
      const sA=teamScoreUI(A,map,chem,k),
            sB=teamScoreUI(B,map,chem,k);
      return{A:[...A],B:[...B],diff:Math.abs(sA-sB),m:{sA,sB}};
    };
    const balancedWithPins=(ids,map,chem,k,pA,pB)=>{
      const{A,B,rest}=seedWithPins(ids,pA,pB);
      const RR=shuffle(rest);
      for(const id of RR){
        (A.length<B.length?A:B).push(id);
        if(A.length===5&&B.length===5)break;
      }
      while((A.length<5||B.length<5)&&RR.length>0){
        const id=RR.pop();
        (A.length<B.length?A:B).push(id);
      }
      let best=scoreDiff(A,B,map,chem,k);
      const freeA=best.A.map((id,i)=>pA.has(id)?-1:i).filter(i=>i>=0);
      const freeB=best.B.map((id,i)=>pB.has(id)?-1:i).filter(i=>i>=0);
      for(let t=0;t<800;t++){
        if(!freeA.length||!freeB.length)break;
        const i=freeA[(Math.random()*freeA.length)|0];
        const j=freeB[(Math.random()*freeB.length)|0];
        [best.A[i],best.B[j]]=[best.B[j],best.A[i]];
        const cur=scoreDiff(best.A,best.B,map,chem,k);
        if(cur.diff<=best.diff || Math.random()<.12) best=cur;
        else [best.A[i],best.B[j]]=[best.B[j],best.A[i]];
      }
      return{A:best.A,B:best.B,m:best.m};
    };

    /* ========= Seed ========= */
    const SEED=[
      {id:'1',nombre:'Leo',apodo:'',equipoPropio:'La 10',equipoFavorito:'Barcelona',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Leo'),ATA:10,PAS:9,REG:10,VEL:9,DEF:4,FIS:7,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5,especial:true,legendaria:true,bandera:'üá¶üá∑',pos:'LA'},
      {id:'2',nombre:'Fabi',apodo:'',equipoPropio:'La 10',equipoFavorito:'Col√≥n',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Fabi'),ATA:7,PAS:8,REG:7,VEL:7,DEF:7,FIS:7,ARQ:4,EQP:9,pie:'Derecho',estrellas:4,bandera:'üá¶üá∑',pos:'MU'},
      {id:'3',nombre:'Cuti',apodo:'',equipoPropio:'Muralla',equipoFavorito:'Belgrano',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Cuti'),ATA:5,PAS:6,REG:5,VEL:7,DEF:10,FIS:9,ARQ:4,EQP:7,pie:'Derecho',estrellas:4,bandera:'üá¶üá∑',pos:'TI'},
      {id:'4',nombre:'Dibu',apodo:'',equipoPropio:'Muralla',equipoFavorito:'Arsenal',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Dibu'),ATA:3,PAS:5,REG:4,VEL:5,DEF:8,FIS:8,ARQ:10,EQP:7,pie:'Derecho',estrellas:5,bandera:'üá¶üá∑',pos:'AR'},
      {id:'5',nombre:'Papu',apodo:'',equipoPropio:'Tiki',equipoFavorito:'San Lorenzo',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Papu'),ATA:8,PAS:8,REG:9,VEL:8,DEF:5,FIS:6,ARQ:3,EQP:7,pie:'Derecho',estrellas:4,bandera:'üá¶üá∑',pos:'LA'},
      {id:'6',nombre:'Nico',apodo:'',equipoPropio:'Tiki',equipoFavorito:'Boca',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Nico'),ATA:7,PAS:7,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:4,bandera:'üá¶üá∑',pos:'LA'},
      {id:'7',nombre:'Chino',apodo:'',equipoPropio:'Muralla',equipoFavorito:"Newell's",equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Chino'),ATA:5,PAS:6,REG:5,VEL:6,DEF:8,FIS:7,ARQ:8,EQP:6,pie:'Izquierdo',estrellas:3,bandera:'üá¶üá∑',pos:'AR'},
      {id:'8',nombre:'Joa',apodo:'',equipoPropio:'La 10',equipoFavorito:'River',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Joa'),ATA:6,PAS:6,REG:6,VEL:7,DEF:8,FIS:8,ARQ:5,EQP:7,pie:'Derecho',estrellas:3,bandera:'üá¶üá∑',pos:'TI'},
      {id:'9',nombre:'Fideo',apodo:'',equipoPropio:'Tiki',equipoFavorito:'Rosario C.',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Fideo'),ATA:8,PAS:9,REG:9,VEL:8,DEF:6,FIS:6,ARQ:3,EQP:8,pie:'Izquierdo',estrellas:5,bandera:'üá¶üá∑',pos:'LA'},
      {id:'10',nombre:'Kuni',apodo:'',equipoPropio:'La 10',equipoFavorito:'Independiente',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Kuni'),ATA:9,PAS:7,REG:8,VEL:9,DEF:5,FIS:7,ARQ:3,EQP:7,pie:'Derecho',estrellas:4,bandera:'üá¶üá∑',pos:'MU'},
      {id:'11',nombre:'Tomi',apodo:'',equipoPropio:'Muralla',equipoFavorito:'Talleres',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Tomi'),ATA:6,PAS:7,REG:6,VEL:7,DEF:7,FIS:7,ARQ:5,EQP:6,pie:'Derecho',estrellas:3,bandera:'üá¶üá∑',pos:'LA'},
      {id:'12',nombre:'Gonza',apodo:'',equipoPropio:'Tiki',equipoFavorito:'Racing',equipoFavoritoEscudoUrl:'',fotoUrl:mkAvatar('Gonza'),ATA:7,PAS:6,REG:7,VEL:8,DEF:6,FIS:7,ARQ:4,EQP:6,pie:'Derecho',estrellas:3,bandera:'üá¶üá∑',pos:'TI'},
    ];

    /* ========= Cancha ========= */
    const FIELD_VER='v4';
    const FIELD_BOX={ left:4.5, right:95.5, top:43, bottom:97 };
    const pmap=({x,y})=>({
      x: FIELD_BOX.left + (FIELD_BOX.right-FIELD_BOX.left)*(x/100),
      y: FIELD_BOX.top  + (FIELD_BOX.bottom-FIELD_BOX.top)*(y/100)
    });

    // Formaci√≥n base mejorada (AR, 2 DF, VOL, DEL) sin cruzar la mitad
    const POS_A=[
      {x:12, y:50}, // AR
      {x:28, y:30}, // DF izq
      {x:28, y:70}, // DF der
      {x:40, y:40}, // VOL
      {x:46, y:60}, // DEL
    ];
    const POS_B=POS_A.map(p=>({x:100-p.x,y:p.y}));
    const POS_RANGE={A:[2,49],B:[51,98]};

    /* ========= UI: FIFA / FieldChip / Radar ========= */
    const FifaCard=({p})=>{
      const rate=Math.round((p._GLOBAL||globalOf(p))*10);
      const rare=rarityOf(p);
      const ring =
        rare==='bronze'   ? 'ring-yellow-800' :
        rare==='silver'   ? 'ring-slate-300'  :
        rare==='gold'     ? 'ring-yellow-500' :
        rare==='legendary'? 'ring-amber-300'  :
                            'ring-cyan-300';
      const rareClass =
        rare==='legendary' ? 'rarity-legendary' :
        rare==='special'   ? 'rarity-special'   :
                             `rarity-${rare}`;

      const [src,setSrc]=React.useState(p.fotoUrl||'');
      React.useEffect(()=>setSrc(p.fotoUrl||''),[p.fotoUrl]);
      const crest = p.equipoFavoritoEscudoUrl;

      return (
        <div className={`card-rect w-44 ${rareClass} text-slate-900 ring-1 ${ring} shadow`}>
          <div className="card-inner">
            <div className="flex justify-between items-start">
              <div className="text-center leading-4">
                <div className="text-3xl font-black">{rate}</div>
                <div className="text-xs font-bold">{p.pos||'F5'}</div>
                <div className="text-base">{p.bandera||''}</div>
              </div>
              <div className="flex flex-col items-end gap-1">
                <div className="text-[10px] font-bold bg-white/70 rounded px-1 py-0.5 ring-1 ring-black/10">
                  {(p.equipoPropio||'').slice(0,2).toUpperCase()}
                </div>
                {crest ? (
                  <img
                    src={crest}
                    onError={e=>{e.currentTarget.style.display='none';}}
                    className="h-6 w-6 rounded-full object-cover ring-1 ring-black/30 bg-white/70"
                    alt="Escudo"
                  />
                ) : null}
              </div>
            </div>
            <div className="mt-2 grid place-items-center">
              <img
                src={src||mkAvatar(p.nombre)}
                onError={(e)=>{e.currentTarget.src=mkAvatar(p.nombre)}}
                className="rounded-xl object-cover ring-2 h-24 w-24"
                alt={p.nombre}
              />
            </div>
            <div className="mt-2 text-center text-sm font-extrabold">
              {p.nombre}{p.apodo?` ‚Äú${p.apodo}‚Äù`:''}
            </div>
            <div className="mt-1 grid grid-cols-2 gap-x-2 gap-y-1 text-[11px] font-semibold">
              {STAT.map(k=>(
                <div key={k} className="flex items-center justify-between rounded-lg bg-white/30 px-2 py-1">
                  <span>{k}</span><span className="tabular-nums">{p[k]}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // CHIP de la cancha ‚Üí avatar circular con aro de rareza, nombre y rating
    const FieldChip = ({ p, mode='ring' }) => {
      const rare = rarityOf(p);
      const ring =
        rare === 'bronze'   ? 'ring-yellow-800' :
        rare === 'silver'   ? 'ring-slate-300'  :
        rare === 'gold'     ? 'ring-yellow-500' :
        rare === 'legendary'? 'ring-amber-300'  :
                              'ring-cyan-300';

      const [src, setSrc] = React.useState(p.fotoUrl || '');
      React.useEffect(() => setSrc(p.fotoUrl || ''), [p.fotoUrl]);

      const rating = Math.round((p._GLOBAL || globalOf(p)) * 10);
      const displayName = p.apodo || p.nombre;

      if(mode==='card'){
        const topStats = [...STAT]
          .map(k=>({k,v:p[k]??0}))
          .sort((a,b)=>b.v-a.v)
          .slice(0,3)
          .map(it=>it.k);

        const cardBg =
          rare === 'bronze'   ? 'rarity-bronze'   :
          rare === 'silver'   ? 'rarity-silver'   :
          rare === 'gold'     ? 'rarity-gold'     :
          rare === 'legendary'? 'rarity-legendary':
                                'rarity-special';

        return (
          <div className={`card-rect ${cardBg} w-[118px] md:w-[132px] text-white shadow-xl ring-1 ring-black/30`}>
            <div className="card-inner space-y-1.5 text-center">
              <div className="flex items-start justify-between text-white drop-shadow px-1 pt-0.5">
                <span className="text-xl md:text-2xl font-black leading-5 tabular-nums">{rating}</span>
                <span className="rounded-lg bg-black/35 px-2 py-0.5 text-[10px] md:text-xs font-semibold uppercase tracking-wide">
                  {p.pos || 'MC'}
                </span>
              </div>
              <div className="mx-auto flex h-16 w-16 md:h-[72px] md:w-[72px] items-center justify-center overflow-hidden rounded-xl ring-2 ring-white/60 bg-black/30">
                <img
                  src={src || mkAvatar(p.nombre)}
                  onError={e => { e.currentTarget.src = mkAvatar(p.nombre); }}
                  className="h-full w-full object-cover"
                  alt={p.nombre}
                />
              </div>
              <div className="px-1 leading-4">
                <div className="text-[11px] md:text-[12px] font-black truncate drop-shadow">{displayName}</div>
                <div className="text-[10px] text-white/80">{p.posicion || 'Jugador'}</div>
              </div>
              <div className="grid grid-cols-3 gap-1 px-1 pb-1">
                {topStats.map(k=>(
                  <div key={k} className="rounded-lg bg-black/30 px-1.5 py-1 text-center leading-3 ring-1 ring-white/15">
                    <div className="text-[10px] font-semibold">{k}</div>
                    <div className="text-[11px] font-black tabular-nums">{p[k] ?? '-'}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col items-center gap-1 text-white drop-shadow-[0_1px_4px_rgba(0,0,0,0.45)]">
          <div className={`rounded-full ring-4 ${ring} p-[3px] bg-slate-900/80`}>
            <img
              src={src || mkAvatar(p.nombre)}
              onError={e => { e.currentTarget.src = mkAvatar(p.nombre); }}
              className="h-12 w-12 md:h-16 md:w-16 rounded-full object-cover ring-1 ring-black/40"
              alt={p.nombre}
            />
          </div>
          <div className="text-[11px] md:text-[12px] font-semibold leading-4 text-center max-w-[116px] truncate">
            {displayName}
          </div>
          <div className="text-[10px] md:text-[11px] font-black leading-3 text-slate-200">
            {rating}
          </div>
        </div>
      );
    };

    const RadarChart=({size=260,max=10,keys=STAT,dataSeries})=>{
      const cx=size/2,cy=size/2,r=size*.4,N=keys.length;
      const ang=i=>Math.PI*2*i/N-Math.PI/2;
      const pt=(i,v)=>{
        const a=ang(i),rr=r*(v/max);
        return[cx+rr*Math.cos(a),cy+rr*Math.sin(a)];
      };
      const lv=[2,4,6,8,10];
      return(
        <svg viewBox={`0 0 ${size} ${size}`} width="100%" className="mx-auto block">
          {lv.map((L,i)=>{
            const d=keys.map((_,j)=>pt(j,L)).map(([x,y])=>`${x},${y}`).join(' ');
            return <polygon key={i} points={d} fill="none" stroke="rgba(148,163,184,.25)" strokeWidth={1}/>;
          })}
          {keys.map((k,i)=>{
            const[x,y]=pt(i,max);
            return <line key={k} x1={cx} y1={cy} x2={x} y2={y} stroke="rgba(148,163,184,.3)" strokeWidth={1}/>;
          })}
          {keys.map((k,i)=>{
            const[x,y]=pt(i,max+.9);
            return <text key={k} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize={11} fill="#cbd5e1">{k}</text>;
          })}
          {dataSeries.map((srs,i)=>{
            const d=keys.map((k,j)=>pt(j,srs.values[k]??0)).map(([x,y])=>`${x},${y}`).join(' ');
            return(
              <g key={i}>
                <polygon points={d} fill={srs.fill} stroke={srs.stroke} strokeWidth={2}/>
              </g>
            );
          })}
        </svg>
      );
    };

    /* ========= Formaci√≥n (con drag + reset) ========= */
    const FormationBoard=({teamA=[],teamB=[],map,scale=0.5,open=false,stadiumLabel='',matchInfo='',chipMode='ring'})=>{
      const ref=useRef(null);
      const [customPos,setCustomPos]=useState({});
      const [copied,setCopied]=useState(false);

      const isDesk=()=>window.matchMedia('(min-width:768px)').matches;
      const scaleLive=isDesk()?scale:Math.max(0.42,Math.min(scale,0.56));

      const makeCanvas=async()=>{
        const el=ref.current;
        if(!el)return null;
        const canvas=await html2canvas(el,{
          backgroundColor:null,
          useCORS:true,
          allowTaint:true,
          scale:2
        });
        return{canvas,url:canvas.toDataURL('image/png')};
      };

      const copiar=async()=>{
        try{
          const res=await makeCanvas();
          if(!res)return;
          const {canvas}=res;
          canvas.toBlob(async b=>{
            if(!b)return;
            await navigator.clipboard.write([
              new ClipboardItem({'image/png':b})
            ]);
            setCopied(true);
            setTimeout(()=>setCopied(false),1200);
          });
        }catch{}
      };

      const descargar=async()=>{
        const res=await makeCanvas();
        if(!res)return;
        const {url}=res;
        const a=document.createElement('a');
        a.href=url;
        a.download='formacion_f5.png';
        a.click();
      };

      const compartir=async()=>{
        try{
          const res=await makeCanvas();
          if(!res)return;
          const {canvas}=res;
          const file=await new Promise(res2=>canvas.toBlob(b=>res2(new File([b],'formacion_f5.png',{type:'image/png'}))));
          if(navigator.canShare && navigator.canShare({files:[file]})){
            await navigator.share({title:'Formaci√≥n F5',files:[file]});
          }
        }catch{}
      };

      // posici√≥n base o personalizada
      const getPos=(team,index,id)=>{
        const key=`${team}-${id}`;
        if(customPos[key]) return customPos[key];

        const base = team==='A'
          ? (POS_A[index] || POS_A[POS_A.length-1])
          : (POS_B[index] || POS_B[POS_B.length-1]);

        return pmap(base);
      };

      // drag & drop sobre la cancha
      const startDrag=(team,id,e)=>{
        if(!open) return;
        e.preventDefault();
        const handleMove = (ev)=>{
          const r=ref.current?.getBoundingClientRect();
          if(!r)return;
          const touch=ev.touches?ev.touches[0]:ev;
          const xPct=((touch.clientX - r.left)/r.width)*100;
          const yPct=((touch.clientY - r.top)/r.height)*100;
          const [minX,maxX]=POS_RANGE[team]||[0,100];
          setCustomPos(prev=>({
            ...prev,
            [`${team}-${id}`]:{
              x: clamp(xPct,minX,maxX),
              y: clamp(yPct,0,100)
            }
          }));
        };
        const handleUp=()=>{
          window.removeEventListener('mousemove',handleMove);
          window.removeEventListener('touchmove',handleMove);
          window.removeEventListener('mouseup',handleUp);
          window.removeEventListener('touchend',handleUp);
        };
        window.addEventListener('mousemove',handleMove,{passive:false});
        window.addEventListener('touchmove',handleMove,{passive:false});
        window.addEventListener('mouseup',handleUp,{passive:true});
        window.addEventListener('touchend',handleUp,{passive:true});
      };

      return(
        <div className="w-full">
          <div
            ref={ref}
            className={`board shadow-xl mx-auto bg-transparent relative ${open?'':'pointer-events-none opacity-80'}`}
          >
            <img src={`assets/cancha.png?${FIELD_VER}`} alt="Cancha" className="field"/>
            {open && (
              <>
                {stadiumLabel ? (
                  <div className="absolute left-3 top-3 rounded-full bg-black/60 px-3 py-1 text-[13px] sm:text-base font-black uppercase tracking-[0.18em] text-white drop-shadow">
                    ESTADIO: {stadiumLabel}
                  </div>
                ) : null}
                {matchInfo ? (
                  <div className="absolute right-3 top-3 rounded-full bg-black/55 px-3 py-1 text-[13px] sm:text-base font-bold uppercase tracking-[0.15em] text-white drop-shadow text-right">
                    {matchInfo}
                  </div>
                ) : null}
              </>
            )}
            <div className="layer">
              {teamA.map((id,i)=>{
                const p=map[id];
                if(!p)return null;
                const pos=getPos('A',i,id);
                return(
                  <div
                    key={'A'+id}
                    className="absolute"
                    style={{
                      left:`${pos.x}%`,
                      top:`${pos.y}%`,
                      transform:`translate(-50%,-50%) scale(${scaleLive})`,
                      transformOrigin:'center'
                    }}
                    onMouseDown={e=>startDrag('A',id,e)}
                    onTouchStart={e=>startDrag('A',id,e)}
                  >
                    <FieldChip p={p} mode={chipMode}/>
                  </div>
                );
              })}
              {teamB.map((id,i)=>{
                const p=map[id];
                if(!p)return null;
                const pos=getPos('B',i,id);
                return(
                  <div
                    key={'B'+id}
                    className="absolute"
                    style={{
                      left:`${pos.x}%`,
                      top:`${pos.y}%`,
                      transform:`translate(-50%,-50%) scale(${scaleLive})`,
                      transformOrigin:'center'
                    }}
                    onMouseDown={e=>startDrag('B',id,e)}
                    onTouchStart={e=>startDrag('B',id,e)}
                  >
                    <FieldChip p={p} mode={chipMode}/>
                  </div>
                );
              })}
            </div>
          </div>
          {open && (
            <div className="grid grid-cols-2 sm:flex sm:flex-row justify-center gap-2 mt-3">
              <button
                onClick={descargar}
                className="rounded-xl bg-emerald-600 px-3 py-2 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500"
              >
                ‚¨áÔ∏è Descargar
              </button>
              <button
                onClick={copiar}
                className={`rounded-xl px-3 py-2 text-sm ring-1 ${
                  copied
                    ? 'bg-emerald-700 text-white ring-emerald-500'
                    : 'bg-slate-800 text-slate-100 ring-slate-700 hover:bg-slate-700'
                }`}
              >
                {copied?'Copiado ‚úÖ':'üìã Copiar'}
              </button>
              <button
                onClick={compartir}
                className="rounded-xl bg-cyan-600 px-3 py-2 text-sm text-white ring-1 ring-cyan-500 hover:bg-cyan-500"
              >
                üì§ Compartir
              </button>
            </div>
          )}
        </div>
      );
    };

    /* ========= Comparativa (Radar + Barras) ========= */
    const TeamRadar=({statsA,statsB,colorA,colorB})=>{
      const size=340;
      const center=size/2;
      const radius=center-28;
      const angleStep=(Math.PI*2)/STAT.length;
      const point=(v,i)=>{
        const a=-Math.PI/2 + i*angleStep;
        const r=(Math.max(0,v)/10)*radius;
        return [
          center + r*Math.cos(a),
          center + r*Math.sin(a)
        ].join(',');
      };
      const path=(arr)=>arr.map((v,i)=>point(v,i)).join(' ');
      const rings=[10,7.5,5,2.5];
      return(
        <svg viewBox={`0 0 ${size} ${size}`} className="w-full max-w-xl mx-auto">
          <defs>
            <linearGradient id="gradA" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stopColor={colorA} stopOpacity="0.10"/>
              <stop offset="100%" stopColor={colorA} stopOpacity="0.30"/>
            </linearGradient>
            <linearGradient id="gradB" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stopColor={colorB} stopOpacity="0.10"/>
              <stop offset="100%" stopColor={colorB} stopOpacity="0.30"/>
            </linearGradient>
          </defs>
          <g>
            {rings.map((r,idx)=>{
              const rad=(r/10)*radius;
              return(
                <g key={idx}>
                  <polygon
                    points={STAT.map((_,i)=>{
                      const a=-Math.PI/2 + i*angleStep;
                      return [center+rad*Math.cos(a),center+rad*Math.sin(a)].join(',');
                    }).join(' ')}
                    fill="none"
                    stroke="rgba(148,163,184,0.25)"
                    strokeDasharray="4 4"
                  />
                  <text
                    x={center}
                    y={center-rad-2}
                    textAnchor="middle"
                    fontSize="10"
                    fill="rgba(148,163,184,0.8)"
                  >
                    {r}
                  </text>
                </g>
              );
            })}
            {STAT.map((k,i)=>{
              const a=-Math.PI/2 + i*angleStep;
              const x=center + Math.cos(a)*radius;
              const y=center + Math.sin(a)*radius;
              const tx=center + Math.cos(a)*(radius+16);
              const ty=center + Math.sin(a)*(radius+16);
              return(
                <g key={k}>
                  <line x1={center} y1={center} x2={x} y2={y} stroke="rgba(148,163,184,0.35)" strokeWidth="1"/>
                  <text
                    x={tx}
                    y={ty}
                    textAnchor="middle"
                    fontSize="11"
                    fill="rgba(226,232,240,0.9)"
                    style={{fontWeight:700}}
                  >
                    {k}
                  </text>
                </g>
              );
            })}
            <polygon
              points={path(statsA)}
              fill="url(#gradA)"
              stroke={colorA}
              strokeWidth="2"
            />
            <polygon
              points={path(statsB)}
              fill="url(#gradB)"
              stroke={colorB}
              strokeWidth="2"
            />
          </g>
        </svg>
      );
    };

    const BarsCompare=({statsA,statsB,colorA,colorB,twoCols})=>{
      const cards=STAT.map((k,i)=>{
        const a=statsA[i]||0;
        const b=statsB[i]||0;
        const max=Math.max(10,a,b);
        const half=Math.max(1,max)/2;
        const pctA=Math.min(50,(a/half)*25);
        const pctB=Math.min(50,(b/half)*25);
        return(
          <div key={k} className="space-y-2 rounded-xl bg-slate-900/60 p-2 ring-1 ring-slate-800">
            <div className="flex items-center justify-between text-xs font-semibold text-slate-100">
              <span>{SL[k]}</span>
              <span className="text-[10px] font-normal text-slate-400">m√°x ref: {max.toFixed(1)}</span>
            </div>
            <div className="space-y-1.5">
              <div className="grid grid-cols-[1fr_auto_1fr] items-center gap-2 text-[11px] text-slate-200/90">
                <div className="flex items-center gap-1">
                  <span className="h-2 w-2 rounded-full" style={{background:colorA}}></span>
                  <span className="font-semibold tabular-nums">{a.toFixed(1)}</span>
                  <span className="text-[10px] text-slate-400">Equipo A</span>
                </div>
                <span className="text-[10px] font-semibold text-slate-400">vs</span>
                <div className="flex items-center justify-end gap-1">
                  <span className="text-[10px] text-slate-400">Equipo B</span>
                  <span className="font-semibold tabular-nums">{b.toFixed(1)}</span>
                  <span className="h-2 w-2 rounded-full" style={{background:colorB}}></span>
                </div>
              </div>
              <div className="relative h-6 overflow-hidden rounded-full bg-slate-800/80 ring-1 ring-slate-700">
                <div className="absolute inset-y-1 left-1/2 w-px bg-slate-700/80"></div>
                <div className="absolute inset-y-1 right-1/2 flex w-1/2 justify-end pr-1">
                  <div
                    className="h-full rounded-l-full"
                    style={{width:`${pctA}%`,background:hexA(colorA,0.9)}}
                  ></div>
                </div>
                <div className="absolute inset-y-1 left-1/2 flex w-1/2 justify-start pl-1">
                  <div
                    className="h-full rounded-r-full"
                    style={{width:`${pctB}%`,background:hexA(colorB,0.9)}}
                  ></div>
                </div>
              </div>
            </div>
          </div>
        );
      });
      return(
        <div className={twoCols? 'grid grid-cols-2 gap-3' : 'grid gap-3'}>
          {cards}
        </div>
      );
    };


    /* ========= Filas / Detalles ========= */
    const PinButtons=({id,pinA,pinB,setPinA,setPinB})=>{
      const onA=pinA.has(id),onB=pinB.has(id);
      const toggle=t=>{
        if(t==='A'){
          const a=new Set(pinA),b=new Set(pinB);
          onA?a.delete(id):a.add(id);
          b.delete(id);setPinA(a);setPinB(b);
        }else{
          const a=new Set(pinA),b=new Set(pinB);
          onB?b.delete(id):b.add(id);
          a.delete(id);setPinA(a);setPinB(b);
        }
      };
      return(
        <div className="flex gap-1">
          <button
            title="Fijar en A"
            onClick={()=>toggle('A')}
            className={`h-7 w-7 rounded-lg text-xs font-bold ring-1 ${
              onA
                ? 'bg-emerald-600 text-white ring-emerald-500'
                : 'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'
            }`}
          >
            A
          </button>
          <button
            title="Fijar en B"
            onClick={()=>toggle('B')}
            className={`h-7 w-7 rounded-lg text-xs font-bold ring-1 ${
              onB
                ? 'bg-blue-600 text-white ring-blue-500'
                : 'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'
            }`}
          >
            B
          </button>
        </div>
      );
    };

    const PlayerRow=({
      p,selected,onToggle,onOpen,onEdit,
      pinA,pinB,setPinA,setPinB,disableAdd,isAdmin
    })=>{
      const disabled=!selected && disableAdd;
      const [src,setSrc]=React.useState(p.fotoUrl||'');
      React.useEffect(()=>setSrc(p.fotoUrl||''),[p.fotoUrl]);
      return(
        <div className="flex items-center justify-between rounded-xl bg-slate-900/90 p-2 ring-1 ring-slate-700">
          <button onClick={onOpen} className="flex items-center gap-2 min-w-0 text-left">
            <img
              src={src||mkAvatar(p.nombre)}
              onError={(e)=>{e.currentTarget.src=mkAvatar(p.nombre)}}
              className="h-9 w-9 rounded-full object-cover ring-1 ring-slate-700"
              alt={p.nombre}
            />
            <div className="min-w-0">
              <div className="truncate font-semibold">{p.nombre}</div>
              {p.apodo?<div className="truncate text-xs text-slate-400">‚Äú{p.apodo}‚Äù</div>:null}
            </div>
          </button>
          <div className="flex items-center gap-2">
            <span className={`tabular-nums text-sm font-bold ${colorNum100(Math.round(p._GLOBAL*10))}`}>
              {Math.round(p._GLOBAL*10)}
            </span>
            {isAdmin && (
              <button
                onClick={onEdit}
                className="rounded-lg bg-slate-800 px-2 py-1 text-xs ring-1 ring-slate-700 hover:bg-slate-700"
              >
                ‚úèÔ∏è
              </button>
            )}
            <PinButtons
              id={p.id}
              pinA={pinA}
              pinB={pinB}
              setPinA={setPinA}
              setPinB={setPinB}
            />
            <button
              onClick={onToggle}
              disabled={disabled}
              className={`rounded-xl px-3 py-1 text-sm ring-1 ${
                selected
                  ? 'bg-emerald-600 text-white ring-emerald-500'
                  : disabled
                    ? 'bg-slate-800/40 text-slate-500 ring-slate-800 cursor-not-allowed'
                    : 'bg-slate-800 text-slate-200 ring-slate-700 hover:bg-slate-700'
              }`}
            >
              {selected? '‚úì' : '+'}
            </button>
          </div>
        </div>
      );
    };

    const Gauge=({label,v})=>(
      <div className="mb-1">
        <div className="flex justify-between text-xs">
          <span>{label}</span>
          <span className="font-semibold">{v}</span>
        </div>
        <div className="h-1.5 rounded bg-slate-700">
          <div className="h-1.5 rounded" style={{width:`${v*10}%`,backgroundColor:'#22c55e'}}/>
        </div>
      </div>
    );

    const PlayerDetails=({p,onClose})=>{
      const s=p.subs||(Object.fromEntries(
        STAT.map(k=>[k,(SUBS[k]||[]).map(n=>({n,v:p[k]}))])
      ));
      const posInfo=posInfoOf(p.pos);
      const posLabel=posInfo?.label||p.posicion||p.pos;
      const posCode=posInfo?.code||p.pos;
      return(
        <div className="fixed inset-0 z-[90] grid place-items-center bg-black/60 p-3" onClick={onClose}>
          <div
            className="w-full max-w-4xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 max-h-[90vh] overflow-auto"
            onClick={e=>e.stopPropagation()}
          >
            <div className="flex items-center justify-between">
              <div className="text-lg font-semibold">
                {p.nombre}{p.apodo?` ‚Äú${p.apodo}‚Äù`:''} {p.bandera||''}
              </div>
              <button
                onClick={onClose}
                className="rounded-lg bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
              >
                Cerrar
              </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
              <div className="flex justify-center">
                <FifaCard p={p}/>
              </div>
              <div className="space-y-3">
                <div className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
                  <div className="mb-1 text-sm font-semibold">Ficha</div>
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div className="rounded-lg bg-slate-900/60 p-2">
                      Posici√≥n:
                      <div className="font-semibold">{posLabel}</div>
                      <div className="text-[11px] text-slate-300">{posCode}</div>
                    </div>
                    <div className="rounded-lg bg-slate-900/60 p-2">
                      Pie:
                      <div className="font-semibold">{p.pie||'-'}</div>
                    </div>
                    <div className="rounded-lg bg-slate-900/60 p-2">
                      Equipo propio:
                      <div className="font-semibold">{p.equipoPropio||'-'}</div>
                    </div>
                    <div className="rounded-lg bg-slate-900/60 p-2">
                      Favorito:
                      <div className="font-semibold">{p.equipoFavorito||'-'}</div>
                    </div>
                  </div>
                </div>
                <div className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
                  <div className="mb-2 text-sm font-semibold">Radar</div>
                  <RadarChart
                    size={240}
                    dataSeries={[
                      {
                        label:p.nombre,
                        values:p,
                        stroke:'rgba(34,211,238,1)',
                        fill:'rgba(34,211,238,0.18)'
                      }
                    ]}
                  />
                </div>
              </div>
            </div>

            {STAT.map(k=>(
              <div key={k} className="rounded-xl bg-slate-800/60 p-2 ring-1 ring-slate-700">
                <div className="mb-1 text-sm font-semibold">
                  {SL[k]} <span className="opacity-75">({p[k]})</span>
                </div>
                {(s[k]||[]).map((it,idx)=>(
                  <Gauge key={idx} label={it.n} v={it.v}/>
                ))}
              </div>
            ))}
          </div>
        </div>
      );
    };

    /* ========= Formulario ========= */
    const PlayerFormModal=({initial,onClose,onSave,onDelete})=>{
      const isEdit=!!(initial&&initial.id);
      const defaultPosInfo = posInfoOf(initial?.pos) || POS_OPTIONS[5] || POS_OPTIONS[0];
      const defaultSubs=Object.fromEntries(
        STAT.map(k=>[k,(SUBS[k]||[]).map(n=>({n,v:5}))])
      );
      const start = initial
        ? JSON.parse(JSON.stringify(initial))
        : {
            nombre:'',apodo:'',pos:defaultPosInfo?.code||'MC',posicion:defaultPosInfo?.label||'Mediocampista Central',bandera:'üá¶üá∑',pie:'Derecho',
            equipoPropio:'',equipoFavorito:'',equipoFavoritoEscudoUrl:'',
            ATA:5,PAS:5,REG:5,VEL:5,DEF:5,FIS:5,ARQ:5,EQP:5,
            fotoUrl:'',subs:defaultSubs,especial:false,legendaria:false
          };

      if(!start.subs){
        start.subs=Object.fromEntries(
          STAT.map(k=>[k,(SUBS[k]||[]).map(n=>({n,v:start[k]||5}))])
        );
      }

      if(!start.posicion){
        const info=posInfoOf(start.pos);
        start.posicion=info?.label||start.pos||'Mediocampista Central';
      }

      const [f,setF]=useState(start);
      const set=(k,v)=>setF(s=>({...s,[k]:v}));
      const setSub=(k,i,v)=>setF(s=>{
        const subs=JSON.parse(JSON.stringify(s.subs));
        subs[k][i].v=clamp(+v||1,1,10);
        return {...s,subs};
      });
      const setPos=(code)=>{
        const info=posInfoOf(code);
        setF(s=>({
          ...s,
          pos: info?.code || code,
          posicion: info?.label || s.posicion
        }));
      };

      const submit=()=>{
        const id=isEdit?f.id:String(Date.now());
        const p={...f,id};
        const posInfo=posInfoOf(p.pos);
        p.pos=posInfo?.code||p.pos;
        p.posicion=posInfo?.label||p.posicion||p.pos;
        const derived=Object.fromEntries(
          STAT.map(k=>[
            k,
            clamp(
              Math.round(avg((p.subs?.[k]||[]).map(x=>+x.v||0))||p[k]),
              1,
              10
            )
          ])
        );
        Object.assign(p,derived);
        p._GLOBAL=globalOf(p);
        onSave(p);
        onClose();
      };

      return(
        <div className="fixed inset-0 z-[90] grid place-items-center bg-black/60 p-3" onClick={onClose}>
          <div
            className="w-full max-w-3xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 max-h-[92vh] overflow-auto"
            onClick={e=>e.stopPropagation()}
          >
            <div className="flex items-center justify-between">
              <div className="text-lg font-semibold">
                {isEdit?'Editar jugador':'A√±adir jugador'}
              </div>
              <div className="flex items-center gap-2">
                {isEdit && (
                  <button
                    onClick={()=>{onDelete?.(f.id);onClose();}}
                    className="rounded-lg bg-rose-700 px-2 py-1 text-white ring-1 ring-rose-500 hover:bg-rose-600"
                  >
                    Eliminar
                  </button>
                )}
                <button
                  onClick={onClose}
                  className="rounded-lg bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                >
                  Cerrar
                </button>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-3 text-sm">
              <div className="grid grid-cols-2 gap-2">
                <label className="flex flex-col gap-1">
                  Nombre
                  <input
                    value={f.nombre}
                    onChange={e=>set('nombre',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                  />
                </label>
                <label className="flex flex-col gap-1">
                  Apodo
                  <input
                    value={f.apodo}
                    onChange={e=>set('apodo',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                    placeholder="Opcional"
                  />
                </label>
                <label className="flex flex-col gap-1">
                  Posici√≥n
                  <select
                    value={f.pos}
                    onChange={e=>setPos(e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                  >
                    {!posInfoOf(f.pos) && f.pos && (
                      <option value={f.pos}>{f.pos} ‚Äî Personalizada</option>
                    )}
                    {POS_OPTIONS.map(opt=>(
                      <option key={opt.code} value={opt.code}>
                        {opt.code} ‚Äî {opt.label}
                      </option>
                    ))}
                  </select>
                </label>
                <label className="flex flex-col gap-1">
                  Bandera
                  <select
                    value={f.bandera}
                    onChange={e=>set('bandera',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                  >
                    {!FLAG_OPTIONS.some(o=>o.code===f.bandera) && f.bandera && (
                      <option value={f.bandera}>{f.bandera} Personalizada</option>
                    )}
                    {FLAG_OPTIONS.map(opt=>(
                      <option key={opt.code} value={opt.code}>
                        {opt.code} {opt.label}
                      </option>
                    ))}
                  </select>
                </label>
                <label className="flex flex-col gap-1">
                  Pie
                  <select
                    value={f.pie}
                    onChange={e=>set('pie',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                  >
                    {FOOT_OPTIONS.map(opt=>(
                      <option key={opt} value={opt}>{opt}</option>
                    ))}
                  </select>
                </label>
                <label className="flex flex-col gap-1">
                  Equipo propio
                  <input
                    value={f.equipoPropio}
                    onChange={e=>set('equipoPropio',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                  />
                </label>
                <label className="flex flex-col gap-1">
                  Favorito
                  <input
                    value={f.equipoFavorito}
                    onChange={e=>set('equipoFavorito',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                  />
                </label>
                <label className="col-span-2 flex flex-col gap-1">
                  URL escudo equipo favorito
                  <input
                    value={f.equipoFavoritoEscudoUrl}
                    onChange={e=>set('equipoFavoritoEscudoUrl',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                    placeholder="https://‚Ä¶"
                  />
                </label>
                <label className="col-span-2 flex flex-col gap-1">
                  Foto URL
                  <input
                    value={f.fotoUrl}
                    onChange={e=>set('fotoUrl',e.target.value)}
                    className="rounded bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
                    placeholder="https://‚Ä¶"
                  />
                </label>
                <div className="col-span-2 flex items-center gap-4 mt-1">
                  <label className="flex items-center gap-2 text-xs">
                    <input
                      type="checkbox"
                      checked={!!f.especial}
                      onChange={e=>set('especial',e.target.checked)}
                    />
                    Carta especial
                  </label>
                  <label className="flex items-center gap-2 text-xs">
                    <input
                      type="checkbox"
                      checked={!!f.legendaria}
                      onChange={e=>set('legendaria',e.target.checked)}
                    />
                    Carta legendaria
                  </label>
                </div>
              </div>

            </div>

            {/* Substats */}
            <div className="space-y-3">
              {STAT.map(k=>(
                <div key={k} className="rounded-xl bg-slate-800/60 p-3 ring-1 ring-slate-700">
                  <div className="mb-2 text-sm font-semibold">
                    {SL[k]} ‚Äî Sub-stats (promedio ‚Üí {Math.round(avg((f.subs?.[k]||[]).map(it=>+it.v||0))||f[k])})
                  </div>
                  <div className="grid gap-2">
                    {(f.subs[k]||[]).map((it,i)=>(
                      <div
                        key={i}
                        className="grid grid-cols-[120px,1fr,42px] items-center gap-2 text-sm"
                      >
                        <div className="text-slate-300">{it.n}</div>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          step="1"
                          value={it.v}
                          onChange={e=>setSub(k,i,e.target.value)}
                        />
                        <div className="tabular-nums text-right">{it.v}</div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>

            <div className="flex justify-end gap-2">
              <button
                onClick={submit}
                className="rounded-xl bg-emerald-600 px-3 py-1 text-sm text-white ring-1 ring-emerald-500 hover:bg-emerald-500"
              >
                Guardar
              </button>
            </div>
          </div>
        </div>
      );
    };

    /* ========= Settings ========= */
    const SettingsModal=({
      onClose,kChem,setKChem,
      formScale,setFormScale,
      partidoTwoCols,setPartidoTwoCols,
      teamColors,setTeamColors,
      onOpenGlossary,
      isAdmin,setIsAdmin,
      onImportPlayers,onExportPlayers,onReloadPlayers,
      remoteStatus
    })=>{
      const [a,setA]=useState(teamColors.A);
      const [b,setB]=useState(teamColors.B);
      useEffect(()=>{
        setA(teamColors.A);
        setB(teamColors.B);
      },[teamColors]);

      const fileRef=useRef(null);

      const saveColors=()=>setTeamColors({A:a,B:b});

      const presets=['#10b981','#3b82f6','#22c55e','#38bdf8','#f97316','#a855f7','#facc15','#e11d48'];

      const logout=()=>{
        setIsAdmin(false);
        alert('Sesi√≥n admin cerrada');
      };

      return(
        <div className="fixed inset-0 z-[90] grid place-items-center bg-black/60 p-3" onClick={onClose}>
          <div
            className="w-full max-w-md space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700"
            onClick={e=>e.stopPropagation()}
          >
            <div className="mb-1 flex items-center justify-between">
              <div className="text-lg font-semibold">Ajustes</div>
              {isAdmin && (
                <span className="text-xs px-2 py-1 rounded-full bg-emerald-700/40 text-emerald-200 ring-1 ring-emerald-500/50">
                  Admin
                </span>
              )}
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Peso de qu√≠mica</div>
              <input
                type="range" min="0" max="1" step="0.05"
                value={kChem}
                onChange={e=>setKChem(+e.target.value)}
                className="w-full"
              />
              <div className="text-xs text-slate-300 mt-1">k = {kChem.toFixed(2)}</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Tama√±o tarjetas en Formaci√≥n</div>
              <input
                type="range" min="0.38" max="0.80" step="0.01"
                value={formScale}
                onChange={e=>setFormScale(+e.target.value)}
                className="w-full"
              />
              <div className="text-xs text-slate-300 mt-1">escala = {formScale.toFixed(2)}</div>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700">
              <div className="mb-1 text-sm font-semibold">Vista de ‚ÄúPartido‚Äù</div>
              <label className="flex items-center gap-2 text-sm">
                <input
                  type="checkbox"
                  checked={partidoTwoCols}
                  onChange={e=>setPartidoTwoCols(e.target.checked)}
                />
                <span>{partidoTwoCols? '2 columnas (A|B)':'1 columna (apilado)'}</span>
              </label>
            </div>

            <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-3">
              <div className="text-sm font-semibold">Colores de equipos</div>
              <div className="flex items-center gap-3">
                <label className="flex items-center gap-2 text-sm">
                  A
                  <input
                    type="color"
                    value={a}
                    onChange={e=>setA(e.target.value)}
                  />
                </label>
                <label className="flex items-center gap-2 text-sm">
                  B
                  <input
                    type="color"
                    value={b}
                    onChange={e=>setB(e.target.value)}
                  />
                </label>
                <button
                  onClick={saveColors}
                  className="ml-auto rounded-lg bg-slate-800 px-2 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700"
                >
                  Guardar
                </button>
              </div>

              <div className="mt-1 space-y-1 text-xs text-slate-300">
                <div className="flex items-center gap-2 flex-wrap">
                  <span>Presets A:</span>
                  {presets.map(c=>(
                    <button
                      key={'A'+c}
                      onClick={()=>setA(c)}
                      className="h-5 w-5 rounded-full border border-slate-500"
                      style={{backgroundColor:c}}
                    />
                  ))}
                </div>
                <div className="flex items-center gap-2 flex-wrap">
                  <span>Presets B:</span>
                  {presets.map(c=>(
                    <button
                      key={'B'+c}
                      onClick={()=>setB(c)}
                      className="h-5 w-5 rounded-full border border-slate-500"
                      style={{backgroundColor:c}}
                    />
                  ))}
                </div>
              </div>
            </div>

            {isAdmin && (
              <div className="rounded-xl bg-slate-800/50 p-3 ring-1 ring-slate-700 space-y-2">
                <div className="text-sm font-semibold">Listado de jugadores</div>
                <p className="text-xs text-slate-300">
                  Import√° o export√° el JSON del plantel. Solo disponible en modo admin.
                </p>
                <div className="flex flex-wrap gap-2">
                  <button
                    onClick={()=>fileRef.current?.click()}
                    className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700"
                  >
                    üìÇ Importar JSON
                  </button>
                  <button
                    onClick={onExportPlayers}
                    className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700"
                  >
                    üíæ Exportar JSON
                  </button>
                  <button
                    onClick={()=>onReloadPlayers?.(true)}
                    className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700"
                  >
                    üîÑ Recargar archivo base
                  </button>
                </div>
                <div className="text-[11px] text-slate-400 space-y-1">
                  <div>
                    Archivo base: {remoteStatus?.loadedAt
                      ? new Date(remoteStatus.loadedAt).toLocaleString()
                      : 'pendiente de carga'}
                  </div>
                  {remoteStatus?.error && (
                    <div className="text-rose-300">Error: {remoteStatus.error}</div>
                  )}
                </div>
                <input
                  ref={fileRef}
                  type="file"
                  accept="application/json"
                  className="hidden"
                  onChange={e=>{
                    const file=e.target.files?.[0];
                    onImportPlayers?.(file);
                    if(e.target.value) e.target.value='';
                  }}
                />
              </div>
            )}

            <div className="flex items-center justify-between">
              <button
                onClick={onOpenGlossary}
                className="rounded-xl bg-slate-800 px-3 py-1 text-sm ring-1 ring-slate-700 hover:bg-slate-700"
              >
                üìò Glosario
              </button>
              <div className="flex items-center gap-2">
                {isAdmin && (
                  <button
                    onClick={logout}
                    className="rounded-xl bg-rose-700 px-3 py-1 text-sm text-white ring-1 ring-rose-500 hover:bg-rose-600"
                  >
                    Salir admin
                  </button>
                )}
                <button
                  onClick={onClose}
                  className="rounded-xl bg-slate-800 px-3 py-1 text-sm text-slate-200 ring-1 ring-slate-700 hover:bg-slate-700"
                >
                  Cerrar
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const GlossaryModal=({onClose})=>(
      <div className="fixed inset-0 z-[90] grid place-items-center bg-black/60 p-3" onClick={onClose}>
        <div
          className="w-full max-w-3xl space-y-3 rounded-2xl bg-slate-900 p-4 ring-1 ring-slate-700 text-sm max-h-[90vh] overflow-auto"
          onClick={e=>e.stopPropagation()}
        >
          <div className="flex items-center justify-between">
            <div className="text-lg font-semibold">Glosario</div>
            <button
              onClick={onClose}
              className="rounded-lg bg-slate-800 px-2 py-1 ring-1 ring-slate-700"
            >
              Cerrar
            </button>
          </div>
          <div className="space-y-4 leading-relaxed text-slate-200">
            <div>
              <div className="font-semibold text-emerald-300">Rating de jugador (1‚Äì100)</div>
              <div>
                Promedio ponderado de stats con pesos:
                ATA(.18), DEF(.16), PAS(.14), REG(.14), VEL(.14), FIS(.10), ARQ(.07), EQP(.07).
              </div>
              <div className="mt-1">
                <code>Rating = Œ£(stat √ó peso) / Œ£(pesos)</code>
              </div>
            </div>
            <div>
              <div className="font-semibold text-emerald-300">Stats (1‚Äì10) y substats</div>
              <ul className="list-disc pl-5 space-y-1">
                <li><b>ATA</b>: Posici√≥n, Definici√≥n, Potencia</li>
                <li><b>PAS</b>: Visi√≥n, Pase corto, Pase largo</li>
                <li><b>REG</b>: Agilidad, Control, Equilibrio</li>
                <li><b>VEL</b>: Aceleraci√≥n, Pico, Arranque</li>
                <li><b>DEF</b>: Marcaje, Anticipaci√≥n, Entradas</li>
                <li><b>FIS</b>: Resistencia, Fuerza, Salto</li>
                <li><b>ARQ</b>: Reflejos, Manos, Saque</li>
                <li><b>EQP</b>: Colaboraci√≥n, Disciplina, Liderazgo</li>
              </ul>
              <div className="mt-1 text-slate-300">
                Pod√©s editar cada stat directamente; el promedio de sus substats (1‚Äì10) queda como referencia.
              </div>
            </div>
            <div>
              <div className="font-semibold text-emerald-300">Qu√≠mica de equipo (1‚Äì10)</div>
              <div>
                Promedio de afinidad por parejas. Sube si comparten equipo propio/favorito
                y por el valor EQP promedio.
              </div>
            </div>
            <div>
              <div className="font-semibold text-emerald-300">Rating de equipo (1‚Äì100)</div>
              <div>Promedio de los Ratings individuales de los 5 jugadores.</div>
            </div>
            <div>
              <div className="font-semibold text-emerald-300">Score</div>
              <div>Combina Rating y Qu√≠mica con un peso <b>k</b> (configurable):</div>
              <div>
                <code>Score = Rating de equipo + (Qu√≠mica de equipo √ó k)</code>
              </div>
              <div className="text-slate-400 text-xs mt-1">
                Umbrales del sem√°foro: Parejo &lt; 0.30 ‚Äî Aceptable &lt; 0.80 ‚Äî Desbalanceado ‚â• 0.80.
              </div>
            </div>
          </div>
        </div>
      </div>
    );

    /* ========= App ========= */
    const App=()=>{
      const initP=withG(J(localStorage.getItem('f5.players'),SEED));
      const[players,setPlayers]=useState(initP);
      const[selected,setSelected]=useState(()=>new Set(J(localStorage.getItem('f5.selected'),[])));
      const[teams,setTeams]=useState(()=>J(localStorage.getItem('f5.teams'),null));
      const[kChem,setKChem]=useState(()=>+(localStorage.getItem('f5.kchem')??0.6));
      const[pinA,setPinA]=useState(()=>new Set(J(localStorage.getItem('f5.pins.A'),[])));
      const[pinB,setPinB]=useState(()=>new Set(J(localStorage.getItem('f5.pins.B'),[])));
      const[formScale,setFormScale]=useState(()=>+(localStorage.getItem('f5.formScale')??0.50));
      const[fieldOpen,setFieldOpen]=useState(false);
      const[stadium,setStadium]=useState(()=>localStorage.getItem('f5.stadium')||'');
      const[matchDateTime,setMatchDateTime]=useState(()=>localStorage.getItem('f5.matchDateTime')||'');
      const[partidoTwoCols,setPartidoTwoCols]=useState(()=>{
        try{return JSON.parse(localStorage.getItem('f5.partidoTwoCols')??'true');}
        catch{return true;}
      });
      const[teamColors,setTeamColors]=useState(()=>{
        try{return JSON.parse(localStorage.getItem('f5.teamColors')??'{"A":"#10b981","B":"#3b82f6"}');}
        catch{return{A:'#10b981',B:'#3b82f6'};}
      });
      const[fieldChipMode,setFieldChipMode]=useState(()=>{
        const v=localStorage.getItem('f5.fieldChipMode')||'ring';
        return v==='card'?'card':'ring';
      });
      const[tab,setTab]=useState('partido');
      const[form,setForm]=useState(null);
      const[settings,setSettings]=useState(false);
      const[q,setQ]=useState('');
      const[sort,setSort]=useState('global-desc');
      const[showGlossary,setShowGlossary]=useState(false);
      const[playerDetailId,setPlayerDetailId]=useState(null);
      const[isAdmin,setIsAdmin]=useState(()=>localStorage.getItem('f5.isAdmin')==='1');
      const[formKey,setFormKey]=useState(0); // para resetear formaci√≥n completa
      const[remoteStatus,setRemoteStatus]=useState({loadedAt:null,error:null});

      // persist
      useEffect(()=>localStorage.setItem('f5.players',JSON.stringify(players)),[players]);
      useEffect(()=>localStorage.setItem('f5.selected',JSON.stringify([...selected])),[selected]);
      useEffect(()=>localStorage.setItem('f5.teams',JSON.stringify(teams)),[teams]);
      useEffect(()=>localStorage.setItem('f5.kchem',String(kChem)),[kChem]);
      useEffect(()=>localStorage.setItem('f5.pins.A',JSON.stringify([...pinA])),[pinA]);
      useEffect(()=>localStorage.setItem('f5.pins.B',JSON.stringify([...pinB])),[pinB]);
      useEffect(()=>localStorage.setItem('f5.formScale',String(formScale)),[formScale]);
      useEffect(()=>localStorage.setItem('f5.stadium',stadium),[stadium]);
      useEffect(()=>localStorage.setItem('f5.matchDateTime',matchDateTime),[matchDateTime]);
      useEffect(()=>localStorage.setItem('f5.partidoTwoCols',JSON.stringify(partidoTwoCols)),[partidoTwoCols]);
      useEffect(()=>localStorage.setItem('f5.teamColors',JSON.stringify(teamColors)),[teamColors]);
      useEffect(()=>localStorage.setItem('f5.isAdmin',isAdmin?'1':'0'),[isAdmin]);
      useEffect(()=>localStorage.setItem('f5.fieldChipMode',fieldChipMode),[fieldChipMode]);

      const fetchExternalPlayers=React.useCallback(async(bust=false)=>{
        try{
          setRemoteStatus(s=>({...s,error:null}));
          const res=await fetch(`assets/players.json${bust?`?v=${Date.now()}`:''}`,{cache:'no-cache'});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const data=await res.json();
          const list=Array.isArray(data)?data:(data?.players||[]);
          if(!Array.isArray(list)) throw new Error('Formato inv√°lido');
          setPlayers(cleanPlayers(list));
          setRemoteStatus({loadedAt:new Date().toISOString(),error:null});
        }catch(err){
          console.error('No se pudo cargar el archivo externo',err);
          setRemoteStatus(s=>({loadedAt:s.loadedAt||null,error:err?.message||'Error desconocido'}));
        }
      },[]);

      useEffect(()=>{
        fetchExternalPlayers(true);
      },[fetchExternalPlayers]);

      // altura din√°mica de la vista
      const viewportRef=useRef(null);
      const pageRefs=useRef({partido:null,plantel:null});
      const fitHeight=()=>{
        const vp=viewportRef.current;if(!vp)return;
        const pg=pageRefs.current[tab];if(!pg)return;
        vp.style.height=pg.scrollHeight+'px';
      };
      useEffect(()=>{fitHeight();},[tab,players,selected,teams,formScale,partidoTwoCols,fieldChipMode,fieldOpen]);
      useEffect(()=>{
        const fn=()=>fitHeight();
        window.addEventListener('resize',fn,{passive:true});
        return()=>window.removeEventListener('resize',fn);
      },[]);
      useEffect(()=>{window.scrollTo({top:0,behavior:'instant'});},[tab]);

      // swipe
      useEffect(()=>{
        const vp=viewportRef.current; if(!vp) return;
        let sx=0,dx=0,active=false;
        const ts=(e)=>{active=true; sx=e.touches[0].clientX; dx=0};
        const tm=(e)=>{if(!active)return; dx=e.touches[0].clientX-sx};
        const te=()=>{
          if(!active)return;
          if(dx>60) setTab('partido');
          else if(dx<-60) setTab('plantel');
          active=false;
        };
        vp.addEventListener('touchstart',ts,{passive:true});
        vp.addEventListener('touchmove',tm,{passive:true});
        vp.addEventListener('touchend',te,{passive:true});
        return ()=>{
          vp.removeEventListener('touchstart',ts);
          vp.removeEventListener('touchmove',tm);
          vp.removeEventListener('touchend',te);
        };
      },[]);

      const map=useMemo(
        ()=>Object.fromEntries(players.map(p=>[p.id,p])),
        [players]
      );

      const convocados=[...selected];
      const canMake=convocados.length===10;
      const reachedMax=convocados.length>=10;
      const invalidPins=false; // reservado

      const toggle=id=>setSelected(s=>{
        const n=new Set(s);
        if(n.has(id)) n.delete(id);
        else{
          if(reachedMax)return n;
          n.add(id);
        }
        return n;
      });

      const chem=useMemo(()=>{
        const q={};
        for(const a of players){
          q[a.id]={};
          for(const b of players){
            if(a.id===b.id){q[a.id][b.id]=10;continue;}
            if(q[b.id]?.[a.id]!=null){q[a.id][b.id]=q[b.id][a.id];continue;}
            let v=5;
            if(a.equipoPropio&&b.equipoPropio&&a.equipoPropio===b.equipoPropio)v+=1.2;
            if(a.equipoFavorito&&b.equipoFavorito&&a.equipoFavorito===b.equipoFavorito)v+=.8;
            v+=(((a.EQP+b.EQP)/2)-5)*.15;
            q[a.id][b.id]=clamp(+v.toFixed(2),1,10);
          }
        }
        return q;
      },[players]);

      const makeR=()=>{
        if(!canMake||invalidPins)return;
        const ids=[...convocados];
        ids.sort(()=>Math.random()-.5);
        setTeams({A:ids.slice(0,5),B:ids.slice(5)});
        setFormKey(k=>k+1); // reset formation layout
      };
      const makeB=()=>{
        if(!canMake||invalidPins)return;
        const r=balancedWithPins(convocados,map,chem,kChem,new Set(),new Set());
        setTeams({A:r.A,B:r.B});
        setFormKey(k=>k+1);
      };
      const clearConvocados=()=>{
        setSelected(new Set());
        setTeams(null);
        setFormKey(k=>k+1);
      };

      const filtered=[...players].filter(p=>{
        const t=q.trim().toLowerCase();
        return !t ||
          (p.nombre||'').toLowerCase().includes(t) ||
          (p.apodo||'').toLowerCase().includes(t) ||
          (p.equipoPropio||'').toLowerCase().includes(t) ||
          (p.equipoFavorito||'').toLowerCase().includes(t);
      });
      filtered.sort((a,b)=>
        sort==='global-asc' ? a._GLOBAL-b._GLOBAL
        : sort==='nombre' ? a.nombre.localeCompare(b.nombre)
        : b._GLOBAL-a._GLOBAL
      );

      const teamA=teams?.A||[];
      const teamB=teams?.B||[];

      const ratingA=Math.round(teamGlobal(teamA,map)*10)||0;
      const ratingB=Math.round(teamGlobal(teamB,map)*10)||0;
      const chemA=+chemTeam(teamA,chem).toFixed(2)||0;
      const chemB=+chemTeam(teamB,chem).toFixed(2)||0;
      const scoreA=teamScoreUI(teamA,map,chem,kChem)||0;
      const scoreB=teamScoreUI(teamB,map,chem,kChem)||0;

      const teamStatAvg=(ids)=>STAT.map(k=>+(avg(ids.map(id=>map[id]?.[k]||0)).toFixed(2)||0));
      const statAvgA=teamStatAvg(teamA);
      const statAvgB=teamStatAvg(teamB);

      const gridCols = partidoTwoCols ? 'grid-cols-2' : 'grid-cols-1';
      const matchLabel = (()=>{
        if(!matchDateTime) return '';
        const d=new Date(matchDateTime);
        if(isNaN(d.getTime())) return matchDateTime;
        return d.toLocaleString('es-AR',{dateStyle:'medium',timeStyle:'short'});
      })();

      // install
      const [deferredPrompt,setDeferredPrompt]=useState(null);
      useEffect(()=>{
        const onPrompt=(e)=>{
          e.preventDefault();
          setDeferredPrompt(e);
        };
        window.addEventListener('beforeinstallprompt',onPrompt);
        return()=>window.removeEventListener('beforeinstallprompt',onPrompt);
      },[]);
      const doInstall=async()=>{
        if(!deferredPrompt){
          alert('Tu navegador no ofrece instalaci√≥n ahora. Prob√° desde Chrome en Android con conexi√≥n HTTPS.');
          return;
        }
        deferredPrompt.prompt();
      };

      // Guardar / Eliminar jugador
      const upsertPlayer = (p)=>setPlayers(ps=>{
        const i=ps.findIndex(x=>x.id===p.id);
        if(i>=0){
          const cp=[...ps];
          cp[i]=withG([p])[0];
          return cp;
        }
        return withG([...ps,p]);
      });
      const deletePlayer = (id)=>{
        setPlayers(ps=>ps.filter(x=>x.id!==id));
        setSelected(s=>{
          const n=new Set(s);
          n.delete(id);
          return n;
        });
        setTeams(t=>{
          if(!t)return t;
          return {
            A:(t.A||[]).filter(x=>x!==id),
            B:(t.B||[]).filter(x=>x!==id)
          };
        });
      };

      // Botones extra de formaci√≥n
      const resetFormation=()=>{
        setFormKey(k=>k+1); // remonta el componente y borra posiciones personalizadas
      };
      const shuffleInsideTeams=()=>{
        setTeams(t=>{
          if(!t) return t;
          return {
            A: shuffle(t.A || []),
            B: shuffle(t.B || [])
          };
        });
        setFormKey(k=>k+1);
      };

      const importPlayersFile=async(file)=>{
        if(!file)return;
        try{
          const txt=await file.text();
          const data=JSON.parse(txt);
          const list=Array.isArray(data)?data:(data?.players||[]);
          if(!Array.isArray(list)) throw new Error('El JSON debe contener un array de jugadores');
          setPlayers(cleanPlayers(list));
          setRemoteStatus({loadedAt:new Date().toISOString(),error:null});
          alert('Listado importado correctamente');
        }catch(err){
          console.error('Error al importar',err);
          alert('No se pudo importar el archivo: '+(err?.message||'Error desconocido'));
        }
      };

      const exportPlayersFile=()=>{
        const payload={players:players.map(({_GLOBAL,...rest})=>rest)};
        const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='f5c-players.json';
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url),1000);
      };

      // Modo admin oculto (5 toques en el t√≠tulo)
      const secretRef=useRef({taps:0,last:0});
      const handleTitleClick=()=>{
        const now=Date.now();
        const s=secretRef.current;
        if(now - s.last < 800) s.taps++;
        else s.taps=1;
        s.last=now;
        if(s.taps>=5){
          const pw=prompt('Clave admin');
          if(pw==='f5admin'){
            setIsAdmin(true);
            alert('Modo admin activado');
          }else{
            alert('Clave incorrecta');
          }
        }
      };

      const currentDetail = playerDetailId ? map[playerDetailId] : null;

      const convocadosCount = [...selected].length;

      return(
        <div className="min-h-screen">
          <header className="app-header">
            <div className="mx-auto max-w-5xl px-3 py-3">
              <div className="flex items-center justify-between">
                <button
                  onClick={handleTitleClick}
                  className="flex items-center gap-2 select-none"
                >
                  <span className="text-2xl leading-none">‚öΩ</span>
                  <div className="text-2xl font-extrabold title-fifa">F5C</div>
                </button>
                <div className="flex items-center gap-2">
                  <button
                    onClick={()=>setSettings(true)}
                    className="rounded-full bg-slate-800 px-2 py-2 text-sm ring-1 ring-slate-700 hover:bg-slate-700"
                    aria-label="Config"
                  >
                    ‚ò∞
                  </button>
                </div>
              </div>
              <div className="tabs-bar">
                <button
                  className={`tab-large ${tab==='partido'?'active':''}`}
                  onClick={()=>setTab('partido')}
                >
                  Partido
                </button>
                <button
                  className={`tab-large ${tab==='plantel'?'active':''}`}
                  onClick={()=>setTab('plantel')}
                >
                  Plantel
                </button>
              </div>
            </div>
          </header>
          <div className="header-spacer"></div>

          {/* Convocados flotante */}
          <div
            className="fixed z-40 left-1/2 -translate-x-1/2"
            style={{ top: 'calc(var(--header-h) + 6px)' }}
          >
            <span className="inline-block rounded-full bg-slate-900/80 px-3 py-1 text-xs ring-1 ring-slate-700 shadow-lg">
              Convocados: <b>{convocadosCount}</b>/10
            </span>
          </div>

          {/* Viewport con altura din√°mica */}
          <div ref={viewportRef} className="tabs-viewport" style={{height:'auto', marginTop:'24px'}}>
            <div className="tabs-track" style={{transform:`translateX(${tab==='partido'?'0%':'-50%'})`}}>

              {/* === PARTIDO === */}
              <section className="tabs-page" ref={el=>pageRefs.current.partido=el}>
                <div className="mx-auto max-w-5xl space-y-3">

                  {/* Acciones partido */}
                  <div className="grid grid-cols-2 gap-2">
                    <button
                      onClick={makeR}
                      className={`rounded-xl px-4 py-3 font-bold ring-1 ${
                        canMake&&!invalidPins
                          ? 'bg-slate-800 hover:bg-slate-700 ring-slate-700'
                          : 'bg-slate-800/40 ring-slate-800 cursor-not-allowed'
                      }`}
                    >
                      üé≤ Al azar
                    </button>
                    <button
                      onClick={makeB}
                      className={`rounded-xl px-4 py-3 font-bold ring-1 ${
                        canMake&&!invalidPins
                          ? 'bg-emerald-600 text-white hover:bg-emerald-500 ring-emerald-500'
                          : 'bg-emerald-700/40 text-white/60 ring-emerald-800 cursor-not-allowed'
                      }`}
                    >
                      ‚öñÔ∏è Equilibrado
                    </button>
                  </div>

                  {/* Score equipos (tarjetas arriba) con fondo semitransparente del color del equipo */}
                  <div className={`grid gap-2 ${gridCols}`}>
                    {[['A',ratingA,chemA,scoreA],['B',ratingB,chemB,scoreB]].map(([t,rt,ch,sc],i)=>{
                      const col=i?teamColors.B:teamColors.A;
                      return(
                        <div
                          key={t}
                          className="rounded-2xl p-3 ring-2 shadow-sm"
                          style={{
                            background: hexA(col,0.75),
                            borderColor: hexA("#000",0.85)
                          }}
                        >
                          <div className="mb-1 text-sm font-semibold flex items-center justify-between">
                            <span>Equipo {t}</span>
                          </div>
                          <div className="grid grid-cols-3 gap-2 text-center">
                            <div>
                              <div className="text-xs text-slate-300">Rating</div>
                              <div className={`text-xl font-extrabold ${colorNum100(rt)}`}>{rt||0}</div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-300">Qu√≠mica</div>
                              <div className={`text-xl font-extrabold ${colorNum10(ch)}`}>{ch||0}</div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-300">Score</div>
                              <div className="text-xl font-extrabold text-cyan-300">{sc||0}</div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {/* Comparativa visual */}
                  <div className="rounded-2xl bg-slate-900/60 p-3 ring-1 ring-slate-700 space-y-4">
                    <div className="flex flex-wrap items-center justify-between gap-2">
                      <div>
                        <div className="text-sm font-semibold text-slate-100">Comparativa de equipos</div>
                        <div className="text-xs text-slate-300">Promedio de stats (1‚Äì10)</div>
                      </div>
                      <div className="flex items-center gap-3 text-[11px] text-slate-200">
                        <div className="flex items-center gap-1">
                          <span className="h-3 w-3 rounded-full" style={{background:hexA(teamColors.A,0.85)}}></span>
                          Equipo A
                        </div>
                        <div className="flex items-center gap-1">
                          <span className="h-3 w-3 rounded-full" style={{background:hexA(teamColors.B,0.85)}}></span>
                          Equipo B
                        </div>
                      </div>
                    </div>
                    {teamA.length && teamB.length ? (
                      <>
                        {/* Listado de jugadores por equipo con panel de color semitransparente */}
                        <div className={`grid gap-3 ${gridCols}`}>
                          {['A','B'].map((t,i)=>{
                            const ids=t==='A'?teamA:teamB;
                            const col=i?teamColors.B:teamColors.A;
                            return(
                              <div
                                key={t}
                                className="rounded-2xl p-3 ring-2"
                                style={{
                                  background: hexA(col,0.75),
                                  borderColor: hexA("#000",0.75)
                                }}
                              >
                                <div className="mb-2 flex items-center justify-between">
                                  <div className="text-xs font-semibold text-slate-100">
                                    Equipo {t}
                                  </div>
                                </div>
                                <div className="space-y-2">
                                  {ids.map((id,idx)=>{
                                    const p=map[id];
                                    if(!p)return null;
                                    return(
                                      <div
                                        key={id}
                                        draggable
                                        onDragStart={e=>{
                                          e.dataTransfer.effectAllowed='move';
                                          window.__drag={team:t,id};
                                        }}
                                        onDragOver={e=>e.preventDefault()}
                                        onDrop={e=>{
                                          e.preventDefault();
                                          const d=window.__drag;
                                          if(!d)return;
                                          const fromT=d.team,toT=t;
                                          setTeams(tt=>{
                                            const A=[...(tt?.A||[])],B=[...(tt?.B||[])];
                                            const fromArr=fromT==='A'?A:B;
                                            const toArr=toT==='A'?A:B;
                                            const fromIdx=fromArr.indexOf(d.id);
                                            const swapId=toArr[idx];
                                            if(fromIdx<0)return tt;
                                            fromArr[fromIdx]=swapId;
                                            toArr[idx]=d.id;
                                            return {A,B};
                                          });
                                          setFormKey(k=>k+1);
                                        }}
                                        className="flex items-center justify-between rounded-xl bg-slate-900/90 p-2 ring-1 ring-slate-700"
                                      >
                                        <button
                                          onClick={()=>setPlayerDetailId(id)}
                                          className="flex items-center gap-2 min-w-0"
                                        >
                                          <img
                                            src={p.fotoUrl||mkAvatar(p.nombre)}
                                            onError={(e)=>{e.currentTarget.src=mkAvatar(p.nombre)}}
                                            className="h-8 w-8 rounded-full object-cover ring-1 ring-slate-700"
                                            alt={p.nombre}
                                          />
                                          <span className="truncate">
                                            {p.nombre}{p.apodo?` ‚Äú${p.apodo}‚Äù`:''}
                                          </span>
                                        </button>
                                        <span className={`tabular-nums text-sm font-bold ${colorNum100(Math.round(p._GLOBAL*10))}`}>
                                          {Math.round(p._GLOBAL*10)}
                                        </span>
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                        <TeamRadar
                          statsA={statAvgA}
                          statsB={statAvgB}
                          colorA={teamColors.A}
                          colorB={teamColors.B}
                        />
                        <BarsCompare
                          statsA={statAvgA}
                          statsB={statAvgB}
                          colorA={teamColors.A}
                          colorB={teamColors.B}
                          twoCols={partidoTwoCols}
                        />
                      </>
                    ) : (
                      <div className="flex items-center gap-3 rounded-xl bg-slate-800/60 p-4 text-sm text-slate-200">
                        <span className="text-xl">‚ÑπÔ∏è</span>
                        <div>
                          <div className="font-semibold text-slate-100">Esperando equipos</div>
                          <div className="text-slate-300">Arm√° dos equipos para ver el radar y las barras comparativas.</div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Sem√°foro */}
                  <div className="rounded-2xl p-3 bg-transparent">
                    {(()=>{
                      const sA=teamScoreUI(teamA,map,chem,kChem);
                      const sB=teamScoreUI(teamB,map,chem,kChem);
                      const d=Math.abs(sA-sB).toFixed(2);
                      let lb='Parejo';
                      let cls='bg-emerald-600/15 text-emerald-200 ring-emerald-500/30';
                      if(d>=.8){
                        lb='Desbalanceado';
                        cls='bg-rose-600/15 text-rose-200 ring-rose-500/30';
                      }else if(d>=.3){
                        lb='Aceptable';
                        cls='bg-amber-600/15 text-amber-100 ring-amber-500/30';
                      }
                      return(
                        <div className={`rounded-xl p-3 ring-1 ${cls}`}>
                          <div className="text-sm">
                            Resultado: <b>{lb}</b>{' '}
                            <span className="opacity-80">
                              (A: {sA} vs B: {sB})
                            </span>
                          </div>
                          <div className="mt-1 text-xs text-slate-200/80">
                            Diferencia de score: <b>{d}</b>
                          </div>
                        </div>
                      );
                    })()}
                  </div>

                  {/* Formaci√≥n + botones de formaci√≥n abajo */}
                  <div className="mt-2 rounded-2xl bg-slate-900/50 p-3 ring-1 ring-slate-700 space-y-3">
                    <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                      <div>
                        <div className="text-sm font-semibold text-slate-100">Formaci√≥n en la cancha</div>
                        <div className="text-xs text-slate-300">Despleg√° para editar, arrastrar y exportar</div>
                      </div>
                      <div className="flex flex-wrap gap-2 justify-end">
                        <button
                          onClick={()=>setFieldOpen(o=>!o)}
                          className={`rounded-xl px-3 py-2 text-sm ring-1 ${
                            fieldOpen
                              ? 'bg-emerald-700 text-white ring-emerald-500'
                              : 'bg-slate-900 text-slate-100 ring-slate-700 hover:bg-slate-800'
                          }`}
                        >
                          {fieldOpen?'Ocultar cancha':'Desplegar cancha'}
                        </button>
                        {fieldOpen && (
                          <>
                            <div className="flex items-center gap-2">
                              <label className="text-xs text-slate-300">Zoom</label>
                              <input
                                type="range"
                                min="0.40"
                                max="0.80"
                                step="0.02"
                                value={formScale}
                                onChange={e=>setFormScale(parseFloat(e.target.value))}
                                className="w-28 accent-emerald-500"
                              />
                            </div>
                            <div className="flex items-center gap-2 text-xs text-slate-200">
                              <span>Vista de fichas</span>
                              <select
                                value={fieldChipMode}
                                onChange={e=>setFieldChipMode(e.target.value)}
                                className="rounded-lg bg-slate-900/80 px-2 py-1 ring-1 ring-slate-700"
                              >
                                <option value="ring">Aros circulares</option>
                                <option value="card">Minicard rectangular</option>
                              </select>
                            </div>
                          </>
                        )}
                      </div>
                    </div>

                    {fieldOpen ? (
                      <>
                        <div className="grid gap-2 sm:grid-cols-2">
                          <label className="flex flex-col gap-1 text-xs text-slate-200">
                            <span className="font-semibold">ESTADIO</span>
                            <input
                              value={stadium}
                              onChange={e=>setStadium(e.target.value)}
                              placeholder="Nombre del estadio"
                              className="rounded-xl bg-slate-900/70 px-3 py-2 text-sm ring-1 ring-slate-700 placeholder:text-slate-500"
                            />
                          </label>
                          <label className="flex flex-col gap-1 text-xs text-slate-200">
                            <span className="font-semibold">FECHA Y HORA</span>
                            <input
                              type="datetime-local"
                              value={matchDateTime}
                              onChange={e=>setMatchDateTime(e.target.value)}
                              className="rounded-xl bg-slate-900/70 px-3 py-2 text-sm ring-1 ring-slate-700"
                            />
                          </label>
                        </div>

                        <FormationBoard
                          key={formKey}
                          teamA={teamA}
                          teamB={teamB}
                          map={map}
                          scale={formScale}
                          open={fieldOpen}
                          stadiumLabel={stadium}
                          matchInfo={matchLabel}
                          chipMode={fieldChipMode}
                        />
                        <div className="grid grid-cols-2 gap-2">
                          <button
                            onClick={resetFormation}
                            className="rounded-xl px-4 py-2 text-sm bg-slate-900 hover:bg-slate-800 ring-1 ring-slate-700"
                          >
                            üîÑ Reset formaci√≥n
                          </button>
                          <button
                            onClick={shuffleInsideTeams}
                            className="rounded-xl px-4 py-2 text-sm bg-slate-900 hover:bg-slate-800 ring-1 ring-slate-700"
                          >
                            ‚áÖ Mezclar posiciones
                          </button>
                        </div>
                      </>
                    ) : (
                      <div className="space-y-2">
                        <div className="rounded-xl bg-slate-900/60 p-2 ring-1 ring-slate-800">
                          <FormationBoard
                            key={formKey}
                            teamA={teamA}
                            teamB={teamB}
                            map={map}
                            scale={0.46}
                            open={false}
                            stadiumLabel=""
                            matchInfo=""
                            chipMode={fieldChipMode}
                          />
                        </div>
                        <div className="rounded-xl bg-slate-900/70 p-3 text-sm text-slate-200 ring-1 ring-slate-800">
                          Despleg√° la cancha para mover jugadores, completar estadio/fecha y acceder a descargar, copiar o compartir la formaci√≥n.
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </section>

              {/* === PLANTEL === */}
              <section className="tabs-page" ref={el=>pageRefs.current.plantel=el}>
                <div className="mx-auto max-w-5xl space-y-3">

                  {/* Barra de b√∫squeda / orden / acciones */}
                  <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <div className="flex-1 flex items-center gap-2">
                      <input
                        value={q}
                        onChange={e=>setQ(e.target.value)}
                        placeholder="Buscar por nombre, apodo o equipo‚Ä¶"
                        className="w-full rounded-xl bg-slate-900/80 px-3 py-2 text-sm ring-1 ring-slate-700 placeholder:text-slate-500"
                      />
                    </div>
                    <div className="flex items-center gap-2">
                      <select
                        value={sort}
                        onChange={e=>setSort(e.target.value)}
                        className="rounded-xl bg-slate-900/80 px-2 py-2 text-xs ring-1 ring-slate-700"
                      >
                        <option value="global-desc">Rating ‚Üì</option>
                        <option value="global-asc">Rating ‚Üë</option>
                        <option value="nombre">Nombre A‚ÄìZ</option>
                      </select>
                      {isAdmin && (
                        <button
                          onClick={()=>setForm({})}
                          className="rounded-xl bg-emerald-600 px-3 py-2 text-xs font-semibold text-white ring-1 ring-emerald-500 hover:bg-emerald-500"
                        >
                          ‚ûï A√±adir
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Info de convocados / limpiar */}
                  <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between text-xs text-slate-300">
                    <div>
                      Plantel: <b>{players.length}</b> jugadores ‚Äî Convocados:{' '}
                      <b>{convocadosCount}</b>/10
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={clearConvocados}
                        disabled={convocadosCount===0}
                        className={`rounded-xl px-3 py-1 ring-1 text-xs ${
                          convocadosCount===0
                            ? 'bg-slate-900/50 text-slate-500 ring-slate-800 cursor-not-allowed'
                            : 'bg-slate-900 text-slate-100 ring-slate-700 hover:bg-slate-800'
                        }`}
                      >
                        Limpiar convocados
                      </button>
                    </div>
                  </div>

                  {/* Lista de jugadores */}
                  <div className="space-y-2 pb-4">
                    {filtered.map(p=>(
                      <PlayerRow
                        key={p.id}
                        p={p}
                        selected={selected.has(p.id)}
                        onToggle={()=>toggle(p.id)}
                        onOpen={()=>setPlayerDetailId(p.id)}
                        onEdit={()=>isAdmin && setForm(p)}
                        pinA={pinA}
                        pinB={pinB}
                        setPinA={setPinA}
                        setPinB={setPinB}
                        disableAdd={reachedMax && !selected.has(p.id)}
                        isAdmin={isAdmin}
                      />
                    ))}
                    {filtered.length===0 && (
                      <div className="rounded-xl bg-slate-900/80 p-3 text-center text-sm text-slate-300 ring-1 ring-slate-800">
                        No hay jugadores que coincidan con la b√∫squeda.
                      </div>
                    )}
                  </div>
                </div>
              </section>

            </div>
          </div>

          {/* Bot√≥n instalar PWA */}
          {(
            <div className="install-pill">
              <button
                onClick={doInstall}
                className="rounded-full bg-emerald-600 px-4 py-2 text-xs font-semibold text-white shadow-lg ring-1 ring-emerald-400 hover:bg-emerald-500"
              >
                üì≤ Instalar F5C
              </button>
            </div>
          )}

          {/* Modales */}
          {settings && (
            <SettingsModal
              onClose={()=>setSettings(false)}
              kChem={kChem}
              setKChem={setKChem}
              formScale={formScale}
              setFormScale={setFormScale}
              partidoTwoCols={partidoTwoCols}
              setPartidoTwoCols={setPartidoTwoCols}
              teamColors={teamColors}
              setTeamColors={setTeamColors}
              onOpenGlossary={()=>{
                setSettings(false);
                setShowGlossary(true);
              }}
              isAdmin={isAdmin}
              setIsAdmin={setIsAdmin}
              onImportPlayers={importPlayersFile}
              onExportPlayers={exportPlayersFile}
              onReloadPlayers={fetchExternalPlayers}
              remoteStatus={remoteStatus}
            />
          )}

          {showGlossary && (
            <GlossaryModal onClose={()=>setShowGlossary(false)} />
          )}

          {form && (
            <PlayerFormModal
              key={form.id || 'new'}
              initial={form}
              onClose={()=>setForm(null)}
              onSave={upsertPlayer}
              onDelete={deletePlayer}
            />
          )}

          {currentDetail && (
            <PlayerDetails
              p={currentDetail}
              onClose={()=>setPlayerDetailId(null)}
            />
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
